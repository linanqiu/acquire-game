# RT-002: State Store

## Metadata
- **Epic**: Real-time Integration
- **Status**: `not-started`
- **Priority**: `critical`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: FF-001

## Context

Create a Zustand store to manage game state in the frontend. This store will be updated by WebSocket messages and consumed by UI components.

## Requirements

1. Store game state (board, players, chains, phase)
2. Store player-specific state (tiles, selected tile)
3. Store connection state
4. Actions to update state
5. Selectors for derived state

## Acceptance Criteria

- [ ] Game state stored: board, players, chains, currentPlayer, phase
- [ ] Player state stored: myTiles, selectedTile, myPlayer
- [ ] Connection state: status, room, token
- [ ] Actions: setGameState, setMyState, selectTile, etc.
- [ ] Selectors: isMyTurn, chainPrices, activeChains
- [ ] Zustand devtools enabled in development
- [ ] Unit tests for reducers

## Implementation Notes

### File to Create

**frontend/src/stores/gameStore.ts**:
```typescript
import { create } from 'zustand'
import { devtools } from 'zustand/middleware'
import type { ChainName, Coordinate, TileState } from '../types/game'

interface Player {
  id: string
  name: string
  cash: number
  stocks: { chain: ChainName; quantity: number }[]
  tileCount: number
  isHost: boolean
  isBot: boolean
}

interface Chain {
  name: ChainName
  size: number
  price: number
  stockAvailable: number
  active: boolean
}

interface RackTile {
  coordinate: Coordinate
  playability: 'playable' | 'merger' | 'temp_unplayable' | 'perm_unplayable'
}

type GamePhase =
  | 'lobby'
  | 'trading'
  | 'tile_placement'
  | 'founding'
  | 'merging'
  | 'buying'
  | 'game_over'

type ConnectionStatus = 'connecting' | 'connected' | 'disconnected' | 'error'

interface GameState {
  // Connection
  connectionStatus: ConnectionStatus
  room: string
  token: string

  // Game state
  phase: GamePhase
  board: TileState[][]
  players: Player[]
  chains: Chain[]
  currentPlayerId: string
  tilePool: number

  // Player-specific
  myPlayerId: string
  myTiles: RackTile[]
  selectedTile: Coordinate | null

  // Trade state
  activeTrade: {
    from: string
    to: string
    description: string
    status: string
  } | null

  // Merger state
  mergerState: {
    defunctChain: ChainName
    survivorChain: ChainName
    dispositionQueue: string[]
    currentDisposer: string
  } | null

  // Activity log
  activityLog: string[]

  // Final scores (game over)
  finalScores: {
    playerId: string
    name: string
    cash: number
    bonuses: number
    stockSales: number
    total: number
    rank: number
  }[]

  // Actions
  setConnectionStatus: (status: ConnectionStatus) => void
  setRoom: (room: string, token: string) => void
  setGameState: (state: Partial<GameState>) => void
  setMyState: (tiles: RackTile[], playerId: string) => void
  selectTile: (coord: Coordinate | null) => void
  addActivityLog: (entry: string) => void
  reset: () => void
}

const initialState = {
  connectionStatus: 'disconnected' as ConnectionStatus,
  room: '',
  token: '',
  phase: 'lobby' as GamePhase,
  board: Array(9).fill(null).map(() => Array(12).fill({ state: 'empty' })),
  players: [],
  chains: [],
  currentPlayerId: '',
  tilePool: 108,
  myPlayerId: '',
  myTiles: [],
  selectedTile: null,
  activeTrade: null,
  mergerState: null,
  activityLog: [],
  finalScores: [],
}

export const useGameStore = create<GameState>()(
  devtools(
    (set, get) => ({
      ...initialState,

      setConnectionStatus: (status) => set({ connectionStatus: status }),

      setRoom: (room, token) => set({ room, token }),

      setGameState: (state) => set(state),

      setMyState: (tiles, playerId) =>
        set({ myTiles: tiles, myPlayerId: playerId }),

      selectTile: (coord) => set({ selectedTile: coord }),

      addActivityLog: (entry) =>
        set((state) => ({
          activityLog: [...state.activityLog, entry].slice(-50),
        })),

      reset: () => set(initialState),
    }),
    { name: 'game-store' }
  )
)

// Selectors
export const selectIsMyTurn = (state: GameState) =>
  state.currentPlayerId === state.myPlayerId

export const selectMyPlayer = (state: GameState) =>
  state.players.find((p) => p.id === state.myPlayerId)

export const selectChainPrices = (state: GameState) =>
  Object.fromEntries(state.chains.map((c) => [c.name, c.price]))

export const selectActiveChains = (state: GameState) =>
  state.chains.filter((c) => c.active)
```

### Installation
```bash
npm install zustand
```

## Verification

```bash
npm run test -- --grep "gameStore"

# Visual: use React DevTools to inspect store
npm run dev
```

## Reference

- [Zustand Documentation](https://docs.pmnd.rs/zustand)
- [Backend game.py](../../../backend/game/game.py) - State structure
