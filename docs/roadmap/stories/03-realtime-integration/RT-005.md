# RT-005: Reconnection Logic

## Metadata
- **Epic**: Real-time Integration
- **Status**: `complete`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: RT-001, RT-003

## Context

Implement automatic reconnection when WebSocket connection is lost. Essential for mobile users where connections drop frequently.

## Requirements

1. Detect connection loss
2. Automatic reconnection attempts
3. Exponential backoff
4. Session recovery with token
5. State sync after reconnect

## Acceptance Criteria

- [ ] Detect WebSocket close/error
- [ ] Automatic retry with backoff (1s, 2s, 4s, max 30s)
- [ ] Maximum retry attempts (10)
- [ ] Use stored token for re-authentication
- [ ] Request full state sync after reconnect
- [ ] UI notified of connection status changes
- [ ] Manual reconnect option after max retries
- [ ] Unit tests for backoff logic

## Implementation Notes

### File to Create

**frontend/src/lib/connectionManager.ts**:
```typescript
import { WebSocketClient } from './websocket'
import { handleMessage } from './messageHandlers'
import { useGameStore } from '../stores/gameStore'

interface ConnectionConfig {
  maxRetries: number
  baseDelay: number
  maxDelay: number
}

const DEFAULT_CONFIG: ConnectionConfig = {
  maxRetries: 10,
  baseDelay: 1000,
  maxDelay: 30000,
}

export class ConnectionManager {
  private ws: WebSocketClient | null = null
  private config: ConnectionConfig
  private retryCount = 0
  private retryTimeout: NodeJS.Timeout | null = null

  constructor(config: Partial<ConnectionConfig> = {}) {
    this.config = { ...DEFAULT_CONFIG, ...config }
  }

  connect(room: string, token: string): void {
    const store = useGameStore.getState()
    store.setRoom(room, token)
    store.setConnectionStatus('connecting')

    const wsUrl = this.buildWsUrl(room, token)

    this.ws = new WebSocketClient({
      onMessage: handleMessage,
      onStatusChange: (status) => {
        store.setConnectionStatus(status)

        if (status === 'disconnected' || status === 'error') {
          this.scheduleReconnect()
        } else if (status === 'connected') {
          this.retryCount = 0
          this.requestStateSync()
        }
      },
      onError: (error) => {
        console.error('WebSocket error:', error)
      },
    })

    this.ws.connect(wsUrl)
  }

  private buildWsUrl(room: string, token: string): string {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
    const host = window.location.host
    return `${protocol}//${host}/ws/player/${room}/${token}`
  }

  private scheduleReconnect(): void {
    if (this.retryCount >= this.config.maxRetries) {
      console.log('Max retries reached')
      return
    }

    const delay = Math.min(
      this.config.baseDelay * Math.pow(2, this.retryCount),
      this.config.maxDelay
    )

    console.log(`Reconnecting in ${delay}ms (attempt ${this.retryCount + 1})`)

    this.retryTimeout = setTimeout(() => {
      this.retryCount++
      const { room, token } = useGameStore.getState()
      if (room && token) {
        this.connect(room, token)
      }
    }, delay)
  }

  private requestStateSync(): void {
    if (this.ws) {
      this.ws.send({ type: 'sync_state' })
    }
  }

  manualReconnect(): void {
    this.retryCount = 0
    const { room, token } = useGameStore.getState()
    if (room && token) {
      this.connect(room, token)
    }
  }

  disconnect(): void {
    if (this.retryTimeout) {
      clearTimeout(this.retryTimeout)
    }
    if (this.ws) {
      this.ws.disconnect()
    }
  }

  getRetryCount(): number {
    return this.retryCount
  }

  getMaxRetries(): number {
    return this.config.maxRetries
  }
}

// Singleton instance
export const connectionManager = new ConnectionManager()
```

### Usage in App
```typescript
// In PlayerPage.tsx
useEffect(() => {
  const token = searchParams.get('token') || generateToken()
  connectionManager.connect(room, token)

  return () => {
    connectionManager.disconnect()
  }
}, [room])
```

## Actual Implementation

Reconnection logic is built into the WebSocket hook:

**File**: `frontend/src/hooks/useWebSocket.ts`

Key implementation:
- Exponential backoff: `Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 30000)`
- Max 5 retry attempts
- `intentionalCloseRef` to distinguish user-initiated disconnects from errors
- Error toast only after exhausting all retries (not on transient failures)

## Verification

```bash
npm run test -- --grep "ConnectionManager"

# Manual test:
# 1. Connect to game
# 2. Kill backend
# 3. Verify retry attempts in console
# 4. Restart backend
# 5. Verify reconnection and state sync
```

## Reference

- [Exponential Backoff](https://en.wikipedia.org/wiki/Exponential_backoff)
