# RT-006: Error Handling

## Metadata
- **Epic**: Real-time Integration
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `S` (30-60 minutes)
- **Dependencies**: RT-003, FF-009

## Context

Implement comprehensive error handling for WebSocket communication. Display errors to users via the toast system and provide recovery options.

## Requirements

1. Catch and categorize errors
2. Display user-friendly error messages
3. Log errors for debugging
4. Provide recovery actions where appropriate

## Acceptance Criteria

- [ ] Server errors display via toast
- [ ] Connection errors show status
- [ ] Invalid action errors explained
- [ ] Timeout errors handled
- [ ] Errors logged to console with context
- [ ] Critical errors offer recovery (rejoin, refresh)
- [ ] Non-blocking errors auto-dismiss
- [ ] Unit tests for error categorization

## Implementation Notes

### File to Create

**frontend/src/lib/errorHandler.ts**:
```typescript
import { useToast } from '../components/ui/ToastProvider'

export type ErrorCategory =
  | 'connection'
  | 'validation'
  | 'game_rule'
  | 'server'
  | 'timeout'
  | 'unknown'

interface GameError {
  category: ErrorCategory
  message: string
  recoverable: boolean
  action?: () => void
  actionLabel?: string
}

const ERROR_MESSAGES: Record<string, string> = {
  'invalid_tile': 'You cannot place a tile there',
  'not_your_turn': 'It\'s not your turn',
  'insufficient_funds': 'You don\'t have enough cash',
  'stock_unavailable': 'No stock available for that chain',
  'room_not_found': 'Game room not found',
  'name_taken': 'That name is already taken',
  'game_full': 'The game is full',
  'game_started': 'The game has already started',
}

export function categorizeError(error: unknown): GameError {
  if (typeof error === 'string') {
    const message = ERROR_MESSAGES[error] || error
    return {
      category: 'game_rule',
      message,
      recoverable: true,
    }
  }

  if (error instanceof Error) {
    if (error.message.includes('WebSocket')) {
      return {
        category: 'connection',
        message: 'Connection lost. Attempting to reconnect...',
        recoverable: true,
      }
    }

    if (error.message.includes('timeout')) {
      return {
        category: 'timeout',
        message: 'Request timed out. Please try again.',
        recoverable: true,
      }
    }
  }

  return {
    category: 'unknown',
    message: 'An unexpected error occurred',
    recoverable: false,
  }
}

export function handleServerError(errorMessage: string): void {
  const error = categorizeError(errorMessage)

  // Log for debugging
  console.error('[Game Error]', {
    category: error.category,
    message: error.message,
    raw: errorMessage,
  })

  // Get toast function (needs to be called within component context)
  // This will be integrated via hook
}

// Hook for components
export function useErrorHandler() {
  const { toast } = useToast()

  return {
    handleError: (error: unknown) => {
      const gameError = categorizeError(error)

      const toastType =
        gameError.category === 'game_rule' ? 'warning' :
        gameError.category === 'connection' ? 'error' :
        'error'

      toast(gameError.message, toastType)

      // Log
      console.error('[Game Error]', gameError)
    },

    handleServerMessage: (message: { type: 'error'; message: string }) => {
      const gameError = categorizeError(message.message)
      toast(gameError.message, 'error')
      console.error('[Server Error]', message.message)
    },
  }
}
```

### Integration with Message Handlers
```typescript
// In messageHandlers.ts
case 'error':
  const { handleServerMessage } = useErrorHandler()
  handleServerMessage(message)
  break
```

### Error Categories

| Category | Example | Toast Type | Recovery |
|----------|---------|------------|----------|
| `connection` | WebSocket closed | error | Auto-reconnect |
| `validation` | Invalid input | warning | Fix input |
| `game_rule` | Not your turn | warning | Wait |
| `server` | 500 error | error | Retry |
| `timeout` | No response | warning | Retry |

## Verification

```bash
npm run test -- --grep "errorHandler"

# Manual:
# - Try invalid action, see toast
# - Disconnect, see connection error
# - Send malformed request, see server error
```

## Reference

- [Toast System](../../../docs/roadmap/stories/01-frontend-foundation/FF-009.md)
