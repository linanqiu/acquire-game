# RT-004: Optimistic Updates

## Metadata
- **Epic**: Real-time Integration
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: RT-002, RT-003

## Context

Implement optimistic updates so the UI feels instant. Update local state immediately when user takes action, then reconcile with server response.

## Requirements

1. Update UI immediately on user action
2. Reconcile when server confirms
3. Rollback on error
4. Track pending actions

## Acceptance Criteria

- [ ] Tile selection updates immediately
- [ ] Stock purchase shows cart update instantly
- [ ] Server confirmation updates state
- [ ] Server error triggers rollback
- [ ] Pending state indicator on actions
- [ ] No flicker when server confirms
- [ ] Unit tests for reconciliation

## Implementation Notes

### File to Create

**frontend/src/stores/optimisticStore.ts**:
```typescript
import { create } from 'zustand'
import { useGameStore } from './gameStore'

interface PendingAction {
  id: string
  type: string
  payload: unknown
  timestamp: number
  previousState: unknown
}

interface OptimisticState {
  pendingActions: PendingAction[]
  addPending: (action: Omit<PendingAction, 'id' | 'timestamp'>) => string
  confirmAction: (id: string) => void
  rollbackAction: (id: string) => void
}

export const useOptimisticStore = create<OptimisticState>((set, get) => ({
  pendingActions: [],

  addPending: (action) => {
    const id = Math.random().toString(36).slice(2)
    set((state) => ({
      pendingActions: [
        ...state.pendingActions,
        { ...action, id, timestamp: Date.now() },
      ],
    }))
    return id
  },

  confirmAction: (id) => {
    set((state) => ({
      pendingActions: state.pendingActions.filter((a) => a.id !== id),
    }))
  },

  rollbackAction: (id) => {
    const action = get().pendingActions.find((a) => a.id === id)
    if (action && action.previousState) {
      useGameStore.getState().setGameState(action.previousState as any)
    }
    set((state) => ({
      pendingActions: state.pendingActions.filter((a) => a.id !== id),
    }))
  },
}))
```

**frontend/src/hooks/useOptimisticAction.ts**:
```typescript
import { useCallback } from 'react'
import { useOptimisticStore } from '../stores/optimisticStore'
import { useGameStore } from '../stores/gameStore'
import { gameActions } from '../lib/gameActions'

export function useOptimisticTilePlay() {
  const { selectTile } = useGameStore()
  const { addPending } = useOptimisticStore()

  return useCallback(
    (coordinate: string) => {
      const previousState = useGameStore.getState().selectedTile

      // Optimistic update
      selectTile(coordinate as any)

      // Track pending
      const actionId = addPending({
        type: 'play_tile',
        payload: { coordinate },
        previousState: { selectedTile: previousState },
      })

      // Send to server
      gameActions.playTile(coordinate)

      return actionId
    },
    [selectTile, addPending]
  )
}

export function useOptimisticStockPurchase() {
  const { addPending, confirmAction, rollbackAction } = useOptimisticStore()

  return useCallback(
    async (purchases: { chain: string; quantity: number }[]) => {
      const previousState = useGameStore.getState()

      // Optimistic: deduct cash immediately
      const totalCost = purchases.reduce((sum, p) => {
        const chain = previousState.chains.find((c) => c.name === p.chain)
        return sum + (chain?.price || 0) * p.quantity
      }, 0)

      const myPlayer = previousState.players.find(
        (p) => p.id === previousState.myPlayerId
      )
      if (myPlayer) {
        useGameStore.getState().setGameState({
          players: previousState.players.map((p) =>
            p.id === previousState.myPlayerId
              ? { ...p, cash: p.cash - totalCost }
              : p
          ),
        })
      }

      const actionId = addPending({
        type: 'buy_stocks',
        payload: purchases,
        previousState: { players: previousState.players },
      })

      gameActions.buyStocks(purchases as any)

      return actionId
    },
    [addPending]
  )
}
```

## Verification

```bash
npm run test -- --grep "optimistic"

# Manual: verify instant UI feedback
# - Click tile, see immediate selection
# - Buy stock, see cash deduct immediately
```

## Reference

- [Optimistic UI Patterns](https://www.smashingmagazine.com/2016/11/true-lies-of-optimistic-user-interfaces/)
