# FF-008: Modal Component

## Metadata
- **Epic**: Frontend Foundation
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: FF-005, FF-006

## Context

Create a Modal component for focused interactions like chain selection, trade proposals, and confirmations. Must handle accessibility concerns including focus trapping and keyboard navigation.

## Requirements

1. Centered overlay with backdrop
2. Title and close button
3. Configurable confirm/cancel actions
4. Escape key closes modal
5. Click outside closes modal (configurable)
6. Focus trapped within modal
7. Body scroll locked when open
8. Smooth enter/exit animations

## Acceptance Criteria

- [ ] Modal renders centered over content
- [ ] Backdrop darkens background
- [ ] Title displays in header
- [ ] Close button (×) closes modal
- [ ] Escape key closes modal
- [ ] Click on backdrop closes modal
- [ ] Confirm/Cancel buttons work
- [ ] Focus moves to modal on open
- [ ] Focus returns to trigger on close
- [ ] Tab cycles only through modal elements
- [ ] Body scroll is locked
- [ ] Animation on open/close
- [ ] Unit tests for behavior

## Implementation Notes

### File to Create
**frontend/src/components/ui/Modal.tsx**:

```tsx
import { useEffect, useRef, useCallback } from 'react'
import { createPortal } from 'react-dom'
import { Button } from './Button'
import styles from './Modal.module.css'

interface ModalProps {
  open: boolean
  onClose: () => void
  title: string
  confirmLabel?: string
  cancelLabel?: string
  onConfirm?: () => void
  dismissible?: boolean
  children: React.ReactNode
}

export function Modal({
  open,
  onClose,
  title,
  confirmLabel,
  cancelLabel = 'Cancel',
  onConfirm,
  dismissible = true,
  children,
}: ModalProps) {
  const modalRef = useRef<HTMLDivElement>(null)
  const previousActiveElement = useRef<Element | null>(null)

  // Focus trap
  useEffect(() => {
    if (open) {
      previousActiveElement.current = document.activeElement
      modalRef.current?.focus()
      document.body.style.overflow = 'hidden'
    } else {
      document.body.style.overflow = ''
      if (previousActiveElement.current instanceof HTMLElement) {
        previousActiveElement.current.focus()
      }
    }
    return () => {
      document.body.style.overflow = ''
    }
  }, [open])

  // Escape key handler
  const handleKeyDown = useCallback(
    (e: React.KeyboardEvent) => {
      if (e.key === 'Escape' && dismissible) {
        onClose()
      }
    },
    [onClose, dismissible]
  )

  // Backdrop click handler
  const handleBackdropClick = useCallback(
    (e: React.MouseEvent) => {
      if (e.target === e.currentTarget && dismissible) {
        onClose()
      }
    },
    [onClose, dismissible]
  )

  if (!open) return null

  return createPortal(
    <div
      className={styles.backdrop}
      onClick={handleBackdropClick}
      onKeyDown={handleKeyDown}
    >
      <div
        ref={modalRef}
        className={styles.modal}
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
        tabIndex={-1}
      >
        <div className={styles.header}>
          <h2 id="modal-title">{title}</h2>
          {dismissible && (
            <button className={styles.closeButton} onClick={onClose}>
              ×
            </button>
          )}
        </div>
        <div className={styles.body}>{children}</div>
        {(onConfirm || cancelLabel) && (
          <div className={styles.footer}>
            {cancelLabel && (
              <Button variant="secondary" onClick={onClose}>
                {cancelLabel}
              </Button>
            )}
            {onConfirm && confirmLabel && (
              <Button variant="primary" onClick={onConfirm}>
                {confirmLabel}
              </Button>
            )}
          </div>
        )}
      </div>
    </div>,
    document.body
  )
}
```

**frontend/src/components/ui/Modal.module.css**:
```css
.backdrop {
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn var(--duration-fast) var(--ease-out);
}

.modal {
  background-color: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  max-width: 400px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideIn var(--duration-normal) var(--ease-out);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-4);
  border-bottom: 1px solid var(--border);
}

.header h2 {
  margin: 0;
  font-size: var(--text-lg);
}

.closeButton {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: var(--text-xl);
  cursor: pointer;
  padding: 0;
  line-height: 1;
}

.closeButton:hover {
  color: var(--text-primary);
}

.body {
  padding: var(--space-4);
}

.footer {
  display: flex;
  justify-content: flex-end;
  gap: var(--space-2);
  padding: var(--space-4);
  border-top: 1px solid var(--border);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

## Testing Requirements

Create `src/components/ui/Modal.test.tsx`:

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'
import { Modal } from './Modal'

describe('Modal', () => {
  const defaultProps = {
    open: true,
    onClose: vi.fn(),
    title: 'Test Modal',
    children: <p>Modal content</p>,
  }

  beforeEach(() => {
    vi.clearAllMocks()
  })

  afterEach(() => {
    document.body.style.overflow = ''
  })

  // Rendering tests
  it('renders when open is true', () => {
    render(<Modal {...defaultProps} />)
    expect(screen.getByRole('dialog')).toBeInTheDocument()
  })

  it('does not render when open is false', () => {
    render(<Modal {...defaultProps} open={false} />)
    expect(screen.queryByRole('dialog')).not.toBeInTheDocument()
  })

  it('renders title', () => {
    render(<Modal {...defaultProps} />)
    expect(screen.getByText('Test Modal')).toBeInTheDocument()
  })

  it('renders children', () => {
    render(<Modal {...defaultProps} />)
    expect(screen.getByText('Modal content')).toBeInTheDocument()
  })

  // Close behavior tests
  it('calls onClose when close button clicked', () => {
    render(<Modal {...defaultProps} />)
    fireEvent.click(screen.getByText('×'))
    expect(defaultProps.onClose).toHaveBeenCalledTimes(1)
  })

  it('calls onClose when Escape pressed', () => {
    render(<Modal {...defaultProps} />)
    fireEvent.keyDown(screen.getByRole('dialog'), { key: 'Escape' })
    expect(defaultProps.onClose).toHaveBeenCalledTimes(1)
  })

  it('calls onClose when backdrop clicked', () => {
    render(<Modal {...defaultProps} />)
    // Click the backdrop (parent of dialog)
    const backdrop = screen.getByRole('dialog').parentElement!
    fireEvent.click(backdrop)
    expect(defaultProps.onClose).toHaveBeenCalledTimes(1)
  })

  it('does not close on Escape when dismissible is false', () => {
    render(<Modal {...defaultProps} dismissible={false} />)
    fireEvent.keyDown(screen.getByRole('dialog'), { key: 'Escape' })
    expect(defaultProps.onClose).not.toHaveBeenCalled()
  })

  // Confirm/Cancel tests
  it('renders confirm button when onConfirm and confirmLabel provided', () => {
    const onConfirm = vi.fn()
    render(<Modal {...defaultProps} onConfirm={onConfirm} confirmLabel="OK" />)
    expect(screen.getByText('OK')).toBeInTheDocument()
  })

  it('calls onConfirm when confirm button clicked', () => {
    const onConfirm = vi.fn()
    render(<Modal {...defaultProps} onConfirm={onConfirm} confirmLabel="OK" />)
    fireEvent.click(screen.getByText('OK'))
    expect(onConfirm).toHaveBeenCalledTimes(1)
  })

  it('renders cancel button with custom label', () => {
    render(<Modal {...defaultProps} cancelLabel="Dismiss" />)
    expect(screen.getByText('Dismiss')).toBeInTheDocument()
  })

  // Body scroll lock
  it('locks body scroll when open', () => {
    render(<Modal {...defaultProps} />)
    expect(document.body.style.overflow).toBe('hidden')
  })

  it('restores body scroll when closed', () => {
    const { rerender } = render(<Modal {...defaultProps} />)
    rerender(<Modal {...defaultProps} open={false} />)
    expect(document.body.style.overflow).toBe('')
  })

  // ARIA tests
  it('has aria-modal attribute', () => {
    render(<Modal {...defaultProps} />)
    expect(screen.getByRole('dialog')).toHaveAttribute('aria-modal', 'true')
  })

  it('has aria-labelledby pointing to title', () => {
    render(<Modal {...defaultProps} />)
    expect(screen.getByRole('dialog')).toHaveAttribute('aria-labelledby', 'modal-title')
  })
})
```

**Minimum test coverage:**
- Render/not render based on open prop
- Title and children rendering
- All close mechanisms (button, Escape, backdrop)
- dismissible prop behavior
- Confirm/Cancel buttons
- Body scroll lock
- ARIA attributes

## Verification

```bash
npm run test -- --grep "Modal"
npm run e2e -- --grep "modal"

# Manual verification:
# - Open modal, verify focus trap
# - Press Escape, verify close
# - Click backdrop, verify close
# - Tab through elements, verify cycle
```

## Reference

- [Components Spec - Modal](../../../ui/components.md#modal)
- [Design System - Animation](../../../ui/design-system.md#animation-guidelines)
