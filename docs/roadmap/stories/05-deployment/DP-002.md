# DP-002: Environment Config

## Metadata
- **Epic**: Deployment
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `S` (30-60 minutes)
- **Dependencies**: DP-001

## Context

Configure environment variables for production deployment. Separate development and production configurations for security and flexibility.

## Requirements

1. Define required environment variables
2. Configure Railway environment variables
3. Update application to use env vars
4. Document all configuration options

## Acceptance Criteria

- [ ] All secrets stored as env vars (not in code)
- [ ] Railway variables configured
- [ ] Application reads from environment
- [ ] Local development uses .env file
- [ ] .env.example documents all variables
- [ ] Production uses secure defaults

## Implementation Notes

### Environment Variables

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `PORT` | Server port | 8000 | Yes (Railway sets) |
| `ENVIRONMENT` | dev/staging/prod | dev | No |
| `LOG_LEVEL` | Logging verbosity | INFO | No |
| `ALLOWED_ORIGINS` | CORS origins | * | No |
| `MAX_PLAYERS_PER_GAME` | Game limit | 6 | No |
| `GAME_TIMEOUT_MINUTES` | Inactive game cleanup | 60 | No |

### Files to Create/Modify

**backend/.env.example**:
```env
# Server
PORT=8000
ENVIRONMENT=dev
LOG_LEVEL=DEBUG

# CORS (comma-separated for multiple origins)
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# Game Settings
MAX_PLAYERS_PER_GAME=6
GAME_TIMEOUT_MINUTES=60
```

**backend/config.py** (create or update):
```python
import os
from functools import lru_cache
from pydantic_settings import BaseSettings


class Settings(BaseSettings):
    """Application settings from environment."""

    port: int = 8000
    environment: str = "dev"
    log_level: str = "INFO"
    allowed_origins: str = "*"
    max_players_per_game: int = 6
    game_timeout_minutes: int = 60

    @property
    def cors_origins(self) -> list[str]:
        if self.allowed_origins == "*":
            return ["*"]
        return [o.strip() for o in self.allowed_origins.split(",")]

    @property
    def is_production(self) -> bool:
        return self.environment == "prod"

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"


@lru_cache
def get_settings() -> Settings:
    return Settings()
```

**Update main.py**:
```python
from config import get_settings

settings = get_settings()

app = FastAPI(
    title="Acquire Game Server",
    debug=not settings.is_production,
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### Railway Setup

1. Go to Railway dashboard → Your project → Variables
2. Add each production variable
3. Railway automatically restarts on variable changes

## Verification

```bash
# Local development
cd backend
cp .env.example .env
# Edit .env as needed
python -c "from config import get_settings; print(get_settings().model_dump())"

# Production (after deploy)
curl https://your-app.railway.app/health
# Should return environment info or confirm running
```

## Reference

- [Pydantic Settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)
- [Railway Environment Variables](https://docs.railway.app/develop/variables)
