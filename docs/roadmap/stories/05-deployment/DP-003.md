# DP-003: WebSocket Proxy Configuration

## Metadata
- **Epic**: Deployment
- **Status**: `not-started`
- **Priority**: `critical`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: DP-001, RT-001

## Context

Configure WebSocket support for production deployment. Railway supports WebSockets but may require specific configuration for persistent connections.

## Requirements

1. Ensure WebSocket connections work through Railway
2. Handle connection upgrades properly
3. Configure timeouts for long-lived connections
4. Test reconnection scenarios

## Acceptance Criteria

- [ ] WebSocket connections establish successfully
- [ ] Connections persist for full game duration
- [ ] Reconnection works after network interruption
- [ ] No premature connection drops
- [ ] Works with frontend deployed separately
- [ ] CORS configured for WebSocket origins

## Implementation Notes

### Railway WebSocket Support

Railway supports WebSockets natively. Key considerations:

1. **Connection Timeout**: Railway has a 5-minute idle timeout by default
2. **Keep-Alive**: Implement ping/pong to prevent idle disconnection
3. **Sticky Sessions**: Not needed for single-instance deployments

### Backend Updates

**Update WebSocket handler with ping/pong**:

```python
import asyncio
from fastapi import WebSocket, WebSocketDisconnect

PING_INTERVAL = 30  # seconds
PING_TIMEOUT = 10   # seconds


async def websocket_handler(websocket: WebSocket, game_id: str, player_id: str):
    await websocket.accept()

    async def ping_task():
        """Send periodic pings to keep connection alive."""
        while True:
            try:
                await asyncio.sleep(PING_INTERVAL)
                await websocket.send_json({"type": "ping"})
            except Exception:
                break

    ping = asyncio.create_task(ping_task())

    try:
        while True:
            data = await websocket.receive_json()

            # Handle pong responses
            if data.get("type") == "pong":
                continue

            # Handle game messages
            await handle_message(websocket, game_id, player_id, data)

    except WebSocketDisconnect:
        pass
    finally:
        ping.cancel()
        await cleanup_connection(game_id, player_id)
```

### Frontend WebSocket Configuration

When building the frontend (RT-001), ensure:

```typescript
// websocket.ts
const WS_URL = import.meta.env.VITE_WS_URL || 'ws://localhost:8000';

function createWebSocket(gameId: string, playerId: string) {
  const ws = new WebSocket(`${WS_URL}/ws/${gameId}/${playerId}`);

  // Respond to server pings
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'ping') {
      ws.send(JSON.stringify({ type: 'pong' }));
      return;
    }
    // Handle other messages
  };

  return ws;
}
```

### CORS for WebSocket

WebSocket upgrade requests are subject to CORS. Update CORS config:

```python
# main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
    expose_headers=["*"],
)
```

### Environment Variables

Add to `.env.example`:
```env
# WebSocket
WS_PING_INTERVAL=30
WS_PING_TIMEOUT=10
```

## Verification

```bash
# Test WebSocket connection locally
cd backend
uvicorn main:app --reload

# In another terminal, use websocat or similar
websocat ws://localhost:8000/ws/test-game/test-player

# Send a message
{"type": "ping"}
# Should receive pong

# Production test
websocat wss://your-app.railway.app/ws/test-game/test-player
```

### Load Test (Optional)

```python
# test_ws_load.py
import asyncio
import websockets

async def test_connection(game_id: str, player_id: str):
    uri = f"wss://your-app.railway.app/ws/{game_id}/{player_id}"
    async with websockets.connect(uri) as ws:
        # Keep connection open for 5 minutes
        for _ in range(10):
            await ws.send('{"type": "pong"}')
            await asyncio.sleep(30)
        print(f"Connection {player_id} survived 5 minutes")

async def main():
    # Test 10 concurrent connections
    tasks = [test_connection("load-test", f"player-{i}") for i in range(10)]
    await asyncio.gather(*tasks)

asyncio.run(main())
```

## Reference

- [Railway WebSocket Support](https://docs.railway.app/reference/websockets)
- [FastAPI WebSockets](https://fastapi.tiangolo.com/advanced/websockets/)
