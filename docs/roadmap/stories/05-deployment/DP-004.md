# DP-004: Health Monitoring

## Metadata
- **Epic**: Deployment
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `S` (30-60 minutes)
- **Dependencies**: DP-001

## Context

Implement health check endpoints for monitoring service status. Railway uses health checks for deployment verification and automatic restarts.

## Requirements

1. Basic health endpoint for Railway
2. Detailed health endpoint for debugging
3. Readiness vs liveness checks
4. Monitor active games and connections

## Acceptance Criteria

- [ ] `/health` returns 200 when service healthy
- [ ] `/health/detailed` returns system metrics
- [ ] Railway health checks pass
- [ ] Automatic restart on health failure
- [ ] Response time <100ms
- [ ] No sensitive data in health responses

## Implementation Notes

### Health Endpoints

**backend/health.py** (create):
```python
import time
import psutil
from datetime import datetime
from fastapi import APIRouter, Response
from pydantic import BaseModel

router = APIRouter(tags=["health"])

START_TIME = time.time()


class HealthResponse(BaseModel):
    status: str
    timestamp: str


class DetailedHealthResponse(BaseModel):
    status: str
    timestamp: str
    uptime_seconds: float
    version: str
    active_games: int
    active_connections: int
    memory_mb: float
    cpu_percent: float


@router.get("/health", response_model=HealthResponse)
async def health_check():
    """Basic health check for load balancers and Railway."""
    return HealthResponse(
        status="ok",
        timestamp=datetime.utcnow().isoformat(),
    )


@router.get("/health/detailed", response_model=DetailedHealthResponse)
async def detailed_health_check():
    """Detailed health check with system metrics."""
    from game_manager import game_manager  # Import your game manager

    process = psutil.Process()

    return DetailedHealthResponse(
        status="ok",
        timestamp=datetime.utcnow().isoformat(),
        uptime_seconds=time.time() - START_TIME,
        version="1.0.0",  # Read from package or env
        active_games=len(game_manager.games),
        active_connections=game_manager.connection_count,
        memory_mb=process.memory_info().rss / 1024 / 1024,
        cpu_percent=process.cpu_percent(),
    )


@router.get("/health/ready")
async def readiness_check(response: Response):
    """
    Readiness check - is the service ready to accept traffic?

    Returns 503 if not ready (e.g., during startup or maintenance).
    """
    # Add any initialization checks here
    is_ready = True  # Check database connections, etc.

    if not is_ready:
        response.status_code = 503
        return {"status": "not_ready", "reason": "Service initializing"}

    return {"status": "ready"}


@router.get("/health/live")
async def liveness_check():
    """
    Liveness check - is the service alive?

    If this fails, the service should be restarted.
    """
    return {"status": "alive"}
```

### Register Router

**Update main.py**:
```python
from health import router as health_router

app.include_router(health_router)
```

### Railway Configuration

**railway.toml**:
```toml
[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 100
```

### Dependencies

Add to `requirements.txt`:
```
psutil>=5.9.0
```

## Verification

```bash
# Local testing
cd backend
pip install psutil
uvicorn main:app --reload

# Test endpoints
curl http://localhost:8000/health
# {"status":"ok","timestamp":"2024-01-15T10:30:00"}

curl http://localhost:8000/health/detailed
# {"status":"ok","uptime_seconds":123.45,...}

curl http://localhost:8000/health/ready
# {"status":"ready"}

curl http://localhost:8000/health/live
# {"status":"alive"}

# Production
curl https://your-app.railway.app/health
curl https://your-app.railway.app/health/detailed
```

## Reference

- [Railway Health Checks](https://docs.railway.app/deploy/healthchecks)
- [Kubernetes Health Check Patterns](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/)
