# GU-015: Reconnection UI

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: FF-008, FF-009

## Context

Handle connection loss gracefully with reconnection flow. Shows status during reconnection and provides recovery options.

## Requirements

1. Detect connection loss
2. Show reconnecting spinner
3. Auto-reconnect attempt
4. Success: show "Welcome back" with current state
5. Failure: option to rejoin manually
6. Timeout handling

## Acceptance Criteria

- [ ] Connection loss triggers reconnecting UI
- [ ] Spinner animation during reconnection
- [ ] Auto-reconnect within 5 seconds (3 attempts)
- [ ] Success: toast "Welcome back", sync state
- [ ] Failure after timeout: show manual rejoin option
- [ ] Manual rejoin button works
- [ ] Game state synced correctly after reconnect
- [ ] Unit tests for reconnection logic

## Implementation Notes

### File to Create

**frontend/src/components/game/ReconnectionOverlay.tsx**:
```tsx
import { useEffect, useState } from 'react'
import { Modal } from '../ui/Modal'
import { Button } from '../ui/Button'
import { Spinner } from '../ui/Spinner'
import { useGameStore } from '../../stores/gameStore'
import { useToast } from '../ui/ToastProvider'
import styles from './ReconnectionOverlay.module.css'

export function ReconnectionOverlay() {
  const { connectionStatus, reconnect, currentPlayer, currentPhase } = useGameStore()
  const { toast } = useToast()
  const [attempts, setAttempts] = useState(0)
  const [showManual, setShowManual] = useState(false)

  useEffect(() => {
    if (connectionStatus === 'disconnected') {
      setAttempts(0)
      setShowManual(false)
      attemptReconnect()
    }
  }, [connectionStatus])

  const attemptReconnect = async () => {
    if (attempts >= 3) {
      setShowManual(true)
      return
    }

    setAttempts((a) => a + 1)
    const success = await reconnect()

    if (success) {
      toast('Welcome back!', 'success')
    } else {
      // Retry after 2 seconds
      setTimeout(attemptReconnect, 2000)
    }
  }

  const handleManualRejoin = () => {
    reconnect()
  }

  if (connectionStatus === 'connected') {
    return null
  }

  return (
    <Modal
      open={connectionStatus !== 'connected'}
      onClose={() => {}}
      title={showManual ? 'CONNECTION LOST' : 'RECONNECTING...'}
      dismissible={false}
    >
      {!showManual ? (
        <div className={styles.reconnecting}>
          <Spinner size="lg" />
          <p>Re-establishing connection to room...</p>
          <p className={styles.attempts}>Attempt {attempts}/3</p>
        </div>
      ) : (
        <div className={styles.manual}>
          <p>Unable to reconnect automatically.</p>
          <p>Your game may still be in progress.</p>

          <Button onClick={handleManualRejoin}>
            REJOIN AS {currentPlayer?.name || 'PLAYER'}
          </Button>

          <Button variant="secondary" onClick={() => window.location.href = '/'}>
            BACK TO LOBBY
          </Button>
        </div>
      )}
    </Modal>
  )
}
```

**frontend/src/components/game/ReconnectedToast.tsx**:
```tsx
import { Card } from '../ui/Card'
import { Button } from '../ui/Button'
import styles from './ReconnectionOverlay.module.css'

interface ReconnectedToastProps {
  playerName: string
  currentTurn: string
  phase: string
  cash: number
  stocks: number
  tiles: number
  onContinue: () => void
}

export function ReconnectedToast({
  playerName,
  currentTurn,
  phase,
  cash,
  stocks,
  tiles,
  onContinue,
}: ReconnectedToastProps) {
  return (
    <Card title="âœ“ RECONNECTED">
      <p>Welcome back, {playerName}!</p>

      <div className={styles.state}>
        <h4>CURRENT GAME STATE:</h4>
        <p>Turn: {currentTurn} ({phase})</p>
        <p>Your cash: ${cash.toLocaleString()}</p>
        <p>Your stocks: {stocks} total</p>
        <p>Your tiles: {tiles} in hand</p>
      </div>

      <Button fullWidth onClick={onContinue}>
        CONTINUE PLAYING
      </Button>
    </Card>
  )
}
```

**frontend/src/components/game/ReconnectionOverlay.module.css**:
```css
.reconnecting {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-6);
}

.attempts {
  color: var(--text-secondary);
  font-size: var(--text-sm);
}

.manual {
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
  text-align: center;
}

.state {
  background-color: var(--bg-tertiary);
  padding: var(--space-3);
  border-radius: var(--radius-sm);
  margin: var(--space-3) 0;
}

.state h4 {
  margin-bottom: var(--space-2);
  color: var(--text-secondary);
}

.state p {
  margin: var(--space-1) 0;
}
```

## Verification

```bash
npm run test -- --grep "Reconnect"
npm run e2e -- --grep "reconnection"

# Manual: disconnect network, verify UI
# - Kill backend, see reconnecting UI
# - Restart backend, verify auto-reconnect
```

## Reference

- [Storyboard - Reconnection](../../../ui/storyboard.md#screen-5-reconnection)
