# GU-022: Trading E2E Tests

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: GU-018

## Context

Test the player-to-player trading flow. Trading is an optional feature that allows players to exchange stocks and money during the game.

## Requirements

Implement all E2E-6.x scenarios from `docs/tests/frontend-e2e/trading-flow.md`:

1. **E2E-6.1**: Propose and accept trade
2. **E2E-6.2**: Reject trade offer
3. **E2E-6.3**: Cancel trade offer
4. **E2E-6.4**: Trade validation - insufficient stocks
5. **E2E-6.5**: Trade validation - insufficient funds
6. **E2E-6.6**: Multiple pending trades
7. **E2E-6.7**: Trade during bot turn

## Acceptance Criteria

- [ ] All 7 E2E-6.x scenarios pass
- [ ] Multi-player trading works correctly
- [ ] Validation prevents invalid trades
- [ ] Real-time trade notifications work
- [ ] Tests complete in < 2 minutes total
- [ ] No flaky tests

## Implementation Notes

### Multi-Player Setup

Trading requires 2+ human players. Use multiple browser contexts:

```typescript
async function setupTwoHumanPlayers(browser: Browser, request: APIRequestContext) {
  // Player 1 creates room
  const player1Context = await browser.newContext()
  const player1Page = await player1Context.newPage()
  const { room_code, player_id: player1Id, session_token: token1 } =
    await createRoom(request, 'Player1')

  // Player 2 joins
  const player2Context = await browser.newContext()
  const player2Page = await player2Context.newPage()
  const { player_id: player2Id, session_token: token2 } =
    await joinRoom(request, room_code, 'Player2')

  // Add bot to reach 3 players minimum
  await addBot(request, room_code)

  // Start game
  await startGame(request, room_code)

  return {
    roomCode: room_code,
    player1: { page: player1Page, context: player1Context, id: player1Id, token: token1 },
    player2: { page: player2Page, context: player2Context, id: player2Id, token: token2 },
  }
}
```

### Required data-testid Selectors

**Trade Initiation:**
- `open-trade-button` - Button to open trade dialog
- `trade-dialog` - Trade proposal dialog
- `trade-recipient-select` - Select recipient player
- `trade-offer-stocks-{chain}` - Stocks to offer input
- `trade-offer-money` - Money to offer input
- `trade-request-stocks-{chain}` - Stocks to request input
- `trade-request-money` - Money to request input
- `submit-trade-button` - Submit trade proposal
- `cancel-trade-dialog` - Cancel/close dialog

**Trade Notifications:**
- `trade-notification` - Incoming trade notification
- `trade-details` - Trade details in notification
- `accept-trade-button` - Accept trade
- `reject-trade-button` - Reject trade

**Pending Trades:**
- `pending-trades-list` - List of pending trades
- `outgoing-trade-{id}` - Outgoing trade item
- `cancel-outgoing-trade` - Cancel own trade

**Validation:**
- `trade-validation-error` - Validation error message

### Example Tests

```typescript
test('E2E-6.1: Propose and accept trade', async ({ browser, request }) => {
  const { roomCode, player1, player2 } = await setupTwoHumanPlayers(browser, request)

  // Navigate both players to game
  await player1.page.goto(`/play/${roomCode}`)
  await player2.page.goto(`/play/${roomCode}`)

  // Wait for game to load
  await player1.page.waitForSelector('[data-testid="game-board"]')
  await player2.page.waitForSelector('[data-testid="game-board"]')

  // Player 1 proposes trade to Player 2
  await player1.page.click('[data-testid="open-trade-button"]')
  await player1.page.selectOption('[data-testid="trade-recipient-select"]', player2.id)
  await player1.page.fill('[data-testid="trade-offer-money"]', '500')
  await player1.page.click('[data-testid="submit-trade-button"]')

  // Player 2 receives notification
  await expect(player2.page.locator('[data-testid="trade-notification"]')).toBeVisible()

  // Player 2 accepts
  await player2.page.click('[data-testid="accept-trade-button"]')

  // Both see confirmation and updated cash
  await expect(player1.page.locator('[data-testid="trade-notification"]')).not.toBeVisible()
  // Player 1 cash decreased, Player 2 cash increased

  // Cleanup
  await player1.context.close()
  await player2.context.close()
})

test('E2E-6.2: Reject trade offer', async ({ browser, request }) => {
  const { roomCode, player1, player2 } = await setupTwoHumanPlayers(browser, request)

  await player1.page.goto(`/play/${roomCode}`)
  await player2.page.goto(`/play/${roomCode}`)
  await player1.page.waitForSelector('[data-testid="game-board"]')

  // Player 1 proposes trade
  await player1.page.click('[data-testid="open-trade-button"]')
  await player1.page.selectOption('[data-testid="trade-recipient-select"]', player2.id)
  await player1.page.fill('[data-testid="trade-offer-money"]', '500')
  await player1.page.click('[data-testid="submit-trade-button"]')

  // Player 2 rejects
  await player2.page.waitForSelector('[data-testid="trade-notification"]')
  await player2.page.click('[data-testid="reject-trade-button"]')

  // Trade removed from both views
  await expect(player1.page.locator('[data-testid="trade-notification"]')).not.toBeVisible()
  await expect(player2.page.locator('[data-testid="trade-notification"]')).not.toBeVisible()

  // No cash/stocks changed
  // ...

  await player1.context.close()
  await player2.context.close()
})

test('E2E-6.4: Trade validation - insufficient stocks', async ({ browser, request }) => {
  const { roomCode, player1, player2 } = await setupTwoHumanPlayers(browser, request)

  await player1.page.goto(`/play/${roomCode}`)
  await player1.page.waitForSelector('[data-testid="game-board"]')

  // Try to offer stocks we don't have
  await player1.page.click('[data-testid="open-trade-button"]')
  await player1.page.selectOption('[data-testid="trade-recipient-select"]', player2.id)
  await player1.page.fill('[data-testid="trade-offer-stocks-luxor"]', '10') // Don't have 10

  // Should show validation error
  await expect(player1.page.locator('[data-testid="trade-validation-error"]'))
    .toContainText(/insufficient|don't have/i)

  // Submit button should be disabled
  await expect(player1.page.locator('[data-testid="submit-trade-button"]')).toBeDisabled()

  await player1.context.close()
  await player2.context.close()
})

test('E2E-6.7: Trade during bot turn', async ({ browser, request }) => {
  const { roomCode, player1, player2 } = await setupTwoHumanPlayers(browser, request)

  await player1.page.goto(`/play/${roomCode}`)
  await player2.page.goto(`/play/${roomCode}`)
  await player1.page.waitForSelector('[data-testid="game-board"]')

  // Wait for bot's turn (not human turn)
  // This verifies trading works asynchronously regardless of game turn

  // Player 1 proposes trade
  await player1.page.click('[data-testid="open-trade-button"]')
  await player1.page.selectOption('[data-testid="trade-recipient-select"]', player2.id)
  await player1.page.fill('[data-testid="trade-offer-money"]', '100')
  await player1.page.click('[data-testid="submit-trade-button"]')

  // Player 2 can accept even during bot turn
  await player2.page.waitForSelector('[data-testid="trade-notification"]')
  await player2.page.click('[data-testid="accept-trade-button"]')

  // Trade completes successfully
  await expect(player1.page.locator('[data-testid="trade-notification"]')).not.toBeVisible()

  await player1.context.close()
  await player2.context.close()
})
```

### Chain Name Format

Backend expects title-case chain names: `"Luxor"`, `"Tower"`, `"American"`, etc.

## Verification

```bash
cd frontend

# Run trading tests
npm run e2e -- --grep "Trading"

# Run specific scenario
npm run e2e -- --grep "E2E-6.1"

# Debug with visible browsers
npm run e2e -- --grep "E2E-6.1" --headed
```

## Reference

- [Trading Flow Scenarios](../../../tests/frontend-e2e/trading-flow.md)
- [TradeBuilder Component](../../../../frontend/src/components/game/TradeBuilder.tsx)
- [Backend Trade Handlers](../../../../backend/main.py) (lines 1007-1175)
