# GU-021: Error Handling E2E Tests

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: GU-018

## Context

Test error handling and edge cases. These scenarios verify the app handles errors gracefully and provides useful feedback to users.

## Requirements

Implement all E2E-5.x scenarios from `docs/tests/frontend-e2e/error-handling.md`:

1. **E2E-5.1**: Invalid room code format
2. **E2E-5.2**: Game full error
3. **E2E-5.3**: Game already started
4. **E2E-5.4**: Duplicate player name
5. **E2E-5.5**: WebSocket connection failed
6. **E2E-5.6**: Invalid action attempt (not your turn)
7. **E2E-5.7**: Insufficient funds error
8. **E2E-5.8**: Network error during action
9. **E2E-5.9**: Toast notification stacking
10. **E2E-5.10**: Session recovery after error
11. **E2E-5.11**: Graceful degradation
12. **E2E-5.12**: Browser back button handling

## Acceptance Criteria

- [ ] All 12 E2E-5.x scenarios pass
- [ ] Error messages are user-friendly
- [ ] App recovers gracefully from errors
- [ ] No unhandled exceptions in console
- [ ] Tests complete in < 2 minutes total
- [ ] No flaky tests

## Implementation Notes

### Required data-testid Selectors

**Error Display:**
- `error-toast` - Toast notification for errors
- `error-message` - Inline error message
- `validation-error` - Form validation error

**Action Feedback:**
- `not-your-turn-message` - Message when acting out of turn
- `insufficient-funds-error` - Cannot afford purchase
- `action-failed-message` - Generic action failure
- `retry-button` - Retry failed action

**Connection Errors:**
- `connection-error` - Connection failure message
- `server-unavailable` - Server unavailable message

### Example Tests

```typescript
test('E2E-5.1: Invalid room code format', async ({ page }) => {
  await page.goto('/')

  // Try invalid formats
  await page.getByTestId('join-name-input').fill('TestPlayer')
  await page.getByTestId('join-room-input').fill('123') // Too short, numbers
  await page.getByTestId('join-button').click()

  await expect(page.getByTestId('validation-error')).toContainText(/4.*letters/i)
  await expect(page).toHaveURL('/')
})

test('E2E-5.2: Game full error', async ({ page, request }) => {
  // Create room and fill with 6 players (max)
  const { room_code } = await createRoom(request, 'Host')
  for (let i = 0; i < 5; i++) {
    await addBot(request, room_code)
  }

  // Try to join as 7th player
  await page.goto('/')
  await page.getByTestId('join-name-input').fill('ExtraPlayer')
  await page.getByTestId('join-room-input').fill(room_code)
  await page.getByTestId('join-button').click()

  await expect(page.getByTestId('error-toast')).toContainText(/full/i)
})

test('E2E-5.3: Game already started', async ({ page, request }) => {
  // Create and start game
  const { room_code } = await createRoom(request, 'Host')
  await addBot(request, room_code)
  await addBot(request, room_code)
  await startGame(request, room_code)

  // Try to join after game started
  await page.goto('/')
  await page.getByTestId('join-name-input').fill('LatePlayer')
  await page.getByTestId('join-room-input').fill(room_code)
  await page.getByTestId('join-button').click()

  await expect(page.getByTestId('error-toast')).toContainText(/already.*started|in progress/i)
})

test('E2E-5.5: WebSocket connection failed', async ({ page }) => {
  // Block WebSocket connections
  await page.route('**/ws/**', route => route.abort())

  await page.goto('/')
  await page.getByTestId('create-name-input').fill('TestPlayer')
  await page.getByTestId('create-button').click()

  // Should show connection error
  await expect(page.locator('[data-testid="connection-error"]')).toBeVisible({ timeout: 10000 })
})

test('E2E-5.6: Invalid action attempt', async ({ page, request }) => {
  // Setup game where it's NOT our turn
  const { roomCode } = await setupGameWithBots(request, page, 'TestPlayer', 2)
  await page.goto(`/play/${roomCode}`)

  // Wait for game to load but not our turn
  await page.waitForSelector('[data-testid="game-board"]')

  // If it happens to be our turn, skip this test instance
  const isOurTurn = await page.locator('[data-testid="your-turn-indicator"]').isVisible()
  if (isOurTurn) {
    test.skip()
    return
  }

  // Try to click a tile (should be blocked or show error)
  const tile = page.locator('[data-testid^="tile-"]').first()
  await tile.click()

  await expect(page.locator('[data-testid="not-your-turn-message"]')).toBeVisible()
})

test('E2E-5.9: Toast notification stacking', async ({ page }) => {
  await page.goto('/')

  // Trigger multiple errors rapidly
  for (let i = 0; i < 3; i++) {
    await page.getByTestId('join-room-input').fill('ZZZZ')
    await page.getByTestId('join-name-input').fill('Test')
    await page.getByTestId('join-button').click()
    await page.waitForTimeout(100)
  }

  // Multiple toasts should stack, not overflow
  const toasts = page.locator('[data-testid="toast"]')
  const count = await toasts.count()
  expect(count).toBeGreaterThanOrEqual(1)
  expect(count).toBeLessThanOrEqual(5) // Should limit stacking
})

test('E2E-5.12: Browser back button handling', async ({ page, request }) => {
  const { roomCode } = await setupGameWithBots(request, page, 'TestPlayer', 2)
  await page.goto(`/play/${roomCode}`)
  await page.waitForSelector('[data-testid="game-board"]')

  // Listen for dialog
  page.on('dialog', async dialog => {
    expect(dialog.message()).toMatch(/leave|game/i)
    await dialog.dismiss() // Stay in game
  })

  // Try to navigate back
  await page.goBack()

  // Should still be in game (dialog was dismissed)
  await expect(page.locator('[data-testid="game-board"]')).toBeVisible()
})
```

### Console Error Monitoring

```typescript
test.beforeEach(async ({ page }) => {
  const errors: string[] = []
  page.on('pageerror', err => errors.push(err.message))
  page.on('console', msg => {
    if (msg.type() === 'error') errors.push(msg.text())
  })

  // Store for afterEach
  (page as any).__consoleErrors = errors
})

test.afterEach(async ({ page }) => {
  const errors = (page as any).__consoleErrors || []
  // Filter expected errors
  const unexpected = errors.filter(e => !e.includes('expected error'))
  expect(unexpected).toHaveLength(0)
})
```

## Verification

```bash
cd frontend

# Run error handling tests
npm run e2e -- --grep "Error"

# Run specific scenario
npm run e2e -- --grep "E2E-5.1"
```

## Reference

- [Error Handling Scenarios](../../../tests/frontend-e2e/error-handling.md)
- [Toast Component](../../../../frontend/src/components/ui/Toast.tsx)
- [ErrorBoundary Component](../../../../frontend/src/components/ErrorBoundary.tsx)
