# GU-016: E2E Infrastructure Validation

## Metadata
- **Epic**: Game UI
- **Status**: `complete`
- **Priority**: `high`
- **Effort**: `S` (30-60 min)
- **Dependencies**: GU-001 through GU-015, FF-011

## Context

Before writing comprehensive E2E tests, we need to validate that the E2E testing infrastructure actually works end-to-end with the real backend. This story focuses on ONE simple scenario to prove the pipeline works.

FF-011 set up Playwright and helpers, but we haven't verified that a real user flow works with the actual backend in CI. This story is the smoke test.

## Requirements

Implement **one simple E2E test** that validates the entire stack:

1. **Single Scenario**: Create a room via UI and verify redirect
2. **Real Backend**: Test must run against actual backend (not mocked)
3. **Verify Infrastructure**: Confirm Playwright config, helpers, and CI all work

This is intentionally minimal. Complex scenarios come in subsequent stories (GU-017 through GU-022).

### Screenshot Evidence Requirements (CRITICAL)

**Tests without screenshots are not proof of anything.** A test can "pass" while the page is completely blank if it only checks for URL changes.

Every E2E test MUST:

1. **Capture screenshots at key moments:**
   ```typescript
   await page.screenshot({ path: 'test-results/1-after-navigation.png', fullPage: true })
   ```

2. **Check browser console for JavaScript errors:**
   ```typescript
   const errors: string[] = []
   page.on('pageerror', err => errors.push(err.message))
   // ... test actions ...
   expect(errors).toHaveLength(0)
   ```

3. **Verify actual content renders (not just element existence):**
   ```typescript
   // BAD - just checks element exists
   await expect(page.locator('.game-board')).toBeVisible()

   // GOOD - verifies real content
   await expect(page.getByText('WAITING FOR PLAYERS')).toBeVisible()
   await expect(page.getByText('TestPlayer')).toBeVisible()
   ```

4. **Run against REAL servers (not mocked):**
   ```bash
   # Verify servers are running BEFORE tests
   curl -s http://127.0.0.1:8000/docs > /dev/null && echo "Backend: OK"
   curl -s http://127.0.0.1:5173 > /dev/null && echo "Frontend: OK"
   ```

### Why This Matters

In January 2026, we had E2E tests "passing" that:
- Never connected to WebSocket (Vite proxy misconfigured)
- Rendered blank pages (React infinite render loop)
- Claimed success while the app was completely broken

Screenshots would have caught this immediately. No screenshot = no proof = didn't happen.

## Acceptance Criteria

- [x] E2E test creates room via UI and verifies redirect to `/play/{CODE}?is_host=1`
- [x] Test runs successfully with `npm run e2e` in frontend/
- [x] Test uses existing `data-testid` selectors (no component changes needed)
- [x] CI pipeline passes with E2E tests enabled
- [x] Documentation updated with "how to run E2E tests locally"

## Implementation Notes

### Approach

This story validates existing infrastructure. The test already exists in `lobby.spec.ts` but may not have been run against a real backend in CI.

### Key Verification Points

1. **Playwright Config**: Does it correctly proxy to backend?
2. **Backend Startup**: Does the test setup start/connect to backend?
3. **Session Handling**: Do cookies/session storage work correctly?
4. **CI Integration**: Does GitHub Actions run E2E tests?

### Existing Test to Verify

From `frontend/tests/e2e/lobby.spec.ts`:
```typescript
test('creates game and redirects to player view with is_host flag', async ({ page }) => {
  await page.goto('/')
  await page.getByTestId('create-name-input').fill('TestHost')
  await page.getByTestId('create-button').click()
  await page.waitForURL(/\/play\/[A-Z]{4}\?is_host=1/)
  // ...
})
```

### Existing data-testid Selectors (DO NOT CHANGE)

These selectors are already in the codebase:
- `create-name-input` - Name input for creating game
- `create-button` - Create game button
- `join-name-input` - Name input for joining
- `join-room-input` - Room code input
- `join-button` - Join game button

### Local Testing Steps

```bash
# Terminal 1: Start backend
cd backend
python -m uvicorn main:app --reload --port 8000

# Terminal 2: Run E2E tests
cd frontend
npm run e2e

# Or run specific test
npm run e2e -- --grep "creates game and redirects"

# Debug mode (see browser)
npm run e2e -- --headed --debug
```

### CI Configuration

Verify `.github/workflows/` includes E2E test step with backend running.

## Verification

```bash
# Run the specific validation test
cd frontend
npm run e2e -- --grep "creates game and redirects"

# Verify it passes consistently (run 5 times)
for i in {1..5}; do npm run e2e -- --grep "creates game" 2>&1 | grep -E "(passed|failed)"; done

# Check CI passes
git push && # verify GitHub Actions
```

## Success Criteria

After this story:
1. We have confidence E2E infrastructure works
2. We have documented local setup instructions
3. CI runs E2E tests on every PR
4. We can proceed to write more complex E2E tests (GU-017+)

## Next Stories

This story unlocks:
- GU-017: Lobby E2E Tests (all E2E-1.x scenarios)
- GU-018: Gameplay E2E Tests (requires RT-001, RT-002)
- GU-019: Merger E2E Tests
- GU-020: Reconnection E2E Tests
- GU-021: Error Handling E2E Tests
- GU-022: Trading E2E Tests

## Reference

- [E2E Test Scenarios](../../../tests/frontend-e2e/README.md)
- [Playwright Config](../../../../frontend/playwright.config.ts)
- [Existing Lobby Tests](../../../../frontend/tests/e2e/lobby.spec.ts)
