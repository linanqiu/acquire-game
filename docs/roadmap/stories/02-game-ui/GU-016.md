# GU-016: Comprehensive E2E Test Suite

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: GU-001 through GU-015, FF-011, RT-002

> **Note**: RT-002 (WebSocket integration) is required because E2E tests need real backend communication for game actions.

## Context

FF-011 established the E2E testing infrastructure (Playwright config, helpers, types). This story implements the comprehensive E2E test suite covering all user flows documented in `docs/tests/frontend-e2e/`.

The test scenarios are already specified - this story is about implementing them using the infrastructure from FF-011.

## Requirements

Implement E2E tests for all documented scenarios:

1. **Lobby Flow** (`docs/tests/frontend-e2e/lobby-flow.md`)
   - Create room
   - Join room
   - Add/remove bots
   - Start game

2. **Gameplay Flow** (`docs/tests/frontend-e2e/gameplay-flow.md`)
   - Place tile on empty board
   - Found new chain
   - Buy stocks
   - End turn and draw tile
   - Stock limit enforcement
   - Chain expansion
   - Full turn cycle (3 players)
   - Bot takes turn
   - Unplayable tile replacement

3. **Merger Flow** (`docs/tests/frontend-e2e/merger-flow.md`)
   - Trigger merger
   - Choose surviving chain
   - Stock disposition (sell/trade/hold)
   - Majority/minority bonuses
   - Multi-chain merger

4. **Trading Flow** (`docs/tests/frontend-e2e/trading-flow.md`)
   - Propose trade
   - Accept/reject trade
   - Cancel trade
   - Invalid trade handling

5. **Reconnection Flow** (`docs/tests/frontend-e2e/reconnection-flow.md`)
   - Connection loss detection
   - Auto-reconnect
   - Manual rejoin
   - State sync after reconnect

6. **Error Handling** (`docs/tests/frontend-e2e/error-handling.md`)
   - Invalid actions
   - Network errors
   - Rate limiting
   - Session expiry

## Acceptance Criteria

- [ ] All lobby flow scenarios pass (E2E-1.x)
- [ ] All gameplay flow scenarios pass (E2E-2.x)
- [ ] All merger flow scenarios pass (E2E-3.x)
- [ ] All trading flow scenarios pass (E2E-4.x)
- [ ] All reconnection flow scenarios pass (E2E-5.x)
- [ ] All error handling scenarios pass (E2E-6.x)
- [ ] Tests use proper data-testid selectors from UI components
- [ ] Tests are stable (no flaky failures)
- [ ] CI passes with E2E tests enabled

## Implementation Notes

### File Structure

```
frontend/tests/e2e/
├── helpers/           # From FF-011
│   ├── api.ts
│   ├── websocket.ts
│   └── game.ts
├── home.spec.ts       # Basic routing (from FF-011)
├── bot-game.spec.ts   # API-level bot tests (from FF-011)
├── lobby.spec.ts      # E2E-1.x: Lobby flow
├── gameplay.spec.ts   # E2E-2.x: Gameplay flow
├── merger.spec.ts     # E2E-3.x: Merger flow
├── trading.spec.ts    # E2E-4.x: Trading flow
├── reconnection.spec.ts # E2E-5.x: Reconnection flow
└── errors.spec.ts     # E2E-6.x: Error handling
```

### Example Test (Lobby Flow)

**frontend/tests/e2e/lobby.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'

test.describe('Lobby Flow', () => {
  test('E2E-1.1: Create new room', async ({ page }) => {
    await page.goto('/')

    // Fill in player name
    await page.fill('[data-testid="player-name-input"]', 'Alice')

    // Click create room
    await page.click('[data-testid="create-room-button"]')

    // Verify redirected to host view with room code
    await expect(page).toHaveURL(/\/host\/[A-Z]{4}/)
    await expect(page.locator('[data-testid="room-code"]')).toBeVisible()
  })

  test('E2E-1.2: Join existing room', async ({ page, request }) => {
    // Create room via API first
    const { createRoom } = await import('./helpers/api')
    const { room_code } = await createRoom(request, 'Host')

    // Navigate to lobby
    await page.goto('/')

    // Enter room code and name
    await page.fill('[data-testid="room-code-input"]', room_code)
    await page.fill('[data-testid="player-name-input"]', 'Guest')
    await page.click('[data-testid="join-room-button"]')

    // Verify in player view
    await expect(page).toHaveURL(`/play/${room_code}`)
  })

  test('E2E-1.3: Add bot to room', async ({ page, request }) => {
    const { createRoom } = await import('./helpers/api')
    const { room_code } = await createRoom(request, 'Host')

    await page.goto(`/host/${room_code}`)

    // Click add bot
    await page.click('[data-testid="add-bot-button"]')

    // Verify bot appears in player list
    await expect(page.locator('[data-testid="player-list"]')).toContainText('Bot')
  })
})
```

### Example Test (Gameplay Flow)

**frontend/tests/e2e/gameplay.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'
import { setupGameWithBots, waitForHumanTurn } from './helpers/game'

test.describe('Gameplay Flow', () => {
  test('E2E-2.1: Place tile on empty board', async ({ page, request }) => {
    const { humanPlayer } = await setupGameWithBots(request, page, 'TestPlayer', 2)

    // Navigate to player view
    await page.goto(`/play/${humanPlayer.roomCode}`)

    // Wait for our turn
    await expect(page.locator('[data-testid="your-turn-indicator"]')).toBeVisible()

    // Click a tile in hand
    const tile = page.locator('[data-testid^="tile-"]').first()
    const tileId = await tile.getAttribute('data-testid')
    await tile.click()

    // Verify tile placed on board
    const cellId = tileId?.replace('tile-', 'board-cell-')
    await expect(page.locator(`[data-testid="${cellId}"]`)).toHaveClass(/placed/)
  })

  test('E2E-2.2: Found new chain', async ({ page, request }) => {
    // Setup game with specific board state (need deterministic seeding)
    // ...

    // Place adjacent tile
    await page.click('[data-testid="tile-3C"]')

    // Chain selection modal appears
    await expect(page.locator('[data-testid="chain-selection-modal"]')).toBeVisible()

    // Select Luxor
    await page.click('[data-testid="chain-luxor"]')

    // Verify chain founded
    await expect(page.locator('[data-testid="board-cell-3B"]')).toHaveClass(/luxor/)
    await expect(page.locator('[data-testid="board-cell-3C"]')).toHaveClass(/luxor/)
  })
})
```

### Required data-testid Selectors

Each GU-* story should ensure these selectors are added to components:

**Lobby:**
- `player-name-input`
- `room-code-input`
- `create-room-button`
- `join-room-button`
- `add-bot-button`
- `remove-bot-button`
- `start-game-button`
- `player-list`
- `room-code`

**Game Board:**
- `board-cell-{tile}` (e.g., `board-cell-3B`)
- `tile-{id}` (tiles in hand)
- `your-turn-indicator`
- `waiting-message`
- `current-player`

**Stock Purchase:**
- `buy-{chain}-plus`
- `buy-{chain}-minus`
- `purchase-total`
- `confirm-purchase`
- `skip-purchase`
- `stock-limit-message`

**Chain Info:**
- `chain-{name}-size`
- `chain-{name}-price`
- `chain-selection-modal`
- `chain-{name}` (selection button)

**Player Info:**
- `player-cash`
- `player-stocks-{chain}`
- `player-tiles`

## Verification

```bash
# Run all E2E tests
npm run e2e

# Run specific flow
npm run e2e -- --grep "Lobby Flow"
npm run e2e -- --grep "Gameplay Flow"
npm run e2e -- --grep "Merger Flow"

# Run in headed mode for debugging
npm run e2e:headed

# Generate test report
npx playwright show-report
```

## Reference

- [E2E Test Scenarios](../../../tests/frontend-e2e/README.md)
- [Lobby Flow Scenarios](../../../tests/frontend-e2e/lobby-flow.md)
- [Gameplay Flow Scenarios](../../../tests/frontend-e2e/gameplay-flow.md)
- [Merger Flow Scenarios](../../../tests/frontend-e2e/merger-flow.md)
- [Trading Flow Scenarios](../../../tests/frontend-e2e/trading-flow.md)
- [Reconnection Flow Scenarios](../../../tests/frontend-e2e/reconnection-flow.md)
- [Error Handling Scenarios](../../../tests/frontend-e2e/error-handling.md)
