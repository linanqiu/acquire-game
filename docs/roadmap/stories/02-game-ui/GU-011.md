# GU-011: Trade Builder

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: GU-008, GU-009, FF-008

## Context

Complex form for building player-to-player trade proposals. Only available during Phase 1 of your turn. Allows trading stocks and cash between players.

## Requirements

1. Select trade partner from other players
2. Add stocks and/or cash to "You Offer"
3. Add stocks and/or cash to "You Want"
4. Validate against actual holdings
5. Show partner's holdings for reference
6. Submit or cancel trade proposal

## Acceptance Criteria

- [ ] Player selector shows all other players with their cash
- [ ] "You Offer" section: add stocks (from your holdings), cash
- [ ] "You Want" section: add stocks (from their holdings), cash
- [ ] Cannot offer more than you have
- [ ] Cannot request more than they have
- [ ] Multiple stock types can be added
- [ ] Clear validation errors
- [ ] Cancel button resets form
- [ ] Propose button submits trade
- [ ] Unit tests for validation

## Implementation Notes

### File to Create

**frontend/src/components/game/TradeBuilder.tsx**:
```tsx
import { useState } from 'react'
import { ChainMarker } from './ChainMarker'
import { StockStepper } from './StockStepper'
import { TextInput } from '../ui/TextInput'
import { Button } from '../ui/Button'
import { Card } from '../ui/Card'
import { Modal } from '../ui/Modal'
import styles from './TradeBuilder.module.css'
import type { ChainName } from '../../types/game'

interface Player {
  id: string
  name: string
  cash: number
  stocks: { chain: ChainName; quantity: number }[]
}

interface TradeOffer {
  stocks: { chain: ChainName; quantity: number }[]
  cash: number
}

interface TradeBuilderProps {
  players: Player[]
  myHoldings: { chain: ChainName; quantity: number }[]
  myCash: number
  onPropose: (partnerId: string, offer: TradeOffer, want: TradeOffer) => void
  onCancel: () => void
}

export function TradeBuilder({
  players,
  myHoldings,
  myCash,
  onPropose,
  onCancel,
}: TradeBuilderProps) {
  const [partnerId, setPartnerId] = useState<string>('')
  const [offer, setOffer] = useState<TradeOffer>({ stocks: [], cash: 0 })
  const [want, setWant] = useState<TradeOffer>({ stocks: [], cash: 0 })
  const [error, setError] = useState('')

  const partner = players.find((p) => p.id === partnerId)

  const updateOfferStock = (chain: ChainName, qty: number) => {
    const stocks = [...offer.stocks.filter((s) => s.chain !== chain)]
    if (qty > 0) stocks.push({ chain, quantity: qty })
    setOffer({ ...offer, stocks })
  }

  const updateWantStock = (chain: ChainName, qty: number) => {
    const stocks = [...want.stocks.filter((s) => s.chain !== chain)]
    if (qty > 0) stocks.push({ chain, quantity: qty })
    setWant({ ...want, stocks })
  }

  const handleSubmit = () => {
    if (!partnerId) {
      setError('Select a trade partner')
      return
    }
    if (offer.stocks.length === 0 && offer.cash === 0) {
      setError('You must offer something')
      return
    }
    if (want.stocks.length === 0 && want.cash === 0) {
      setError('You must want something')
      return
    }
    onPropose(partnerId, offer, want)
  }

  return (
    <Card title="NEW TRADE" onClose={onCancel}>
      {error && <p className={styles.error}>{error}</p>}

      <div className={styles.section}>
        <label className={styles.label}>TRADE WITH:</label>
        <div className={styles.players}>
          {players.map((p) => (
            <button
              key={p.id}
              className={`${styles.playerButton} ${partnerId === p.id ? styles.selected : ''}`}
              onClick={() => setPartnerId(p.id)}
            >
              <span>{p.name}</span>
              <span className={styles.playerCash}>${p.cash.toLocaleString()}</span>
            </button>
          ))}
        </div>
      </div>

      <div className={styles.section}>
        <label className={styles.label}>YOU OFFER:</label>
        {myHoldings.filter(h => h.quantity > 0).map((h) => (
          <div key={h.chain} className={styles.stockRow}>
            <ChainMarker chain={h.chain} variant="compact" />
            <StockStepper
              value={offer.stocks.find((s) => s.chain === h.chain)?.quantity || 0}
              max={h.quantity}
              onChange={(qty) => updateOfferStock(h.chain, qty)}
            />
            <span className={styles.available}>(you have {h.quantity})</span>
          </div>
        ))}
        <div className={styles.cashRow}>
          <label>Cash:</label>
          <TextInput
            type="number"
            value={offer.cash.toString()}
            onChange={(e) => setOffer({ ...offer, cash: Math.min(myCash, Number(e.target.value) || 0) })}
          />
        </div>
      </div>

      {partner && (
        <div className={styles.section}>
          <label className={styles.label}>YOU WANT:</label>
          {partner.stocks.filter(h => h.quantity > 0).map((h) => (
            <div key={h.chain} className={styles.stockRow}>
              <ChainMarker chain={h.chain} variant="compact" />
              <StockStepper
                value={want.stocks.find((s) => s.chain === h.chain)?.quantity || 0}
                max={h.quantity}
                onChange={(qty) => updateWantStock(h.chain, qty)}
              />
              <span className={styles.available}>(they have {h.quantity})</span>
            </div>
          ))}
          <div className={styles.cashRow}>
            <label>Cash:</label>
            <TextInput
              type="number"
              value={want.cash.toString()}
              onChange={(e) => setWant({ ...want, cash: Math.min(partner.cash, Number(e.target.value) || 0) })}
            />
          </div>
        </div>
      )}

      <div className={styles.actions}>
        <Button variant="secondary" onClick={onCancel}>CANCEL</Button>
        <Button onClick={handleSubmit}>PROPOSE TRADE</Button>
      </div>
    </Card>
  )
}
```

## Verification

```bash
npm run test -- --grep "TradeBuilder"
npm run e2e -- --grep "trade"
```

## Reference

- [Storyboard - Trade Builder](../../../ui/storyboard.md#trade-builder-your-turn)
- [Components Spec - TradeBuilder](../../../ui/components.md#tradebuilder)
