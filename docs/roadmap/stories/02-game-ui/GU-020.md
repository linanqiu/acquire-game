# GU-020: Reconnection E2E Tests

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: GU-018

## Context

Test the reconnection and disconnect handling flows. These scenarios verify the app handles network interruptions gracefully.

## Requirements

Implement all E2E-4.x scenarios from `docs/tests/frontend-e2e/reconnection-flow.md`:

1. **E2E-4.1**: Brief disconnection recovery
2. **E2E-4.2**: Page refresh during game
3. **E2E-4.3**: Reconnection during own turn
4. **E2E-4.4**: Host reconnection
5. **E2E-4.5**: Player disconnects during merger disposition
6. **E2E-4.6**: Extended disconnection handling
7. **E2E-4.7**: Multiple players disconnect simultaneously
8. **E2E-4.8**: Token expiration and re-auth
9. **E2E-4.9**: Reconnection with changed game state
10. **E2E-4.10**: Graceful handling of permanent disconnect

## Acceptance Criteria

- [ ] All 10 E2E-4.x scenarios pass
- [ ] Network simulation works reliably with Playwright
- [ ] State synchronization verified after reconnect
- [ ] No data loss or corruption on reconnect
- [ ] Tests complete in < 3 minutes total
- [ ] No flaky tests

## Implementation Notes

### Network Simulation with Playwright

```typescript
// Simulate network offline
await page.context().setOffline(true)

// Wait and verify reconnection indicator
await expect(page.locator('[data-testid="reconnecting-indicator"]')).toBeVisible()

// Restore network
await page.context().setOffline(false)

// Verify recovery
await expect(page.locator('[data-testid="reconnecting-indicator"]')).not.toBeVisible()
```

### Required data-testid Selectors

**Reconnection UI:**
- `reconnecting-indicator` - Shows during reconnection attempt
- `reconnected-toast` - Success toast after reconnect
- `connection-status` - Current connection status
- `connection-lost-modal` - Modal when connection lost for extended period

**Session Recovery:**
- `rejoin-prompt` - Prompt to rejoin after session loss
- `rejoin-button` - Button to rejoin room

**Player Status (Host View):**
- `player-{id}-status` - Individual player connection status
- `player-disconnected-badge` - Badge showing player is disconnected

### Example Tests

```typescript
test('E2E-4.1: Brief disconnection recovery', async ({ page, request }) => {
  const { roomCode } = await setupGameWithBots(request, page, 'TestPlayer', 2)
  await page.goto(`/play/${roomCode}`)
  await waitForMyTurn(page)

  // Simulate brief network loss
  await page.context().setOffline(true)
  await expect(page.locator('[data-testid="reconnecting-indicator"]')).toBeVisible()

  // Restore network after 2 seconds
  await page.waitForTimeout(2000)
  await page.context().setOffline(false)

  // Verify recovery - no manual action needed
  await expect(page.locator('[data-testid="reconnecting-indicator"]')).not.toBeVisible({ timeout: 10000 })
  await expect(page.locator('[data-testid="game-board"]')).toBeVisible()
})

test('E2E-4.2: Page refresh during game', async ({ page, request }) => {
  const { roomCode } = await setupGameWithBots(request, page, 'TestPlayer', 2)
  await page.goto(`/play/${roomCode}`)

  // Get current room code from URL
  const url = page.url()

  // Refresh page
  await page.reload()

  // Verify automatic rejoin - same URL, game state restored
  await expect(page).toHaveURL(url)
  await expect(page.locator('[data-testid="game-board"]')).toBeVisible()
})

test('E2E-4.3: Reconnection during own turn', async ({ page, request }) => {
  const { roomCode } = await setupGameWithBots(request, page, 'TestPlayer', 2)
  await page.goto(`/play/${roomCode}`)
  await waitForMyTurn(page)

  // Verify it's our turn
  await expect(page.locator('[data-testid="your-turn-indicator"]')).toBeVisible()

  // Disconnect and reconnect
  await page.context().setOffline(true)
  await page.waitForTimeout(2000)
  await page.context().setOffline(false)

  // Verify turn preserved
  await expect(page.locator('[data-testid="your-turn-indicator"]')).toBeVisible({ timeout: 10000 })

  // Can still place tile
  const tile = page.locator('[data-testid^="tile-"]').first()
  await tile.click()
  // Verify action succeeded
})
```

### Extended Disconnection Test

```typescript
test('E2E-4.6: Extended disconnection handling', async ({ page, browser, request }) => {
  const { roomCode, playerId } = await setupGameWithBots(request, page, 'TestPlayer', 2)
  await page.goto(`/play/${roomCode}`)

  // Open host view in another context to observe
  const hostContext = await browser.newContext()
  const hostPage = await hostContext.newPage()
  await hostPage.goto(`/play/${roomCode}?is_host=1`)

  // Disconnect player for 30+ seconds
  await page.context().setOffline(true)

  // During disconnect, bots may take turns
  // Host should show player as disconnected
  await expect(hostPage.locator(`[data-testid="player-${playerId}-status"]`))
    .toHaveClass(/disconnected/, { timeout: 35000 })

  // Reconnect
  await page.context().setOffline(false)

  // Verify full state sync
  await expect(page.locator('[data-testid="game-board"]')).toBeVisible()
  // Board state should match current (not stale)

  await hostContext.close()
})
```

## Verification

```bash
cd frontend

# Run reconnection tests
npm run e2e -- --grep "Reconnection"

# Run specific scenario
npm run e2e -- --grep "E2E-4.1"

# These tests can be slow - increase timeout
npm run e2e -- --grep "E2E-4.6" --timeout 60000
```

## Reference

- [Reconnection Flow Scenarios](../../../tests/frontend-e2e/reconnection-flow.md)
- [ReconnectionOverlay Component](../../../../frontend/src/components/game/ReconnectionOverlay.tsx)
- [ReconnectedToast Component](../../../../frontend/src/components/game/ReconnectedToast.tsx)
