# GU-018: Gameplay E2E Tests

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: GU-017, RT-001, RT-002

## Context

After lobby E2E tests pass (GU-017) and real-time integration is complete (RT-001, RT-002), implement gameplay flow tests. These require WebSocket communication for game actions.

## Requirements

Implement all E2E-2.x scenarios from `docs/tests/frontend-e2e/gameplay-flow.md`:

1. **E2E-2.1**: Place tile on empty board
2. **E2E-2.2**: Found new chain
3. **E2E-2.3**: Buy stocks
4. **E2E-2.4**: End turn and draw tile
5. **E2E-2.5**: Cannot afford stock purchase
6. **E2E-2.6**: Stock limit enforcement (3 per turn)
7. **E2E-2.7**: Chain expansion
8. **E2E-2.8**: Full turn cycle (3 players)
9. **E2E-2.9**: Bot takes turn
10. **E2E-2.10**: Unplayable tile replacement

## Acceptance Criteria

- [ ] All 10 E2E-2.x scenarios pass
- [ ] Tests use WebSocket for real game actions (not API mocking)
- [ ] Tests handle async game state updates correctly
- [ ] Deterministic seeding used where specific board states needed
- [ ] Tests complete in < 3 minutes total
- [ ] No flaky tests (pass 10/10 consecutive runs)

## Implementation Notes

### Deterministic Testing Strategy

For scenarios requiring specific board states (E2E-2.2, E2E-2.7), use backend seeding:

```typescript
// Create room with seed for deterministic tile distribution
const response = await request.post(`${API_URL}/create`, {
  form: { player_name: 'TestPlayer', seed: '12345' }
})
```

**Note**: Verify backend supports `seed` parameter. If not, create follow-up story.

### Game Helper Functions

Extend `frontend/tests/e2e/helpers/game.ts`:

```typescript
export async function setupGameWithBots(
  request: APIRequestContext,
  page: Page,
  playerName: string,
  botCount: number,
  options?: { seed?: string }
): Promise<GameSetup> {
  const { room_code, player_id, session_token } = await createRoom(request, playerName)

  for (let i = 0; i < botCount; i++) {
    await addBot(request, room_code)
  }

  await startGame(request, room_code)

  // Store session for page
  await page.evaluate(({ playerId, token }) => {
    sessionStorage.setItem('player_id', playerId)
    sessionStorage.setItem('session_token', token)
  }, { playerId: player_id, token: session_token })

  return { roomCode: room_code, playerId: player_id }
}

export async function waitForMyTurn(page: Page, timeout = 30000): Promise<void> {
  await page.waitForSelector('[data-testid="your-turn-indicator"]', { timeout })
}

export async function waitForPhase(page: Page, phase: string, timeout = 10000): Promise<void> {
  await page.waitForSelector(`[data-testid="game-phase-${phase}"]`, { timeout })
}
```

### Required data-testid Selectors

**Tile Rack:**
- `tile-{coordinate}` (e.g., `tile-3B`) - Individual tile in hand
- `tile-rack` - Container for player's tiles

**Board:**
- `board-cell-{coordinate}` (e.g., `board-cell-3B`) - Board cell
- `game-board` - Board container

**Turn Indicators:**
- `your-turn-indicator` - Shows when it's player's turn
- `waiting-message` - Shows when waiting for others
- `current-player-name` - Name of current player
- `game-phase-{phase}` - Current game phase indicator

**Stock Purchase:**
- `stock-stepper-{chain}` - Stock purchase control for chain
- `buy-{chain}-plus` - Increment button
- `buy-{chain}-minus` - Decrement button
- `purchase-total` - Total purchase amount
- `confirm-purchase-button` - Confirm purchase
- `skip-purchase-button` - Skip buying
- `stock-limit-warning` - Warning when at 3 stock limit

**Chain Founding:**
- `chain-selection-modal` - Modal for selecting chain to found
- `chain-option-{name}` - Chain selection button (e.g., `chain-option-luxor`)

### Example Test

```typescript
test('E2E-2.1: Place tile on empty board', async ({ page, request }) => {
  // Setup game with 2 bots (3 players total)
  const { roomCode, playerId } = await setupGameWithBots(request, page, 'TestPlayer', 2)

  await page.goto(`/play/${roomCode}`)

  // Wait for game to load and our turn
  await waitForMyTurn(page)

  // Get first tile in rack
  const tile = page.locator('[data-testid^="tile-"]').first()
  const tileCoord = await tile.getAttribute('data-testid')?.replace('tile-', '')

  // Click tile to place it
  await tile.click()

  // Verify tile appears on board
  await expect(page.locator(`[data-testid="board-cell-${tileCoord}"]`))
    .toHaveClass(/placed|has-tile/)

  // Verify tile removed from rack
  await expect(tile).not.toBeVisible()
})
```

### Handling Bot Turns

Bots act automatically. Wait for turn to return:

```typescript
// After our action, wait for bots then our turn again
await waitForMyTurn(page, 60000) // Longer timeout for bot turns
```

## Verification

```bash
cd frontend

# Run gameplay tests
npm run e2e -- --grep "Gameplay"

# Run with visible browser for debugging
npm run e2e -- --grep "E2E-2.1" --headed

# Verify no flaky tests
for i in {1..10}; do npm run e2e -- --grep "E2E-2.1" 2>&1 | tail -1; done
```

## Reference

- [Gameplay Flow Scenarios](../../../tests/frontend-e2e/gameplay-flow.md)
- [Game Helpers](../../../../frontend/tests/e2e/helpers/game.ts)
- [Backend Game API](../../../../backend/main.py)
