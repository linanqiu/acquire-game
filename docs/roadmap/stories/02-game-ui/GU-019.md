# GU-019: Merger E2E Tests

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: GU-018

## Context

After basic gameplay tests pass (GU-018), implement merger flow tests. These are complex scenarios requiring specific board states to trigger mergers.

## Requirements

Implement all E2E-3.x scenarios from `docs/tests/frontend-e2e/merger-flow.md`:

1. **E2E-3.1**: Simple two-chain merger
2. **E2E-3.2**: Merger survivor selection (tie)
3. **E2E-3.3**: Stock disposition - sell all
4. **E2E-3.4**: Stock disposition - trade 2:1
5. **E2E-3.5**: Stock disposition - keep all
6. **E2E-3.6**: Stock disposition - mixed strategy
7. **E2E-3.7**: Multiple players disposition queue
8. **E2E-3.8**: Majority/minority bonus display
9. **E2E-3.9**: Multi-way merger (3 chains)
10. **E2E-3.10**: Safe chain cannot be acquired

## Acceptance Criteria

- [ ] All 10 E2E-3.x scenarios pass
- [ ] Deterministic seeding creates predictable merger scenarios
- [ ] Stock disposition UI fully tested
- [ ] Bonus calculations verified
- [ ] Tests complete in < 5 minutes total
- [ ] No flaky tests

## Implementation Notes

### Deterministic Board States

Merger tests require specific board configurations. Options:

**Option A: Backend Seeding**
```typescript
// If backend supports deterministic seeding
await createRoom(request, 'Player', { seed: 'merger-setup-seed' })
```

**Option B: Setup Helper**
```typescript
// Play through specific moves to create merger scenario
async function setupMergerScenario(page: Page, request: APIRequestContext) {
  // 1. Create game, start with bots
  // 2. Play specific tiles to create two adjacent chains
  // 3. Return when human has the merge tile
}
```

**Option C: API State Injection (if available)**
```typescript
// Direct state manipulation for testing
await request.post(`${API_URL}/test/set-board-state`, {
  data: { board: [...], chains: [...] }
})
```

### Required data-testid Selectors

**Merger UI:**
- `merger-modal` - Main merger resolution modal
- `survivor-chain-name` - Name of surviving chain
- `defunct-chain-name` - Name of defunct chain
- `survivor-selection-modal` - Modal when chains are tied
- `select-survivor-{chain}` - Button to select survivor

**Stock Disposition:**
- `disposition-modal` - Stock disposition modal
- `disposition-sell-input` - Number to sell
- `disposition-trade-input` - Number to trade
- `disposition-keep-input` - Number to keep
- `sell-all-button` - Sell all stocks
- `trade-all-button` - Trade all stocks
- `keep-all-button` - Keep all stocks
- `confirm-disposition-button` - Confirm choices

**Bonus Display:**
- `majority-bonus-amount` - Majority holder bonus
- `minority-bonus-amount` - Minority holder bonus
- `bonus-recipient-{playerId}` - Who received bonus

**Waiting States:**
- `waiting-for-disposition` - Waiting message
- `disposition-queue` - Queue of players to dispose

### Example Test

```typescript
test('E2E-3.3: Stock disposition - sell all', async ({ page, request }) => {
  // Setup game with merger scenario
  const setup = await setupMergerScenario(request, page)
  await page.goto(`/play/${setup.roomCode}`)

  // Wait for merger to trigger and disposition modal
  await page.waitForSelector('[data-testid="disposition-modal"]')

  // Verify we have defunct chain stocks to dispose
  const stockCount = await page.locator('[data-testid="defunct-stock-count"]').textContent()
  expect(parseInt(stockCount!)).toBeGreaterThan(0)

  // Click sell all
  await page.click('[data-testid="sell-all-button"]')
  await page.click('[data-testid="confirm-disposition-button"]')

  // Verify stocks sold (count is now 0)
  await expect(page.locator('[data-testid="player-stocks-tower"]')).toHaveText('0')

  // Verify cash increased
  // (would need to capture before/after)
})
```

### Multi-Player Disposition Queue

For E2E-3.7, use multiple browser contexts:

```typescript
test('E2E-3.7: Multiple players disposition queue', async ({ browser, request }) => {
  // Create 3 human players (or 2 humans + observe bot behavior)
  const player1 = await browser.newContext()
  const player2 = await browser.newContext()

  // Setup game and trigger merger
  // ...

  // Player with most stock goes first
  await expect(player1Page.locator('[data-testid="disposition-modal"]')).toBeVisible()
  await expect(player2Page.locator('[data-testid="waiting-for-disposition"]')).toBeVisible()

  // Player 1 disposes
  await player1Page.click('[data-testid="sell-all-button"]')
  await player1Page.click('[data-testid="confirm-disposition-button"]')

  // Now player 2's turn
  await expect(player2Page.locator('[data-testid="disposition-modal"]')).toBeVisible()
})
```

## Verification

```bash
cd frontend

# Run merger tests
npm run e2e -- --grep "Merger"

# Run specific scenario
npm run e2e -- --grep "E2E-3.3"

# Debug with visible browser
npm run e2e -- --grep "E2E-3.1" --headed --debug
```

## Reference

- [Merger Flow Scenarios](../../../tests/frontend-e2e/merger-flow.md)
- [MergerDisposition Component](../../../../frontend/src/components/game/MergerDisposition.tsx)
- [Backend Merger Logic](../../../../backend/game/merger.py)
