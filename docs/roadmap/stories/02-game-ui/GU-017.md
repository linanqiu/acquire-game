# GU-017: Lobby E2E Tests

## Metadata
- **Epic**: Game UI
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: GU-016

## Context

After validating E2E infrastructure works (GU-016), implement comprehensive lobby flow tests. These test the room creation and joining flow before any WebSocket/game state integration is needed.

## Requirements

Implement all E2E-1.x scenarios from `docs/tests/frontend-e2e/lobby-flow.md`:

1. **E2E-1.1**: Create new room
2. **E2E-1.2**: Join existing room
3. **E2E-1.3**: Join with invalid room code
4. **E2E-1.4**: Host adds bot player
5. **E2E-1.5**: Host starts game
6. **E2E-1.6**: Cannot start with insufficient players
7. **E2E-1.7**: Player leaves before game starts
8. **E2E-1.8**: Room code case insensitivity

## Acceptance Criteria

- [ ] All 8 E2E-1.x scenarios pass
- [ ] Tests extend existing `lobby.spec.ts` (don't duplicate existing tests)
- [ ] Tests use existing data-testid selectors where available
- [ ] Document any new selectors needed (create follow-up for component updates)
- [ ] Tests run in < 60 seconds total
- [ ] No flaky tests (pass 10/10 consecutive runs)

## Implementation Notes

### Existing Tests to Keep

`lobby.spec.ts` already has these tests - keep and possibly rename for consistency:
- "creates game and redirects" → E2E-1.1
- "joins existing room and redirects" → E2E-1.2
- "shows error for non-existent room" → E2E-1.3
- "auto-capitalizes room code" → E2E-1.8

### New Tests Needed

```typescript
// E2E-1.4: Add bot to room
test('E2E-1.4: Host adds bot player', async ({ page, request }) => {
  const { room_code } = await createRoom(request, 'Host')
  // Navigate to player view as host
  await page.goto(`/play/${room_code}?is_host=1`)
  // Note: Need data-testid="add-bot-button" in PlayerView
  // This may require component updates in a follow-up story
})

// E2E-1.5: Start game
test('E2E-1.5: Host starts game with 3+ players', async ({ page, request }) => {
  const { room_code } = await createRoom(request, 'Host')
  await addBot(request, room_code)
  await addBot(request, room_code)
  // Start game via API or UI
  // Verify game board appears
})

// E2E-1.6: Cannot start with insufficient players
test('E2E-1.6: Cannot start with < 3 players', async ({ page, request }) => {
  const { room_code } = await createRoom(request, 'Host')
  // Verify start button disabled or shows error
})

// E2E-1.7: Player disconnect in lobby
test('E2E-1.7: Player leaves before game starts', async ({ browser, request }) => {
  // Use multiple browser contexts
  // Verify player list updates when someone disconnects
})
```

### Existing data-testid Selectors

From lobby page:
- `create-name-input`, `create-button`
- `join-name-input`, `join-room-input`, `join-button`

### New Selectors Needed (Document for Follow-up)

For PlayerView/HostView (may need GU-012/GU-013 updates):
- `add-bot-button` - Add bot to room
- `start-game-button` - Start the game
- `player-list` - List of players in room
- `player-count` - Number of players
- `room-code-display` - Room code display

### Multi-Browser Testing

For E2E-1.7 (player leaves), use multiple browser contexts:
```typescript
test('player leaves updates list', async ({ browser }) => {
  const hostContext = await browser.newContext()
  const playerContext = await browser.newContext()
  const hostPage = await hostContext.newPage()
  const playerPage = await playerContext.newPage()

  // ... test logic

  await playerPage.close()
  // Verify host sees updated player list

  await hostContext.close()
  await playerContext.close()
})
```

## Verification

```bash
cd frontend

# Run lobby tests only
npm run e2e -- --grep "Lobby"

# Run specific scenario
npm run e2e -- --grep "E2E-1.4"

# Verify no flaky tests (run 10 times)
for i in {1..10}; do npm run e2e -- --grep "Lobby" 2>&1 | tail -1; done
```

## Reference

- [Lobby Flow Scenarios](../../../tests/frontend-e2e/lobby-flow.md)
- [Existing Lobby Tests](../../../../frontend/tests/e2e/lobby.spec.ts)
- [API Helpers](../../../../frontend/tests/e2e/helpers/api.ts)
