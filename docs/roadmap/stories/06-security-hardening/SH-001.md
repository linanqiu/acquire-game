# SH-001: Enforce Session Token Validation

## Metadata
- **Epic**: Security Hardening
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `S` (30-60m)
- **Dependencies**: GU-016 (E2E tests must pass first)

## Context

Session tokens are currently optional for backward compatibility. The code validates tokens only when both the request and stored token are non-null. This allows connections without any authentication.

```python
# Current behavior in main.py
if token is not None and player_conn.session_token is not None:
    if token != player_conn.session_token:
        # Validate only if both present
```

This needs to be mandatory before production.

## Requirements

1. Make session token required for all player WebSocket connections
2. Require token for all authenticated REST endpoints
3. Update frontend to always send tokens
4. Add tests verifying token enforcement

## Acceptance Criteria

- [ ] WebSocket connections rejected without valid session token
- [ ] REST endpoints (`/room/{code}/start`, `/room/{code}/add-bot`) require token
- [ ] Token returned from `/create` and `/join` endpoints
- [ ] Frontend stores and sends token with all requests
- [ ] Unauthorized requests return 401 status
- [ ] Tests verify token enforcement for all protected endpoints

## Implementation Notes

### Backend Changes (main.py)

```python
# Make token validation strict
async def player_websocket(websocket: WebSocket, room_code: str, player_id: str, token: str = Query(...)):
    # token is now required (no default)
    player_conn = room.get_player_connection(player_id)
    if not player_conn or player_conn.session_token != token:
        await websocket.close(code=4001, reason="Invalid session token")
        return
```

### Frontend Changes

- Store token from `/create` or `/join` response
- Include token in WebSocket URL query params
- Include token in Authorization header for REST calls

## Verification

```bash
# Run security tests
cd backend && pytest tests/test_security.py -v

# Verify WebSocket rejects missing token
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" \
  "http://localhost:8000/ws/player/ABCD/player1"
# Should fail with 4001

# Verify with valid token works
# (requires obtaining token from /join first)
```

## Security Considerations

- Tokens should be cryptographically random (current UUID is acceptable)
- Consider token expiration for long-running games
- Log authentication failures for monitoring
