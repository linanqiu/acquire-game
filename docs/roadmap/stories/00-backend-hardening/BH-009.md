# BH-009: Session Manager Tests

## Metadata
- **Epic**: Backend Hardening
- **Status**: `complete`
- **Priority**: `medium`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: None

## Context

The `session/manager.py` module handles room creation, player connections, and WebSocket management. It currently has no dedicated tests, making refactoring risky.

## Requirements

1. Add comprehensive tests for SessionManager
2. Test room lifecycle (create, join, leave, destroy)
3. Test player connection management
4. Test multi-connection support (same player, multiple devices)

## Acceptance Criteria

- [x] Tests for room creation with unique codes (5 tests)
- [x] Tests for player joining rooms (8 tests)
- [x] Tests for player leaving/disconnecting (4 tests)
- [x] Tests for room destruction (2 tests)
- [x] Tests for multi-connection per player (4 tests)
- [x] Tests for host connection management (5 tests)
- [x] Tests for room code generation uniqueness
- [x] Tests for connection cleanup (5 async tests)
- [x] All tests pass (43 tests)

## Implementation Notes

### Test Structure

```python
# backend/tests/test_session_manager.py
import pytest
from unittest.mock import AsyncMock, MagicMock
from session.manager import SessionManager, Room, Player


class TestRoomCreation:
    """Tests for room creation."""

    def test_create_room_returns_code(self):
        """Creating room returns 4-letter code."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        assert len(code) == 4
        assert code.isalpha()
        assert code.isupper()

    def test_create_room_stores_room(self):
        """Created room is stored and retrievable."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        room = manager.get_room(code)
        assert room is not None
        assert room.host_id == "host_1"

    def test_create_multiple_rooms_unique_codes(self):
        """Multiple rooms get unique codes."""
        manager = SessionManager()
        codes = set()

        for i in range(100):
            code = manager.create_room(f"host_{i}", f"Player{i}")
            codes.add(code)

        assert len(codes) == 100  # All unique

    def test_room_has_host_as_player(self):
        """Room creator is added as a player."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        room = manager.get_room(code)
        assert "host_1" in room.players
        assert room.players["host_1"].name == "Alice"


class TestPlayerJoining:
    """Tests for players joining rooms."""

    def test_player_can_join_room(self):
        """Player can join existing room."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        result = manager.join_room(code, "player_2", "Bob")

        assert result is True
        room = manager.get_room(code)
        assert "player_2" in room.players

    def test_join_nonexistent_room_fails(self):
        """Joining nonexistent room fails."""
        manager = SessionManager()

        result = manager.join_room("XXXX", "player_1", "Bob")

        assert result is False

    def test_join_started_game_fails(self):
        """Cannot join room after game started."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")
        manager.join_room(code, "p2", "Bob")
        manager.join_room(code, "p3", "Carol")

        room = manager.get_room(code)
        room.started = True

        result = manager.join_room(code, "player_4", "Dave")
        assert result is False

    def test_rejoin_same_player_id(self):
        """Same player ID rejoining updates connection."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")
        manager.join_room(code, "player_2", "Bob")

        # Rejoin with same ID
        result = manager.join_room(code, "player_2", "Bob")
        assert result is True


class TestPlayerLeaving:
    """Tests for players leaving/disconnecting."""

    def test_player_disconnect_tracked(self):
        """Disconnected player is tracked but not removed."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")
        manager.join_room(code, "player_2", "Bob")

        manager.disconnect_player(code, "player_2")

        room = manager.get_room(code)
        assert "player_2" in room.players  # Still in room
        assert room.players["player_2"].connected is False

    def test_host_disconnect_transfers_host(self):
        """When host disconnects, another player becomes host."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")
        manager.join_room(code, "player_2", "Bob")

        manager.disconnect_player(code, "host_1")

        room = manager.get_room(code)
        # Implementation specific: may transfer or mark disconnected


class TestMultipleConnections:
    """Tests for multiple connections per player."""

    def test_player_can_have_multiple_connections(self):
        """Same player can connect from multiple devices."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        ws1 = MagicMock()
        ws2 = MagicMock()

        manager.add_connection(code, "host_1", ws1)
        manager.add_connection(code, "host_1", ws2)

        connections = manager.get_player_connections(code, "host_1")
        assert len(connections) == 2

    def test_remove_one_connection_keeps_others(self):
        """Removing one connection doesn't affect others."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        ws1 = MagicMock()
        ws2 = MagicMock()

        manager.add_connection(code, "host_1", ws1)
        manager.add_connection(code, "host_1", ws2)
        manager.remove_connection(code, "host_1", ws1)

        connections = manager.get_player_connections(code, "host_1")
        assert len(connections) == 1
        assert ws2 in connections


class TestRoomDestruction:
    """Tests for room cleanup."""

    def test_empty_room_can_be_destroyed(self):
        """Room with no connected players can be destroyed."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        manager.destroy_room(code)

        assert manager.get_room(code) is None

    def test_destroy_nonexistent_room_no_error(self):
        """Destroying nonexistent room doesn't raise."""
        manager = SessionManager()
        manager.destroy_room("XXXX")  # Should not raise


class TestBotPlayers:
    """Tests for bot player management."""

    def test_add_bot_to_room(self):
        """Can add bot player to room."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        manager.add_bot(code, "bot_1", "Bot Easy", difficulty="easy")

        room = manager.get_room(code)
        assert "bot_1" in room.players
        assert room.players["bot_1"].is_bot is True

    def test_bot_counts_toward_player_limit(self):
        """Bots count toward maximum player limit."""
        manager = SessionManager()
        code = manager.create_room("host_1", "Alice")

        # Add 5 more (bots + players) to reach 6 limit
        for i in range(5):
            manager.add_bot(code, f"bot_{i}", f"Bot{i}")

        # 7th should fail
        result = manager.add_bot(code, "bot_extra", "Extra")
        assert result is False
```

### Files to Create

1. `backend/tests/test_session_manager.py` - All session manager tests

## Verification

```bash
cd backend

# Run session manager tests
pytest tests/test_session_manager.py -v

# Run with coverage
pytest tests/test_session_manager.py --cov=session --cov-report=term-missing

# Run full test suite
pytest -v
```

## Reference

- [Session manager implementation](../../backend/session/manager.py)
