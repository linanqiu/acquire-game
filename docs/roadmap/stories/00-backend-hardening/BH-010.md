# BH-010: Action Module Tests

## Metadata
- **Epic**: Backend Hardening
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: None

## Context

The `game/action.py` module (233 lines) provides unified action representation for game moves. It's used for RL training and bot decision making but has no dedicated tests.

## Requirements

1. Add comprehensive tests for the Action class
2. Test all action types (place, found, buy, sell, trade, keep)
3. Test action encoding/decoding
4. Test action equality and hashing
5. Test action validation

## Acceptance Criteria

- [ ] Tests for all ActionType enum values
- [ ] Tests for Action creation with various parameters
- [ ] Tests for action equality (`__eq__`)
- [ ] Tests for action hashing (`__hash__`)
- [ ] Tests for action serialization (to_dict, from_dict)
- [ ] Tests for action string representation
- [ ] Tests for invalid action construction
- [ ] All tests pass

## Implementation Notes

### Test Structure

```python
# backend/tests/test_action.py
import pytest
from game.action import Action, ActionType


class TestActionCreation:
    """Tests for creating Action objects."""

    def test_create_place_tile_action(self):
        """Can create tile placement action."""
        action = Action(
            type=ActionType.PLACE_TILE,
            tile="5C",
        )

        assert action.type == ActionType.PLACE_TILE
        assert action.tile == "5C"

    def test_create_found_chain_action(self):
        """Can create chain founding action."""
        action = Action(
            type=ActionType.FOUND_CHAIN,
            chain="American",
        )

        assert action.type == ActionType.FOUND_CHAIN
        assert action.chain == "American"

    def test_create_buy_stocks_action(self):
        """Can create stock buying action."""
        action = Action(
            type=ActionType.BUY_STOCKS,
            purchases={"American": 2, "Luxor": 1},
        )

        assert action.type == ActionType.BUY_STOCKS
        assert action.purchases == {"American": 2, "Luxor": 1}

    def test_create_merger_disposition_action(self):
        """Can create merger disposition action."""
        action = Action(
            type=ActionType.STOCK_DISPOSITION,
            sell=2,
            trade=4,
            keep=1,
        )

        assert action.type == ActionType.STOCK_DISPOSITION
        assert action.sell == 2
        assert action.trade == 4
        assert action.keep == 1

    def test_create_end_turn_action(self):
        """Can create end turn action."""
        action = Action(type=ActionType.END_TURN)

        assert action.type == ActionType.END_TURN

    def test_create_choose_survivor_action(self):
        """Can create merger survivor choice action."""
        action = Action(
            type=ActionType.CHOOSE_SURVIVOR,
            chain="Tower",
        )

        assert action.type == ActionType.CHOOSE_SURVIVOR


class TestActionEquality:
    """Tests for action equality comparison."""

    def test_identical_actions_equal(self):
        """Two actions with same values are equal."""
        a1 = Action(type=ActionType.PLACE_TILE, tile="5C")
        a2 = Action(type=ActionType.PLACE_TILE, tile="5C")

        assert a1 == a2

    def test_different_tiles_not_equal(self):
        """Actions with different tiles are not equal."""
        a1 = Action(type=ActionType.PLACE_TILE, tile="5C")
        a2 = Action(type=ActionType.PLACE_TILE, tile="6D")

        assert a1 != a2

    def test_different_types_not_equal(self):
        """Actions of different types are not equal."""
        a1 = Action(type=ActionType.PLACE_TILE, tile="5C")
        a2 = Action(type=ActionType.FOUND_CHAIN, chain="American")

        assert a1 != a2

    def test_action_not_equal_to_none(self):
        """Action is not equal to None."""
        action = Action(type=ActionType.END_TURN)

        assert action != None
        assert action is not None


class TestActionHashing:
    """Tests for action hashing (for use in sets/dicts)."""

    def test_equal_actions_same_hash(self):
        """Equal actions have same hash."""
        a1 = Action(type=ActionType.PLACE_TILE, tile="5C")
        a2 = Action(type=ActionType.PLACE_TILE, tile="5C")

        assert hash(a1) == hash(a2)

    def test_actions_usable_in_set(self):
        """Actions can be used in sets."""
        a1 = Action(type=ActionType.PLACE_TILE, tile="5C")
        a2 = Action(type=ActionType.PLACE_TILE, tile="5C")
        a3 = Action(type=ActionType.PLACE_TILE, tile="6D")

        action_set = {a1, a2, a3}

        assert len(action_set) == 2  # a1 and a2 are duplicates

    def test_actions_usable_as_dict_key(self):
        """Actions can be used as dictionary keys."""
        action = Action(type=ActionType.PLACE_TILE, tile="5C")

        action_dict = {action: "value"}

        assert action_dict[action] == "value"


class TestActionSerialization:
    """Tests for action serialization."""

    def test_to_dict_place_tile(self):
        """Place tile action serializes correctly."""
        action = Action(type=ActionType.PLACE_TILE, tile="5C")

        d = action.to_dict()

        assert d["type"] == "place_tile"
        assert d["tile"] == "5C"

    def test_to_dict_buy_stocks(self):
        """Buy stocks action serializes correctly."""
        action = Action(
            type=ActionType.BUY_STOCKS,
            purchases={"American": 2},
        )

        d = action.to_dict()

        assert d["type"] == "buy_stocks"
        assert d["purchases"] == {"American": 2}

    def test_from_dict_round_trip(self):
        """Action survives to_dict/from_dict round trip."""
        original = Action(
            type=ActionType.STOCK_DISPOSITION,
            sell=1,
            trade=2,
            keep=3,
        )

        serialized = original.to_dict()
        restored = Action.from_dict(serialized)

        assert restored == original


class TestActionStringRepresentation:
    """Tests for action string representation."""

    def test_place_tile_str(self):
        """Place tile action has readable string."""
        action = Action(type=ActionType.PLACE_TILE, tile="5C")

        s = str(action)

        assert "5C" in s
        assert "place" in s.lower() or "tile" in s.lower()

    def test_buy_stocks_str(self):
        """Buy stocks action has readable string."""
        action = Action(
            type=ActionType.BUY_STOCKS,
            purchases={"American": 2, "Luxor": 1},
        )

        s = str(action)

        assert "American" in s or "buy" in s.lower()


class TestActionValidation:
    """Tests for action validation."""

    def test_place_tile_requires_tile(self):
        """Place tile action requires tile parameter."""
        with pytest.raises((ValueError, TypeError)):
            Action(type=ActionType.PLACE_TILE)  # Missing tile

    def test_found_chain_requires_chain(self):
        """Found chain action requires chain parameter."""
        with pytest.raises((ValueError, TypeError)):
            Action(type=ActionType.FOUND_CHAIN)  # Missing chain

    def test_disposition_values_non_negative(self):
        """Disposition values must be non-negative."""
        with pytest.raises(ValueError):
            Action(
                type=ActionType.STOCK_DISPOSITION,
                sell=-1,
                trade=0,
                keep=0,
            )
```

### Files to Create

1. `backend/tests/test_action.py` - All action module tests

## Verification

```bash
cd backend

# Run action tests
pytest tests/test_action.py -v

# Run with coverage
pytest tests/test_action.py --cov=game.action --cov-report=term-missing

# Run full test suite
pytest -v
```

## Reference

- [Action module implementation](../../backend/game/action.py)
