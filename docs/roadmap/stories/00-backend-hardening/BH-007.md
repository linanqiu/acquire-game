# BH-007: Complex Merger Scenario Tests

## Metadata
- **Epic**: Backend Hardening
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: None

## Context

Existing merger tests cover basic scenarios but miss edge cases:
- Three-way (or more) mergers
- Tied majority/minority stockholders
- Sequential mergers within a turn
- Mergers with no stockholders in defunct chain
- Stock disposition with chain stock exhausted

These edge cases are critical for game correctness.

## Requirements

1. Add comprehensive merger edge case tests
2. Cover all stockholder bonus tie scenarios
3. Test sequential merger handling
4. Test edge cases with empty stockholdings

## Acceptance Criteria

- [ ] Tests for 3-way merger scenarios
- [ ] Tests for 4-way merger (rare but possible)
- [ ] Tests for tied majority stockholders (2, 3, 4 players)
- [ ] Tests for tied minority stockholders
- [ ] Tests for sequential mergers (merger triggers another merger)
- [ ] Tests for merger with no stockholders
- [ ] Tests for stock disposition when chain has no available stock to trade into
- [ ] All new tests pass
- [ ] Existing tests still pass

## Implementation Notes

### Test File Structure

```python
# backend/tests/scenarios/test_complex_mergers.py

class TestThreeWayMerger:
    """Tests for mergers involving 3 chains."""

    def test_three_way_merger_largest_survives(self):
        """When three chains merge, largest survives."""
        pass

    def test_three_way_merger_tie_two_largest(self):
        """When two of three chains tie for largest, player chooses."""
        pass

    def test_three_way_merger_all_equal(self):
        """When all three chains equal size, player chooses."""
        pass

    def test_three_way_defunct_order(self):
        """Defunct chains process in descending size order."""
        pass


class TestStockholderTies:
    """Tests for tie scenarios in majority/minority bonuses."""

    def test_two_way_majority_tie(self):
        """Two players tie for majority: split majority+minority bonus."""
        pass

    def test_three_way_majority_tie(self):
        """Three players tie: split majority+minority three ways."""
        pass

    def test_majority_with_minority_tie(self):
        """One majority holder, two tied for minority."""
        pass

    def test_all_players_tied(self):
        """All 4 players have equal stock."""
        pass

    def test_no_minority_holder(self):
        """Majority holder owns ALL stock - gets both bonuses."""
        pass


class TestSequentialMergers:
    """Tests for mergers that trigger additional mergers."""

    def test_merger_creates_second_merger(self):
        """Placing tile merges A+B, result touches C creating A+C merger."""
        pass

    def test_merger_chain_continues_after_defunct(self):
        """After disposing defunct stock, game handles next defunct."""
        pass


class TestNoStockholdersInDefunct:
    """Tests for mergers where no one holds defunct stock."""

    def test_no_stockholders_no_bonus(self):
        """If no one holds defunct stock, no bonus paid."""
        pass

    def test_skip_disposition_for_zero_stock_players(self):
        """Players with 0 defunct stock skip disposition."""
        pass


class TestStockExhaustion:
    """Tests for disposition when survivor has no stock available."""

    def test_trade_blocked_no_survivor_stock(self):
        """Cannot trade when survivor has 0 available stock."""
        pass

    def test_partial_trade_limited_stock(self):
        """Can only trade up to available survivor stock."""
        pass
```

### Key Scenarios to Test

#### Three-Way Merger Setup
```python
def setup_three_way_merger(game):
    """
    Create board state where one tile merges three chains:

        . . A A A
        . T . . .   <- Tile T merges American (A), Luxor (L), Tower (W)
        . . L L L
        . . W W W
    """
    # Place tiles to create three separate chains
    # Then return the tile that would merge all three
```

#### Stockholder Tie Setup
```python
def setup_majority_tie(game, players, chain, shares_each):
    """Give multiple players equal shares for majority tie."""
    for player_id in players:
        game._players[player_id].stocks[chain] = shares_each
```

### Files to Create

1. `backend/tests/scenarios/test_complex_mergers.py` - All complex merger tests

## Verification

```bash
cd backend

# Run new complex merger tests
pytest tests/scenarios/test_complex_mergers.py -v

# Run all merger-related tests
pytest -k "merger" -v

# Run full test suite
pytest -v

# Check coverage on merger logic
pytest --cov=game.rules --cov=game.game --cov-report=html -k "merger"
```

## Reference

- [Game rules - mergers](../../docs/rules/mergers.md)
- [Existing merger tests](../../backend/tests/scenarios/test_mergers.py)
- [Rules.py merger logic](../../backend/game/rules.py)
