# BH-002: Remove Bot Turn Duplication

## Metadata
- **Epic**: Backend Hardening
- **Status**: `complete`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: BH-001

> **Note**: This story was completed as part of BH-001. The `process_bot_turns()` function was refactored to use `Game.execute_bot_turn()`, eliminating all duplicated bot turn logic.

## Context

Lines ~1429-1575 in `main.py` duplicate tile placement, chain founding, and merger logic from `game.py`. This creates maintenance burden - bugs fixed in one place may not be fixed in the other.

## Requirements

1. Replace duplicated bot turn logic with calls to `Game` class methods
2. Maintain same bot behavior (timing, decision making)
3. Ensure bot turns still trigger proper broadcasts

## Acceptance Criteria

- [x] `process_bot_turn()` calls `Game.play_tile()`, `Game.found_chain()`, etc.
- [x] No tile placement logic duplicated in `main.py`
- [x] No chain founding logic duplicated in `main.py`
- [x] No merger handling logic duplicated in `main.py`
- [x] Bot games complete successfully (test with `test_bot_games.py`)
- [x] All existing tests pass

## Implementation Notes

### Current Duplication (to remove)

```python
# main.py - process_bot_turn() currently has:
# 1. Tile placement logic (~50 lines)
# 2. Chain founding logic (~30 lines)
# 3. Merger survivor selection (~40 lines)
# 4. Stock disposition (~30 lines)
```

### Target Implementation

```python
async def process_bot_turn(room: Room, bot_id: str):
    """Process a bot's turn using Game class methods."""
    game = room.game
    bot = get_bot_instance(room.players[bot_id])

    # Get bot's action decision
    action = bot.choose_action(game, bot_id)

    # Execute through Game class
    if action.type == ActionType.PLACE_TILE:
        result = game.play_tile(bot_id, action.tile)

        if result.requires_founding:
            chain = bot.choose_chain_to_found(game, result.available_chains)
            game.found_chain(bot_id, chain)

        elif result.requires_merger_choice:
            survivor = bot.choose_merger_survivor(game, result.tied_chains)
            game.choose_merger_survivor(bot_id, survivor)

    elif action.type == ActionType.STOCK_DISPOSITION:
        disposition = bot.choose_stock_disposition(game, action.defunct_chain)
        game.submit_stock_disposition(bot_id, disposition)

    elif action.type == ActionType.BUY_STOCKS:
        purchases = bot.choose_stocks_to_buy(game)
        game.buy_stocks(bot_id, purchases)

    # Broadcast updated state
    await broadcast_game_state(room)

    # Continue if still bot's turn
    if game.current_player == bot_id and not game.is_game_over():
        await asyncio.sleep(BOT_DELAY)
        await process_bot_turn(room, bot_id)
```

### Files to Modify

1. `backend/main.py` - Rewrite `process_bot_turn()` (~150 lines â†’ ~50 lines)

## Verification

```bash
cd backend

# Run bot game tests
pytest tests/test_bot_games.py -v

# Run full test suite
pytest -v

# Manual test: Start a game with bots and verify turns work
python -c "
from game.game import Game
from game.bot import Bot

game = Game()
game.add_player('bot1', 'Bot1', is_bot=True)
game.add_player('bot2', 'Bot2', is_bot=True)
game.add_player('bot3', 'Bot3', is_bot=True)
game.start_game()

bot = Bot('hard')
while not game.is_game_over():
    player = game.current_player
    action = bot.choose_action(game, player)
    # Execute action...

print('Game completed successfully')
"
```

## Reference

- [Bot class](../../backend/game/bot.py)
- [Game class methods](../../backend/game/game.py)
