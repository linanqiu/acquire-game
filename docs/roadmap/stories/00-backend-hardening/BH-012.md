# BH-012: Phase Transition Tests

## Metadata
- **Epic**: Backend Hardening
- **Status**: `complete`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: BH-001

## Context

The game has multiple phases (LOBBY, PLACE_TILE, FOUNDING_CHAIN, MERGING, STOCK_DISPOSITION, BUY_STOCKS, GAME_OVER). Transitions between phases must follow specific rules. Invalid transitions could corrupt game state.

## Requirements

1. Add tests for all valid phase transitions
2. Add tests verifying invalid transitions are rejected
3. Test complex transition sequences (merger flows)
4. Test edge cases in phase transitions

## Acceptance Criteria

- [x] Tests for all valid transitions (7 tests)
- [x] Tests verify invalid transitions raise exceptions (5 tests)
- [x] Tests for complete turn cycle (PLAYING → BUYING_STOCKS → PLAYING)
- [x] Tests for merger flow (PLAYING → MERGING → BUYING_STOCKS)
- [x] Tests for founding flow (PLAYING → FOUNDING_CHAIN → BUYING_STOCKS)
- [x] Tests for game end transitions (2 tests)
- [x] Tests for phase state consistency (3 tests)
- [x] All tests pass (19 tests)

## Implementation Notes

### Valid Phase Transitions

```
LOBBY
  └─→ PLACE_TILE (game start)

PLACE_TILE
  ├─→ FOUNDING_CHAIN (tile creates new chain opportunity)
  ├─→ MERGING (tile merges chains)
  ├─→ BUY_STOCKS (normal tile, no special action)
  └─→ GAME_OVER (player declares end or auto-end)

FOUNDING_CHAIN
  └─→ BUY_STOCKS (after chain chosen)

MERGING
  ├─→ STOCK_DISPOSITION (proceed to disposition)
  └─→ BUY_STOCKS (no stockholders need to dispose)

STOCK_DISPOSITION
  ├─→ STOCK_DISPOSITION (next player in queue)
  └─→ BUY_STOCKS (all players done disposing)

BUY_STOCKS
  ├─→ PLACE_TILE (next player's turn)
  └─→ GAME_OVER (end conditions met)
```

### Test Structure

```python
# backend/tests/test_phase_transitions.py
import pytest
from game.game import Game, GamePhase
from game.board import Tile


class TestValidTransitions:
    """Tests for valid phase transitions."""

    def test_lobby_to_place_tile(self):
        """Game transitions from LOBBY to PLACE_TILE on start."""
        game = Game()
        game.add_player("p1", "Alice")
        game.add_player("p2", "Bob")
        game.add_player("p3", "Carol")

        assert game.phase == GamePhase.LOBBY

        game.start_game()

        assert game.phase == GamePhase.PLACE_TILE

    def test_place_tile_to_buy_stocks(self):
        """Normal tile placement leads to BUY_STOCKS."""
        game = self._setup_game_in_progress()
        assert game.phase == GamePhase.PLACE_TILE

        # Place a tile that doesn't found or merge
        tile = self._get_normal_tile(game)
        game.play_tile(game.current_player, tile)

        assert game.phase == GamePhase.BUY_STOCKS

    def test_place_tile_to_founding(self):
        """Tile that could found leads to FOUNDING_CHAIN."""
        game = self._setup_game_with_founding_opportunity()
        assert game.phase == GamePhase.PLACE_TILE

        tile = self._get_founding_tile(game)
        game.play_tile(game.current_player, tile)

        assert game.phase == GamePhase.FOUNDING_CHAIN

    def test_founding_to_buy_stocks(self):
        """Choosing chain leads to BUY_STOCKS."""
        game = self._setup_game_in_founding_phase()
        assert game.phase == GamePhase.FOUNDING_CHAIN

        game.found_chain(game.current_player, "American")

        assert game.phase == GamePhase.BUY_STOCKS

    def test_place_tile_to_merging(self):
        """Tile that merges chains leads to MERGING."""
        game = self._setup_game_with_merger_opportunity()
        assert game.phase == GamePhase.PLACE_TILE

        tile = self._get_merger_tile(game)
        game.play_tile(game.current_player, tile)

        assert game.phase == GamePhase.MERGING

    def test_merging_to_disposition(self):
        """After survivor chosen, proceed to STOCK_DISPOSITION."""
        game = self._setup_game_in_merging_phase()
        assert game.phase == GamePhase.MERGING

        game.choose_merger_survivor(game.current_player, "American")

        assert game.phase == GamePhase.STOCK_DISPOSITION

    def test_disposition_to_disposition(self):
        """Multiple players disposing in sequence."""
        game = self._setup_game_with_multiple_stockholders()
        assert game.phase == GamePhase.STOCK_DISPOSITION

        # First player disposes
        game.submit_stock_disposition(
            game.current_player,
            sell=1, trade=0, keep=1
        )

        # Still in disposition for next player
        assert game.phase == GamePhase.STOCK_DISPOSITION

    def test_disposition_to_buy_stocks(self):
        """Last player disposing leads to BUY_STOCKS."""
        game = self._setup_game_last_disposition()
        assert game.phase == GamePhase.STOCK_DISPOSITION

        game.submit_stock_disposition(
            game.current_player,
            sell=2, trade=0, keep=0
        )

        assert game.phase == GamePhase.BUY_STOCKS

    def test_buy_stocks_to_place_tile(self):
        """After buying stocks, next player's PLACE_TILE."""
        game = self._setup_game_in_buy_stocks()
        current = game.current_player

        game.buy_stocks(current, {"American": 1})
        game.end_turn(current)

        assert game.phase == GamePhase.PLACE_TILE
        assert game.current_player != current


class TestInvalidTransitions:
    """Tests for invalid phase transitions."""

    def test_cannot_start_started_game(self):
        """Cannot call start_game twice."""
        game = self._setup_game_in_progress()

        with pytest.raises(ValueError):
            game.start_game()

    def test_cannot_place_tile_in_lobby(self):
        """Cannot place tile before game starts."""
        game = Game()
        game.add_player("p1", "Alice")
        game.add_player("p2", "Bob")
        game.add_player("p3", "Carol")

        with pytest.raises(ValueError):
            game.play_tile("p1", Tile(1, 'A'))

    def test_cannot_found_in_place_tile_phase(self):
        """Cannot choose chain when not in FOUNDING phase."""
        game = self._setup_game_in_progress()
        assert game.phase == GamePhase.PLACE_TILE

        with pytest.raises(ValueError):
            game.found_chain(game.current_player, "American")

    def test_cannot_buy_stocks_in_place_tile_phase(self):
        """Cannot buy stocks before placing tile."""
        game = self._setup_game_in_progress()
        assert game.phase == GamePhase.PLACE_TILE

        with pytest.raises(ValueError):
            game.buy_stocks(game.current_player, {"American": 1})


class TestComplexFlows:
    """Tests for complete game flows."""

    def test_full_turn_cycle(self):
        """Complete turn: PLACE_TILE → BUY_STOCKS → PLACE_TILE."""
        game = self._setup_game_in_progress()
        p1 = game.current_player

        # Place tile
        tile = game._players[p1].tiles[0]
        game.play_tile(p1, tile)

        # Buy stocks
        if game.phase == GamePhase.BUY_STOCKS:
            game.buy_stocks(p1, {})
            game.end_turn(p1)

        # Next player's turn
        assert game.phase == GamePhase.PLACE_TILE
        assert game.current_player != p1

    def test_merger_flow_complete(self):
        """Complete merger: PLACE_TILE → MERGING → DISPOSITION → BUY_STOCKS."""
        game = self._setup_complex_merger_scenario()

        # This would require detailed setup of a merger situation
        # and walking through the entire flow
        pass

    def test_founding_flow_complete(self):
        """Complete founding: PLACE_TILE → FOUNDING_CHAIN → BUY_STOCKS."""
        game = self._setup_founding_scenario()

        # Place founding tile
        # Choose chain
        # Buy stocks
        # End turn
        pass


class TestEdgeCases:
    """Tests for edge cases in transitions."""

    def test_merger_with_no_stockholders_skips_disposition(self):
        """Merger where no one holds defunct stock skips disposition."""
        pass

    def test_end_game_from_place_tile(self):
        """Game can end during tile placement (conditions met)."""
        pass

    def test_end_game_from_buy_stocks(self):
        """Game can end after buying stocks."""
        pass

    # Helper methods
    def _setup_game_in_progress(self) -> Game:
        game = Game()
        game.add_player("p1", "Alice")
        game.add_player("p2", "Bob")
        game.add_player("p3", "Carol")
        game.start_game()
        return game

    # ... more helpers ...
```

### Files to Create

1. `backend/tests/test_phase_transitions.py` - All phase transition tests

## Verification

```bash
cd backend

# Run phase transition tests
pytest tests/test_phase_transitions.py -v

# Run full test suite
pytest -v

# Check coverage on game phase handling
pytest --cov=game.game --cov-report=html tests/test_phase_transitions.py
```

## Reference

- [Game phases](../../backend/game/game.py)
- [Phase transition logic](../../backend/game/game.py)
