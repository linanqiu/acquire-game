# BL-006: Fix 8th Chain Crash - Display Unplayable Tiles

## Metadata
- **Epic**: Backlog
- **Status**: `completed`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: None

## Context

When all 7 hotel chains are active on the board, playing a tile that would found an 8th chain should be blocked. The backend correctly calculates tile playability and returns this information in the `tile_playability` field of the game state, but the frontend ignores this data and allows players to select any tile.

When a player attempts to place such a tile:
1. The backend validation returns `success: false` with "Tile cannot be placed"
2. But the UI doesn't prevent the selection or show clear feedback about WHY the tile can't be played
3. This creates a confusing user experience where tiles appear playable but fail when placed

**Root Causes:**
1. `GameStateMessage` type in `frontend/src/types/api.ts` doesn't include `tile_playability` field
2. `gameStore.ts` doesn't store or forward `tile_playability` data
3. `PlayerPage.tsx` calls `transformHandToRackTiles(yourHand)` without a playability map, so ALL tiles default to 'playable'
4. `TileRack` component can show playability states (`temp_unplayable`, `perm_unplayable`) but never receives them

## Requirements

1. Add `tile_playability` field to frontend types
2. Store and forward tile playability data through the game store
3. Transform backend playability format to frontend `Playability` type
4. Display unplayable tiles with correct visual states:
   - `temp_unplayable` (disabled): Tiles that would merge 2+ safe chains
   - `perm_unplayable` (dead): Tiles that would create an 8th chain
5. Show error messages when players try to place unplayable tiles

## Acceptance Criteria

- [x] Tiles that would create an 8th chain are visually marked as unplayable (dead/gray)
- [x] Tiles that would merge safe chains are marked as temporarily unplayable (disabled)
- [x] Unplayable tiles cannot be selected in the tile rack
- [x] User-friendly error message appears if somehow an unplayable tile placement is attempted
- [x] Backend tests for 8th chain scenario pass
- [ ] Manual testing confirms tiles show correct playability states

## Implementation Notes

### Backend (verification only - already implemented)
The backend already sends `tile_playability` in `game.get_player_state()` at line 1526 in `backend/game/game.py`:
```python
"tile_playability": tile_playability,
```

Format:
```json
{
  "5A": {"playable": true, "reason": null, "permanent": null, "would_trigger_merger": false},
  "2G": {"playable": false, "reason": "would_create_eighth_chain", "permanent": true, "would_trigger_merger": false}
}
```

### Frontend Changes

1. **Types** (`frontend/src/types/api.ts`):
```typescript
interface TilePlayabilityInfo {
  playable: boolean
  reason: 'would_merge_safe_chains' | 'would_create_eighth_chain' | null
  permanent: boolean | null
  would_trigger_merger: boolean
}

// Add to GameStateMessage:
tile_playability?: Record<string, TilePlayabilityInfo>
```

2. **Store** (`frontend/src/store/gameStore.ts`):
- Add `tilePlayability` state
- Update `handleMessage` to extract tile_playability from game_state

3. **Transform** (`frontend/src/utils/transforms.ts`):
- Update `transformHandToRackTiles` to convert backend playability to frontend `Playability` type:
  - `playable: true` → 'playable' or 'merger' (if `would_trigger_merger`)
  - `reason: 'would_merge_safe_chains'` → 'temp_unplayable'
  - `reason: 'would_create_eighth_chain'` → 'perm_unplayable'

4. **PlayerPage** (`frontend/src/pages/PlayerPage.tsx`):
- Pass tile_playability to transformHandToRackTiles

### Files to Modify
- `frontend/src/types/api.ts` - Add TilePlayabilityInfo type
- `frontend/src/store/gameStore.ts` - Store tile_playability
- `frontend/src/utils/transforms.ts` - Transform playability data
- `frontend/src/pages/PlayerPage.tsx` - Use tile_playability when creating rack tiles

## Verification

```bash
# Run existing backend tests for 8th chain
cd backend && python -m pytest tests/scenarios/test_tile_placement.py -v -k "eighth_chain or playability"

# Run frontend component tests
cd frontend && npm test -- --testPathPattern="TileRack"

# Manual testing
# 1. Start a game with 3 players
# 2. Manually set up 7 chains using dev tools or scenario
# 3. Verify tiles that would found 8th chain appear grayed out
# 4. Verify clicking on unplayable tiles does nothing
```
