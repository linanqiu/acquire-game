# ST-003: Trading E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: ST-001

## Context

Implement scenarios 2.1-2.18 (Trading) as E2E tests. Trading includes both P2P trading between players and merger 2:1 trades. This is a larger effort due to the complexity of multi-player interactions.

## Requirements

Implement the following scenarios from the test matrix:

### P2P Trading (2.1-2.9)

| ID | Scenario | Description |
|----|----------|-------------|
| 2.1 | Initiate trade offer | Player opens trade builder, selects stocks |
| 2.2 | Cancel trade offer | Player cancels before sending |
| 2.3 | Accept trade offer | Recipient accepts, stocks exchanged |
| 2.4 | Reject trade offer | Recipient declines trade |
| 2.5 | Counter trade offer | Recipient modifies and sends back |
| 2.6 | Trade with insufficient stocks | Validation prevents invalid trade |
| 2.7 | Multiple simultaneous offers | Handle concurrent trade offers |
| 2.8 | Stale trade (stocks changed) | Trade invalidated by game state change |
| 2.9 | Trade timeout | Offer expires after time limit |

### Merger 2:1 Trades (2.10-2.18)

| ID | Scenario | Description |
|----|----------|-------------|
| 2.10 | Basic 2:1 trade | Trade 2 defunct for 1 survivor |
| 2.11 | Maximum 2:1 trade | Trade all defunct stock |
| 2.12 | Partial 2:1 trade | Trade some, keep rest |
| 2.13 | No 2:1 trade available | Survivor has no stock |
| 2.14 | Odd number of defunct stock | Can't trade 1 remaining stock |
| 2.15 | 2:1 with sell combination | Trade some, sell some |
| 2.16 | 2:1 with hold combination | Trade some, hold some |
| 2.17 | 2:1 depletes survivor pool | Pool runs out during trades |
| 2.18 | 2:1 in multi-chain merger | Sequential 2:1 for each defunct |

## Acceptance Criteria

- [ ] All 18 trading scenarios have passing tests
- [ ] P2P trading tests verify both parties see correct UI
- [ ] Merger 2:1 tests verify stock disposition UI
- [ ] Screenshots capture trade offer UI, confirmation dialogs, post-trade holdings
- [ ] Tests handle multi-player WebSocket coordination

## Test Rigor Requirements (MANDATORY)

See [Epic 07 Test Rigor Standards](../../epics/07-scenario-tests.md#test-rigor-standards-mandatory) for full details.

### Minimum Requirements for This Story

| Scenario Type | Requirement |
|---------------|-------------|
| P2P Trading (2.1-2.9) | Complete at least 3 full trade cycles per test |
| Merger 2:1 (2.10-2.18) | Loop until a merger actually occurs, then test disposition |

### Screenshots Required Per Test

- `initial-state` - Game state before trading
- `trade-builder-open` - Trade UI visible
- `trade-configured` - Offer set up
- `trade-sent` - Offer submitted
- `recipient-sees-offer` - Other player's view
- `trade-accepted/rejected` - Resolution
- `post-trade-holdings` - Updated stocks for both players
- `merger-triggered` - For 2:1 tests
- `disposition-ui` - Stock disposition options
- `disposition-submitted` - After decision
- `final-state` - End of test

### Don't Terminate Early

If a merger doesn't occur within reasonable turns, **loop until it does**. Don't assume a specific turn will trigger a merger. If mergers never happen with the current seed, try a different seed or report the issue.

### Determinism

Use `ACQUIRE_GAME_SEED` for reproducible merger scenarios. Document which seed reliably produces mergers for these tests.

## Implementation Notes

### Key Test File

**frontend/tests/e2e/scenarios/trading.spec.ts**:
```typescript
import { test, expect, Page, BrowserContext } from '@playwright/test'
import { captureStep, resetStepCounter } from './helpers/screenshot'
import { createGame, startGame } from './helpers/game-setup'

const CATEGORY = 'trading'

test.describe('Trading Scenarios (2.x)', () => {
  test.beforeEach(() => {
    resetStepCounter()
  })

  test.describe('P2P Trading', () => {
    test('2.1: Initiate trade offer', async ({ page, request, context }) => {
      const testName = 'scenario-2.1-initiate-trade'

      // Setup game
      const game = await createGame(request, {
        hostName: 'Trader1',
        playerNames: ['Trader2', 'Trader3']
      })
      await startGame(request, game.roomCode, game.hostSessionToken)

      // Open two browser contexts for two players
      const page2 = await context.newPage()

      // Player 1 view
      await page.goto(`/play/${game.roomCode}`)
      await captureStep(page, 'player1-initial', { category: CATEGORY, testName })

      // Player 2 view
      await page2.goto(`/play/${game.roomCode}`)

      // Player 1 opens trade builder
      await page.locator('[data-testid="trade-button"]').click()
      await expect(page.locator('[data-testid="trade-builder"]')).toBeVisible()
      await captureStep(page, 'trade-builder-open', { category: CATEGORY, testName })

      // Select recipient
      await page.locator('[data-testid="trade-recipient-Trader2"]').click()

      // Select stocks to offer
      await page.locator('[data-testid="offer-stock-tower"]').click()
      await captureStep(page, 'trade-configured', { category: CATEGORY, testName })

      await page2.close()
    })

    test('2.3: Accept trade offer', async ({ page, request, context }) => {
      const testName = 'scenario-2.3-accept-trade'

      // ... similar setup with two pages
      // Player 1 sends offer
      // Player 2 sees offer notification
      // Player 2 accepts
      // Both players see updated holdings
    })
  })

  test.describe('Merger 2:1 Trades', () => {
    test('2.10: Basic 2:1 trade', async ({ page, request }) => {
      const testName = 'scenario-2.10-basic-2-1-trade'

      // Setup game and trigger merger
      // Navigate to stock disposition UI
      // Configure 2:1 trade
      await captureStep(page, 'disposition-ui', { category: CATEGORY, testName })

      // Submit disposition
      await captureStep(page, 'trade-complete', { category: CATEGORY, testName })
    })
  })
})
```

### Multi-Player Test Pattern

For P2P trading tests, use multiple browser contexts:
```typescript
test('multi-player trade', async ({ browser }) => {
  const context1 = await browser.newContext()
  const context2 = await browser.newContext()
  const page1 = await context1.newPage()
  const page2 = await context2.newPage()

  // Each page represents a different player
  // Set different session tokens for each
})
```

### Screenshot Requirements

1. Trade builder UI open
2. Trade offer configured
3. Recipient sees trade notification
4. Trade confirmation dialog
5. Post-trade holdings for both parties

## Verification

```bash
# Run trading tests
cd frontend && npx playwright test tests/e2e/scenarios/trading.spec.ts

# View screenshots
ls -la test-results/scenarios/trading/

# View HTML report
npx playwright show-report
```

## Reference

- [Trading Scenarios](../../../tests/scenario-docs.md#2-trading)
- [Trade Builder Component](../../../ui/components.md#trade-builder)
