# ST-001: E2E Scenario Test Infrastructure

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `not-started`
- **Priority**: `critical`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: None

## Context

Set up the foundation for E2E scenario testing with Playwright. This infrastructure enables all subsequent scenario tests by providing helpers for screenshot capture, game seeding, and assertions.

**Philosophy:** "If there's no screenshot, it didn't happen."

## Requirements

1. Playwright test structure in `frontend/tests/e2e/scenarios/`
2. Screenshot capture helper (every significant step)
3. Test artifact directory structure: `test-results/scenarios/{category}/{test-name}/`
4. Server startup/verification helpers (ensure backend + frontend running)
5. Game state setup helpers via API (seed games, set positions)
6. Console error capture and reporting

## Acceptance Criteria

- [ ] Screenshot helper captures with timestamp and step name
- [ ] Screenshots saved to `test-results/scenarios/`
- [ ] Server health check before tests run
- [ ] Game seeding API works for reproducible tests
- [ ] Console errors captured and reported
- [ ] Basic smoke test passes with screenshots

## Implementation Notes

### Files to Create

**frontend/tests/e2e/scenarios/helpers/screenshot.ts**:
```typescript
import { Page } from '@playwright/test'
import * as path from 'path'

let stepCounter = 0

export async function captureStep(
  page: Page,
  stepName: string,
  options: { category?: string; testName?: string } = {}
): Promise<string> {
  stepCounter++
  const paddedStep = String(stepCounter).padStart(2, '0')
  const sanitizedName = stepName.toLowerCase().replace(/\s+/g, '-')

  const dir = path.join(
    'test-results',
    'scenarios',
    options.category || 'general',
    options.testName || 'test'
  )

  const filename = `${paddedStep}-${sanitizedName}.png`
  const filepath = path.join(dir, filename)

  await page.screenshot({ path: filepath, fullPage: false })
  return filepath
}

export function resetStepCounter(): void {
  stepCounter = 0
}
```

**frontend/tests/e2e/scenarios/helpers/game-setup.ts**:
```typescript
import { APIRequestContext } from '@playwright/test'

export interface GameConfig {
  hostName: string
  playerNames?: string[]
}

export interface GameSetupResult {
  roomCode: string
  hostPlayerId: string
  hostSessionToken: string
  players: Array<{
    name: string
    playerId: string
    sessionToken: string
  }>
}

export async function createGame(
  request: APIRequestContext,
  config: GameConfig
): Promise<GameSetupResult> {
  // Create game
  const createRes = await request.post('/create', {
    form: { player_name: config.hostName }
  })
  const createData = await createRes.json()

  const result: GameSetupResult = {
    roomCode: createData.room_code,
    hostPlayerId: createData.player_id,
    hostSessionToken: createData.session_token,
    players: []
  }

  // Join additional players
  for (const name of config.playerNames || []) {
    const joinRes = await request.post('/join', {
      form: { player_name: name, room_code: result.roomCode }
    })
    const joinData = await joinRes.json()
    result.players.push({
      name,
      playerId: joinData.player_id,
      sessionToken: joinData.session_token
    })
  }

  return result
}

export async function startGame(
  request: APIRequestContext,
  roomCode: string,
  hostSessionToken: string
): Promise<void> {
  await request.post(`/games/${roomCode}/start`, {
    headers: { 'X-Session-Token': hostSessionToken }
  })
}
```

**frontend/tests/e2e/scenarios/helpers/assertions.ts**:
```typescript
import { Page, expect } from '@playwright/test'

export async function assertBoardVisible(page: Page): Promise<void> {
  await expect(page.locator('[data-testid="game-board"]')).toBeVisible()
}

export async function assertPlayerMoney(
  page: Page,
  expectedAmount: number
): Promise<void> {
  const moneyDisplay = page.locator('[data-testid="player-money"]')
  await expect(moneyDisplay).toContainText(`$${expectedAmount.toLocaleString()}`)
}

export async function assertChainOnBoard(
  page: Page,
  chainName: string
): Promise<void> {
  const chainTiles = page.locator(`[data-chain="${chainName.toLowerCase()}"]`)
  await expect(chainTiles.first()).toBeVisible()
}

export async function assertNoConsoleErrors(errors: string[]): void {
  const criticalErrors = errors.filter(
    e => !e.includes('favicon') && !e.includes('404')
  )
  expect(criticalErrors).toHaveLength(0)
}
```

**frontend/tests/e2e/scenarios/smoke.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'
import { captureStep, resetStepCounter } from './helpers/screenshot'

test.describe('Scenario Test Infrastructure Smoke Test', () => {
  test.beforeEach(() => {
    resetStepCounter()
  })

  test('should capture screenshots at each step', async ({ page }) => {
    // Navigate to lobby
    await page.goto('/')
    await captureStep(page, 'lobby-loaded', {
      category: 'smoke',
      testName: 'screenshot-test'
    })

    // Verify lobby elements
    await expect(page.getByRole('heading', { name: 'ACQUIRE' })).toBeVisible()
    await captureStep(page, 'lobby-verified', {
      category: 'smoke',
      testName: 'screenshot-test'
    })
  })

  test('should capture console errors', async ({ page }) => {
    const consoleErrors: string[] = []
    page.on('console', msg => {
      if (msg.type() === 'error') {
        consoleErrors.push(msg.text())
      }
    })

    await page.goto('/')
    await page.waitForTimeout(1000) // Allow any errors to surface

    // Filter out expected errors (favicon, etc)
    const criticalErrors = consoleErrors.filter(
      e => !e.includes('favicon') && !e.includes('404')
    )
    expect(criticalErrors).toHaveLength(0)
  })
})
```

### Directory Structure

```
frontend/tests/e2e/scenarios/
├── helpers/
│   ├── screenshot.ts      # captureStep(page, stepName)
│   ├── game-setup.ts      # setupGame(config), seedTiles(), etc.
│   └── assertions.ts      # assertBoardState(), assertPlayerMoney(), etc.
├── smoke.spec.ts
├── turn-flow.spec.ts      # ST-002
├── trading.spec.ts        # ST-003
├── chain-founding.spec.ts # ST-004
├── chain-expansion.spec.ts# ST-005
├── mergers.spec.ts        # ST-006
├── stock-purchases.spec.ts# ST-007
├── end-game.spec.ts       # ST-008
└── edge-cases.spec.ts     # ST-009
```

## Verification

```bash
# Create scenarios directory
mkdir -p frontend/tests/e2e/scenarios/helpers

# Run smoke test
cd frontend && npx playwright test tests/e2e/scenarios/smoke.spec.ts

# Verify screenshots created
ls -la test-results/scenarios/smoke/
```

## Reference

- [Playwright Docs](https://playwright.dev/docs/screenshots)
- [Frontend E2E README](../../../tests/frontend-e2e/README.md)
