# ST-009: Edge Case E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `not-started`
- **Priority**: `medium`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: ST-001

## Context

Implement scenarios 8.1-8.24 (Edge Cases) as E2E tests. These cover error handling, reconnection, player count edge cases, and other unusual situations that can occur during gameplay.

## Requirements

Implement the following scenarios from the test matrix:

### Player Count (8.1-8.4)

| ID | Scenario | Description |
|----|----------|-------------|
| 8.1 | Minimum players (3) | Game starts with 3 players |
| 8.2 | Maximum players (6) | Game starts with 6 players |
| 8.3 | Cannot start with 2 | Validation prevents <3 players |
| 8.4 | Cannot add 7th player | Validation prevents >6 players |

### Hand Management (8.5-8.8)

| ID | Scenario | Description |
|----|----------|-------------|
| 8.5 | Hand size limit | Players have exactly 6 tiles |
| 8.6 | Draw after placement | New tile drawn each turn |
| 8.7 | No draw when bag empty | Hand can shrink |
| 8.8 | Start with 6 tiles | Initial deal is 6 tiles |

### Invalid Tiles (8.9-8.14)

| ID | Scenario | Description |
|----|----------|-------------|
| 8.9 | Permanently unplayable | Tile would merge two safe chains |
| 8.10 | Temporarily unplayable | Tile would found 8th chain |
| 8.11 | Unplayable tile UI | Visual indicator on tile |
| 8.12 | All tiles unplayable | Player has no valid moves |
| 8.13 | Replace unplayable tiles | Exchange permanently dead tiles |
| 8.14 | Tile becomes playable | Previously blocked tile now valid |

### Reconnection (8.15-8.18)

| ID | Scenario | Description |
|----|----------|-------------|
| 8.15 | Player reconnects | Resume after disconnect |
| 8.16 | State sync on reconnect | Full game state restored |
| 8.17 | Reconnect during turn | Continue turn if still valid |
| 8.18 | Reconnect after turn | See updated state |

### Tile Bag (8.19-8.22)

| ID | Scenario | Description |
|----|----------|-------------|
| 8.19 | Initial tile bag | 108 tiles minus initial deal |
| 8.20 | Tile bag count display | Show remaining tiles |
| 8.21 | Tile bag empties | Game continues without draws |
| 8.22 | No tiles and no moves | Edge case handling |

### Error Handling (8.23-8.24)

| ID | Scenario | Description |
|----|----------|-------------|
| 8.23 | Network error | Toast notification + retry |
| 8.24 | Server error | Graceful error display |

## Acceptance Criteria

- [ ] All 24 edge case scenarios have passing tests
- [ ] Player count validation works correctly
- [ ] Unplayable tile indicators visible
- [ ] Reconnection restores full state
- [ ] Error handling shows user-friendly messages
- [ ] Screenshots capture edge case states

## Implementation Notes

### Key Test File

**frontend/tests/e2e/scenarios/edge-cases.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'
import { captureStep, resetStepCounter } from './helpers/screenshot'
import { createGame, startGame } from './helpers/game-setup'

const CATEGORY = 'edge-cases'

test.describe('Edge Case Scenarios (8.x)', () => {
  test.beforeEach(() => {
    resetStepCounter()
  })

  test.describe('Player Count', () => {
    test('8.1: Minimum players (3)', async ({ page, request }) => {
      const testName = 'scenario-8.1-three-players'

      const game = await createGame(request, {
        hostName: 'Host',
        playerNames: ['Player2', 'Player3']
      })

      await page.goto(`/host/${game.roomCode}`)

      // Start button should be enabled with 3 players
      const startButton = page.locator('[data-testid="start-game-button"]')
      await expect(startButton).toBeEnabled()
      await captureStep(page, 'three-players-valid', { category: CATEGORY, testName })
    })

    test('8.3: Cannot start with 2', async ({ page, request }) => {
      const testName = 'scenario-8.3-two-players'

      const game = await createGame(request, {
        hostName: 'Host',
        playerNames: ['Player2']
      })

      await page.goto(`/host/${game.roomCode}`)

      // Start button should be disabled
      const startButton = page.locator('[data-testid="start-game-button"]')
      await expect(startButton).toBeDisabled()

      const warningMessage = page.locator('[data-testid="player-count-warning"]')
      await expect(warningMessage).toContainText('Need at least 3 players')
      await captureStep(page, 'two-players-blocked', { category: CATEGORY, testName })
    })
  })

  test.describe('Invalid Tiles', () => {
    test('8.9: Permanently unplayable tile', async ({ page, request }) => {
      const testName = 'scenario-8.9-permanently-unplayable'

      // Setup game with two safe chains adjacent
      // Player has tile between them

      // Tile should have unplayable indicator
      const unplayableTile = page.locator('[data-testid="tile-unplayable"]')
      await expect(unplayableTile).toBeVisible()
      await expect(unplayableTile).toHaveClass(/unplayable-permanent/)
      await captureStep(page, 'permanent-unplayable', { category: CATEGORY, testName })
    })

    test('8.12: All tiles unplayable', async ({ page, request }) => {
      const testName = 'scenario-8.12-all-unplayable'

      // Setup: Player's entire hand is unplayable

      // Should show special message/skip turn option
      const noMoveMessage = page.locator('[data-testid="no-playable-tiles"]')
      await expect(noMoveMessage).toBeVisible()
      await captureStep(page, 'no-moves', { category: CATEGORY, testName })
    })

    test('8.13: Replace unplayable tiles', async ({ page, request }) => {
      const testName = 'scenario-8.13-replace-tiles'

      // Player has permanently unplayable tiles
      // Should be able to replace them

      const replaceTileButton = page.locator('[data-testid="replace-tile-button"]')
      await expect(replaceTileButton).toBeVisible()
      await captureStep(page, 'replace-available', { category: CATEGORY, testName })

      await replaceTileButton.click()
      await captureStep(page, 'tile-replaced', { category: CATEGORY, testName })
    })
  })

  test.describe('Reconnection', () => {
    test('8.15: Player reconnects', async ({ page, request, context }) => {
      const testName = 'scenario-8.15-reconnect'

      // Setup game and connect
      const game = await createGame(request, {
        hostName: 'Reconnecter',
        playerNames: ['Player2', 'Player3']
      })
      await startGame(request, game.roomCode, game.hostSessionToken)

      await page.goto(`/play/${game.roomCode}`)
      await captureStep(page, 'initial-connection', { category: CATEGORY, testName })

      // Simulate disconnect by closing WebSocket
      await page.evaluate(() => {
        // Force disconnect
        window.dispatchEvent(new Event('offline'))
      })

      // Reconnection overlay should appear
      const reconnectOverlay = page.locator('[data-testid="reconnection-overlay"]')
      await expect(reconnectOverlay).toBeVisible()
      await captureStep(page, 'disconnect-detected', { category: CATEGORY, testName })

      // Simulate reconnect
      await page.evaluate(() => {
        window.dispatchEvent(new Event('online'))
      })

      // Overlay should disappear, game state restored
      await expect(reconnectOverlay).not.toBeVisible()
      await captureStep(page, 'reconnected', { category: CATEGORY, testName })
    })

    test('8.16: State sync on reconnect', async ({ page, request }) => {
      const testName = 'scenario-8.16-state-sync'

      // Verify board state, player hands, scores all restored
      // after reconnection
      await captureStep(page, 'state-synced', { category: CATEGORY, testName })
    })
  })

  test.describe('Error Handling', () => {
    test('8.23: Network error', async ({ page, request }) => {
      const testName = 'scenario-8.23-network-error'

      // Setup game
      // Simulate network failure on action
      await page.route('**/api/**', route => route.abort('failed'))

      // Attempt action
      // ...

      // Toast should show error
      const errorToast = page.locator('[data-testid="toast-error"]')
      await expect(errorToast).toBeVisible()
      await expect(errorToast).toContainText('Network error')
      await captureStep(page, 'network-error-toast', { category: CATEGORY, testName })
    })

    test('8.24: Server error', async ({ page, request }) => {
      const testName = 'scenario-8.24-server-error'

      // Mock server 500 response
      await page.route('**/api/**', route => {
        route.fulfill({
          status: 500,
          body: JSON.stringify({ detail: 'Internal server error' })
        })
      })

      // Attempt action
      // ...

      // Error display
      const errorMessage = page.locator('[data-testid="error-message"]')
      await expect(errorMessage).toBeVisible()
      await captureStep(page, 'server-error', { category: CATEGORY, testName })
    })
  })
})
```

### Screenshot Requirements

1. Player count validation states
2. Unplayable tile indicators
3. Reconnection overlay
4. State after reconnection
5. Error toast/messages
6. Tile bag count display

## Verification

```bash
# Run edge case tests
cd frontend && npx playwright test tests/e2e/scenarios/edge-cases.spec.ts

# View screenshots
ls -la test-results/scenarios/edge-cases/

# View HTML report
npx playwright show-report
```

## Reference

- [Edge Case Scenarios](../../../tests/scenario-docs.md#8-edge-cases)
- [Reconnection UI](../../../ui/components.md#reconnection-overlay)
- [Game Rules - Special Cases](../../../rules/gameplay.md#special-cases)
