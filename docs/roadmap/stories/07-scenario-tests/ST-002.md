# ST-002: Turn Flow E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `complete`
- **Priority**: `critical`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: ST-001

## Context

Implement scenarios 1.1-1.10 (Turn Flow) as E2E tests with screenshots. These tests verify the complete turn cycle: tile placement → optional actions → stock purchase → end turn.

## Requirements

Implement the following scenarios from the test matrix:

| ID | Scenario | Description |
|----|----------|-------------|
| 1.1 | Basic complete turn | Place tile → buy stock → end turn |
| 1.2 | Turn with no stock purchase | Place tile → skip buy → end turn |
| 1.3 | Turn with chain founding | Place tile → select chain → buy stock → end turn |
| 1.4 | Turn with chain expansion | Place tile expanding chain → buy stock → end turn |
| 1.5 | Turn with merger | Place merger tile → resolve merger → buy stock → end turn |
| 1.6 | Turn with multi-chain merger | Place tile merging 3+ chains → resolve all |
| 1.7 | Turn ending the game | Place tile triggering game end |
| 1.8 | No playable tiles | Player has no legal tile placements |
| 1.9 | Turn timer expiration | Turn times out → auto-end turn |
| 1.10 | Player disconnect during turn | Player disconnects → turn skipped |

## Acceptance Criteria

- [x] Core turn flow scenarios (1.1-1.6) have E2E tests
- [x] Each test captures screenshots at key steps (with graceful fallback)
- [x] Screenshots show: initial state, tile placed, stock purchased, turn complete
- [x] Tests run against real servers (not mocked)
- [x] Console errors fail the test
- [ ] Edge case scenarios (1.7-1.10) deferred to ST-009

**Note**: Edge case scenarios (1.7 Turn ending game, 1.8 No playable tiles, 1.9 Timer expiration, 1.10 Disconnect) require specific game states that are difficult to set up through UI-only interactions. These are deferred to ST-009 (Edge Case E2E Tests) which may use backend seeding for reproducibility.

## Implementation Notes

### Key Test File

**frontend/tests/e2e/scenarios/turn-flow.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'
import { captureStep, resetStepCounter } from './helpers/screenshot'
import { createGame, startGame } from './helpers/game-setup'

const CATEGORY = 'turn-flow'

test.describe('Turn Flow Scenarios (1.x)', () => {
  test.beforeEach(() => {
    resetStepCounter()
  })

  test('1.1: Basic complete turn', async ({ page, request }) => {
    const testName = 'scenario-1.1-basic-turn'

    // Setup game with 3 players
    const game = await createGame(request, {
      hostName: 'Host',
      playerNames: ['Player2', 'Player3']
    })
    await startGame(request, game.roomCode, game.hostSessionToken)

    // Navigate to player view
    await page.goto(`/play/${game.roomCode}`)
    // Set session storage for auth
    await page.evaluate((token) => {
      sessionStorage.setItem('session_token', token)
      sessionStorage.setItem('player_id', 'host-id')
    }, game.hostSessionToken)
    await page.reload()

    await captureStep(page, 'initial-state', { category: CATEGORY, testName })

    // Wait for turn (if it's our turn)
    // Place tile
    const tile = page.locator('[data-testid="tile-rack"] button').first()
    await tile.click()
    await captureStep(page, 'tile-placed', { category: CATEGORY, testName })

    // Buy stock (if available)
    const buyButton = page.locator('[data-testid="buy-stock-button"]')
    if (await buyButton.isVisible()) {
      await buyButton.click()
      await captureStep(page, 'stock-purchased', { category: CATEGORY, testName })
    }

    // End turn
    const endTurnButton = page.locator('[data-testid="end-turn-button"]')
    await endTurnButton.click()
    await captureStep(page, 'turn-complete', { category: CATEGORY, testName })
  })

  test('1.3: Turn with chain founding', async ({ page, request }) => {
    const testName = 'scenario-1.3-chain-founding'

    // Setup game
    const game = await createGame(request, {
      hostName: 'Host',
      playerNames: ['Player2', 'Player3']
    })
    await startGame(request, game.roomCode, game.hostSessionToken)

    await page.goto(`/play/${game.roomCode}`)
    await captureStep(page, 'initial-state', { category: CATEGORY, testName })

    // Place tile that creates adjacency (triggers chain founding)
    // ... tile placement logic

    // Chain selection modal should appear
    const chainSelector = page.locator('[data-testid="chain-selector"]')
    await expect(chainSelector).toBeVisible()
    await captureStep(page, 'chain-selector-visible', { category: CATEGORY, testName })

    // Select a chain
    await page.locator('[data-testid="chain-option-tower"]').click()
    await captureStep(page, 'chain-founded', { category: CATEGORY, testName })
  })

  // Additional scenarios...
})
```

### Screenshot Requirements

Each test should capture:
1. **Initial state** - Board and player hand before action
2. **After tile placement** - Tile on board, hand updated
3. **During special action** - Chain selection, merger UI, etc.
4. **After stock purchase** - Updated holdings
5. **Turn complete** - Next player's turn indicator

## Verification

```bash
# Run turn flow tests
cd frontend && npx playwright test tests/e2e/scenarios/turn-flow.spec.ts

# View screenshots
ls -la test-results/scenarios/turn-flow/

# View HTML report
npx playwright show-report
```

## Reference

- [Turn Flow Scenarios](../../../tests/scenario-docs.md#1-turn-flow)
- [Game Rules - Turn Structure](../../../rules/gameplay.md)
