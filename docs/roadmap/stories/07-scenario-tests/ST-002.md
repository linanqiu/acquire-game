# ST-002: Turn Flow E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `completed`
- **Priority**: `critical`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: ST-001

## Context

Implement scenarios 1.1-1.10 (Turn Flow) as E2E tests with screenshots. These tests verify the complete turn cycle: tile placement → optional actions → stock purchase → end turn.

## Requirements

Implement the following scenarios from the test matrix:

| ID | Scenario | Description | Status |
|----|----------|-------------|--------|
| 1.1 | Basic complete turn | Place tile → buy stock → end turn | ✅ Implemented |
| 1.2 | Turn with no stock purchase | Place tile → skip buy → end turn | ✅ Implemented |
| 1.3 | Turn with chain founding | Place tile → select chain → buy stock → end turn | ✅ Implemented |
| 1.4 | Turn with chain expansion | Place tile expanding chain → buy stock → end turn | ✅ Implemented |
| 1.5 | Turn with merger | Place merger tile → resolve merger → buy stock → end turn | ⏳ Deferred (requires test-setup API) |
| 1.6 | Turn with multi-chain merger | Place tile merging 3+ chains → resolve all | ⏳ Deferred (requires test-setup API) |
| 1.7 | Turn ending the game | Place tile triggering game end | ⏳ Deferred (requires test-setup API) |
| 1.8 | No playable tiles | Player has no legal tile placements | ⏳ Deferred (requires test-setup API) |
| 1.9 | Turn timer expiration | Turn times out → auto-end turn | ⏳ Deferred (turn timer not implemented) |
| 1.10 | Player disconnect during turn | Player disconnects → turn skipped | ✅ Implemented |

## Acceptance Criteria

- [x] 5 of 10 turn flow scenarios have passing tests (1.1-1.4, 1.10)
- [x] Each test captures screenshots at key steps
- [x] Screenshots show: initial state, tile selected, place button enabled
- [x] Tests run against real servers (not mocked)
- [x] Console errors fail the test (excluding expected WebSocket errors)

## Implementation Notes

### Files Changed

| File | Change |
|------|--------|
| `frontend/src/pages/PlayerPage.tsx` | Added `data-testid="place-tile-button"` and `data-testid="end-turn-button"` |
| `frontend/src/components/ui/PageShell.tsx` | Added `data-testid="game-phase"` |
| `frontend/tests/e2e/scenarios/helpers/turn-actions.ts` | NEW: Helper functions for turn interactions |
| `frontend/tests/e2e/scenarios/turn-flow.spec.ts` | NEW: 5 turn flow scenario tests |

### WebSocket Gotchas (CRITICAL for Future Reference)

This story surfaced several WebSocket-related bugs. Document these for future debugging:

#### 1. Vite WebSocket Proxy ECONNRESET (Red Herring)

**Symptom**: Console shows `[vite] ws proxy error: Error: write ECONNRESET`

**Initial assumption**: Vite proxy needed better error handlers.

**Reality**: The ECONNRESET was a symptom, not the cause. Adding error handlers to `vite.config.ts` just suppressed the error messages. The real issues were in the application code.

#### 2. React StrictMode Double-Mount Race Condition (THE REAL ISSUE)

**Symptom**: WebSocket connects, then immediately disconnects. Actions fail silently.

**Root cause**: In React StrictMode, components mount twice. The `useWebSocket` hook was:
1. First mount: Create WebSocket A, store in `wsRef.current`
2. Second mount: Create WebSocket B, store in `wsRef.current`
3. First cleanup: Close WebSocket A, but `onclose` handler nullifies `wsRef.current`
4. Result: WebSocket B exists but `wsRef.current` is `null`

**Fix** (`useWebSocket.ts`):
```typescript
// WRONG - cleanup nullifies wsRef even if a new connection exists
return () => {
  wsRef.current?.close()
  wsRef.current = null  // This kills the NEW connection too!
}

// RIGHT - only cleanup our specific instance
const ws = new WebSocket(url)
wsRef.current = ws
return () => {
  if (wsRef.current === ws) {  // Only if WE are still current
    ws.close()
    wsRef.current = null
  } else {
    ws.close()  // Close old one but don't nullify the new one
  }
}
```

#### 3. Zustand Store Race Condition (Chain Selector Not Appearing)

**Symptom**: Chain founding triggered but chain selector never appears.

**Root cause**: Messages arrive in unpredictable order:
1. `choose_chain` arrives → sets `pendingChainChoice`
2. `game_state` arrives immediately after → clears `pendingChainChoice`
3. UI never sees the pending action

**Fix** (`gameStore.ts`):
```typescript
case 'game_state':
  // Don't clear pendingChainChoice if we're still in found_chain phase
  if (message.phase !== 'found_chain') {
    set({ pendingChainChoice: null })
  }
```

#### 4. Bot Stock Disposition Bug (Merger Gets Stuck)

**Symptom**: Merger starts, then game freezes. Test times out.

**Root cause**: During merger, code sent WebSocket message to player for stock disposition. But bots don't have WebSocket clients. The server was waiting forever for a response that would never come.

**Fix** (`main.py`): Unified handler that checks if player is bot:
```python
async def notify_or_handle_stock_disposition(room_code: str):
    player_conn = room.players.get(disposition_player_id)
    if player_conn.is_bot:
        # Bot: generate and execute decision directly
        decision = bot.choose_stock_disposition(...)
        game.handle_stock_disposition(player_id, **decision)
    else:
        # Human: send WebSocket message and wait
        await send_to_player(room_code, player_id, {...})
```

**Lesson**: Bots and humans must use the same code path for game actions. Only the decision source differs.

### Deferred Scenarios

Scenarios 1.5-1.8 require specific board states that cannot be achieved through normal gameplay in a reasonable time. These would need a test-setup API endpoint that allows seeding specific game states.

Scenario 1.9 requires a turn timer feature that is not yet implemented.

## Verification

```bash
# Run turn flow tests
cd frontend && npx playwright test tests/e2e/scenarios/turn-flow.spec.ts --project=scenarios

# View screenshots
ls -la test-results/scenarios/turn-flow/

# View HTML report
npx playwright show-report
```

## Reference

- [Turn Flow Scenarios](../../../tests/scenario-docs.md#1-turn-flow)
- [Game Rules - Turn Structure](../../../rules/gameplay.md)
