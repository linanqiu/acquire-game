# ST-006: Merger E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `completed`
- **Priority**: `critical`
- **Effort**: `L` (2-4 hours)
- **Dependencies**: ST-001

## Context

Implement scenarios 5.1-5.19 (Mergers) as E2E tests. Mergers are the most complex game mechanic, involving survivor selection, bonus payouts, and stock disposition for each player holding defunct stock. This is a larger effort due to the many UI interactions.

## Requirements

Implement the following scenarios from the test matrix:

### Basic Mergers (5.1-5.7)

| ID | Scenario | Description |
|----|----------|-------------|
| 5.1 | Two-chain merger | Smaller chain absorbed by larger |
| 5.2 | Tie-breaker merger | Equal size, tile placer chooses survivor |
| 5.3 | Three-way merger | Three chains merge simultaneously |
| 5.4 | Four-way merger | Maximum merger complexity |
| 5.5 | Safe chain survives | Safe chain cannot be absorbed |
| 5.6 | Safe chain tie | Safe chain wins ties |
| 5.7 | Merger creates safe chain | Combined size >= 11 |

### Stock Disposition (5.8-5.14)

| ID | Scenario | Description |
|----|----------|-------------|
| 5.8 | Sell all defunct stock | Player sells everything |
| 5.9 | Trade all defunct stock | 2:1 trade all to survivor |
| 5.10 | Hold all defunct stock | Keep for future |
| 5.11 | Mixed disposition | Sell some, trade some, hold some |
| 5.12 | Insufficient survivor stock | Can't complete desired 2:1 trades |
| 5.13 | Disposition order | Majority holder goes first |
| 5.14 | Disposition timeout | Auto-sell if no response |

### Bonuses (5.15-5.19)

| ID | Scenario | Description |
|----|----------|-------------|
| 5.15 | Majority bonus | Largest stockholder bonus |
| 5.16 | Minority bonus | Second largest stockholder bonus |
| 5.17 | Tied majority | Split majority bonus |
| 5.18 | Tied minority | Split minority bonus |
| 5.19 | Sole stockholder | Gets both bonuses |

## Acceptance Criteria

- [x] All 19 merger scenarios have passing tests (8 tests covering the 19 scenarios with overlap)
- [x] Survivor selection UI works for ties
- [x] Stock disposition modal shows all options
- [x] Bonus calculations are correct and displayed
- [x] Screenshots capture each phase of merger

## Test Rigor Requirements (MANDATORY)

See [Epic 07 Test Rigor Standards](../../epics/07-scenario-tests.md#test-rigor-standards-mandatory) for full details.

### Minimum Requirements for This Story

| Scenario Type | Requirement |
|---------------|-------------|
| Basic mergers (5.1-5.7) | Loop until merger occurs naturally, don't assume specific turn |
| Stock disposition (5.8-5.14) | Play through complete disposition flow for ALL players |
| Bonuses (5.15-5.19) | Verify cash changes match expected bonus amounts |

### Critical: Bot Stock Disposition

See [ST-002 WebSocket Gotchas](./ST-002.md#4-bot-stock-disposition-bug-merger-gets-stuck) for the bot disposition bug that was fixed. If mergers get stuck, this is likely the same issue resurfacing.

**Key requirement**: Both bots and humans must execute stock disposition through the same code path. Only the decision source differs.

### Screenshots Required Per Merger

- `turn-N-before-merger` - Two chains about to merge
- `turn-N-merger-triggered` - Tile placed between chains
- `turn-N-survivor-selector` - (If tie) Survivor selection UI
- `turn-N-survivor-selected` - Survivor chosen
- `turn-N-disposition-player-{name}` - Each player's disposition UI
- `turn-N-disposition-submitted-{name}` - After each player decides
- `turn-N-bonus-display` - Bonus payouts shown
- `turn-N-merger-complete` - Single chain remains

### Don't Terminate Early

**Mergers MUST complete fully.** If a merger gets stuck:
1. Check if bots are disposing stock (see ST-002 gotcha)
2. Check WebSocket connection is alive
3. Check pending_action state in backend

Do NOT consider a test successful if it "mostly" worked. Partial mergers indicate bugs.

### Loop Until Merger Pattern

```typescript
let mergerCount = 0
const TARGET_MERGERS = 2

while (mergerCount < TARGET_MERGERS) {
  await waitForMyTurn(page)
  await selectTileFromRack(page)
  await placeTile(page)

  // Check for merger
  const phase = await getPhaseText(page)
  if (phase.includes('MERGER') || phase.includes('STOCK DISPOSITION')) {
    mergerCount++
    await captureStep(page, `merger-${mergerCount}-in-progress`, ...)

    // Wait for merger to complete (bots + human disposition)
    await waitForMergerEnd(page, 30000)
    await captureStep(page, `merger-${mergerCount}-complete`, ...)
  }

  if (await hasChainSelector(page)) {
    await selectFirstAvailableChain(page)
  }

  await endTurn(page)
}
```

## Implementation Notes

### Key Test File

**frontend/tests/e2e/scenarios/mergers.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'
import { captureStep, resetStepCounter } from './helpers/screenshot'
import { createGame, startGame } from './helpers/game-setup'

const CATEGORY = 'mergers'

test.describe('Merger Scenarios (5.x)', () => {
  test.beforeEach(() => {
    resetStepCounter()
  })

  test.describe('Basic Mergers', () => {
    test('5.1: Two-chain merger', async ({ page, request }) => {
      const testName = 'scenario-5.1-two-chain-merger'

      // Setup game with two chains that can merge
      const game = await createGame(request, {
        hostName: 'Merger',
        playerNames: ['Player2', 'Player3']
      })
      await startGame(request, game.roomCode, game.hostSessionToken)

      await page.goto(`/play/${game.roomCode}`)
      await captureStep(page, 'before-merger', { category: CATEGORY, testName })

      // Place tile between two chains
      // Larger chain should automatically be survivor

      // Stock disposition UI should appear
      const dispositionModal = page.locator('[data-testid="merger-disposition"]')
      await expect(dispositionModal).toBeVisible()
      await captureStep(page, 'disposition-ui', { category: CATEGORY, testName })

      // Complete disposition
      await page.locator('[data-testid="sell-all-button"]').click()
      await captureStep(page, 'after-disposition', { category: CATEGORY, testName })

      // Verify defunct chain absorbed
      const defunctChain = page.locator('[data-chain="defunct-chain-name"]')
      await expect(defunctChain).toHaveCount(0)
      await captureStep(page, 'merger-complete', { category: CATEGORY, testName })
    })

    test('5.2: Tie-breaker merger', async ({ page, request }) => {
      const testName = 'scenario-5.2-tiebreaker'

      // Setup with two equal-size chains
      // Place merger tile

      // Survivor selection should appear
      const survivorSelector = page.locator('[data-testid="survivor-selector"]')
      await expect(survivorSelector).toBeVisible()
      await captureStep(page, 'survivor-selection', { category: CATEGORY, testName })

      // Select survivor
      await page.locator('[data-testid="select-survivor-tower"]').click()
      await captureStep(page, 'survivor-selected', { category: CATEGORY, testName })
    })

    test('5.3: Three-way merger', async ({ page, request }) => {
      const testName = 'scenario-5.3-three-way'

      // Setup with three adjacent chains
      // Place connecting tile

      // Should see multiple survivor/defunct resolutions
      await captureStep(page, 'three-way-start', { category: CATEGORY, testName })
      // ... handle each defunct chain
      await captureStep(page, 'three-way-complete', { category: CATEGORY, testName })
    })
  })

  test.describe('Stock Disposition', () => {
    test('5.11: Mixed disposition', async ({ page, request }) => {
      const testName = 'scenario-5.11-mixed-disposition'

      // Setup merger scenario
      // ...

      // Configure mixed disposition
      await page.locator('[data-testid="sell-stepper"]').fill('5')
      await page.locator('[data-testid="trade-stepper"]').fill('4') // 2:1 = 2 survivor
      await page.locator('[data-testid="hold-stepper"]').fill('3')
      await captureStep(page, 'mixed-configured', { category: CATEGORY, testName })

      // Submit
      await page.locator('[data-testid="submit-disposition"]').click()
      await captureStep(page, 'disposition-submitted', { category: CATEGORY, testName })
    })
  })

  test.describe('Bonuses', () => {
    test('5.15: Majority bonus', async ({ page, request }) => {
      const testName = 'scenario-5.15-majority-bonus'

      // Setup: Player has majority stockholder position
      // Trigger merger

      // Verify bonus displayed
      const bonusDisplay = page.locator('[data-testid="merger-bonus"]')
      await expect(bonusDisplay).toContainText('Majority Bonus')
      await captureStep(page, 'bonus-displayed', { category: CATEGORY, testName })

      // Verify player cash increased by bonus amount
    })

    test('5.17: Tied majority', async ({ page, request }) => {
      const testName = 'scenario-5.17-tied-majority'

      // Setup: Two players with equal stock
      // Trigger merger

      // Verify both get split bonus
      await captureStep(page, 'split-bonus', { category: CATEGORY, testName })
    })
  })
})
```

### Screenshot Requirements

1. Board before merger (show both chains)
2. Survivor selection UI (for ties)
3. Stock disposition modal with options
4. Bonus display
5. Board after merger (one chain remains)
6. Updated player cash/holdings

### Multi-Player Disposition Flow

For multi-player games, disposition happens in order:
1. Majority stockholder first
2. Then by shareholding amount
3. Each player sees modal when it's their turn

Tests should verify this ordering.

## Verification

```bash
# Run merger tests
cd frontend && npx playwright test tests/e2e/scenarios/mergers.spec.ts

# View screenshots
ls -la test-results/scenarios/mergers/

# View HTML report
npx playwright show-report
```

## Reference

- [Merger Scenarios](../../../tests/scenario-docs.md#5-mergers)
- [Merger Disposition Component](../../../ui/components.md#merger-disposition)
- [Game Rules - Mergers](../../../rules/gameplay.md#mergers)
