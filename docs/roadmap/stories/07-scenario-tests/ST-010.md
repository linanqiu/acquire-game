# ST-010: Scenario Coverage Report

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `not-started`
- **Priority**: `low`
- **Effort**: `S` (30-60 min)
- **Dependencies**: ST-002, ST-003, ST-004, ST-005, ST-006, ST-007, ST-008, ST-009

## Context

Create coverage documentation and reporting for all E2E scenario tests. This provides visibility into which scenarios are tested and enables CI integration.

## Requirements

1. Create mapping table: scenario ID → test file:line
2. Calculate coverage percentage per category
3. Add CI job for E2E scenario tests
4. Generate screenshot gallery in test reports

## Acceptance Criteria

- [ ] Coverage mapping document exists
- [ ] Coverage percentage tracked per category (1.x, 2.x, etc.)
- [ ] CI runs scenario tests automatically
- [ ] HTML report includes screenshot gallery
- [ ] Missing scenario coverage is visible

## Test Rigor Requirements (MANDATORY)

See [Epic 07 Test Rigor Standards](../../epics/07-scenario-tests.md#test-rigor-standards-mandatory) for full details.

### Coverage Report Must Reflect Rigor

The coverage report should not just count "test exists" but verify tests meet rigor standards:

| Rigor Metric | Requirement |
|--------------|-------------|
| Minimum turns | Each test meets its category's minimum turn requirement |
| Screenshots | Each test has screenshots at all required points |
| No early termination | Tests don't have workarounds for bugs |
| Actual verification | Tests verify state changes, not just UI presence |

### Coverage Documentation Should Include

For each scenario:
- Test file and line number
- Minimum turn count achieved
- Screenshot count
- Known issues or workarounds (should be zero)
- Seed used for determinism

### CI Must Fail on Rigor Violations

The CI job should check:
1. All tests pass
2. Screenshot directories contain expected files
3. No test has `skip` or `fixme` annotations
4. Test output logs show minimum turn counts met

## Implementation Notes

### Coverage Mapping Document

**docs/tests/scenario-coverage.md**:
```markdown
# Scenario Test Coverage

## Coverage Summary

| Category | Total | Covered | Percentage |
|----------|-------|---------|------------|
| 1.x Turn Flow | 10 | 10 | 100% |
| 2.x Trading | 18 | 18 | 100% |
| 3.x Chain Founding | 10 | 10 | 100% |
| 4.x Chain Expansion | 10 | 10 | 100% |
| 5.x Mergers | 19 | 19 | 100% |
| 6.x Stock Purchases | 17 | 17 | 100% |
| 7.x End Game | 16 | 16 | 100% |
| 8.x Edge Cases | 24 | 24 | 100% |
| **Total** | **124** | **124** | **100%** |

## Detailed Mapping

### 1.x Turn Flow
| Scenario | Description | Test File | Status |
|----------|-------------|-----------|--------|
| 1.1 | Basic complete turn | turn-flow.spec.ts:15 | ✅ |
| 1.2 | Turn with no stock purchase | turn-flow.spec.ts:45 | ✅ |
| ... | ... | ... | ... |

### 2.x Trading
| Scenario | Description | Test File | Status |
|----------|-------------|-----------|--------|
| 2.1 | Initiate trade offer | trading.spec.ts:18 | ✅ |
| ... | ... | ... | ... |

[Continue for all categories]
```

### CI Integration

**Add to .github/workflows/ci.yml**:
```yaml
  e2e-scenarios:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && pip install -r requirements.txt

      - name: Install Playwright browsers
        run: cd frontend && npx playwright install --with-deps chromium

      - name: Run E2E scenario tests
        run: |
          cd frontend && npx playwright test tests/e2e/scenarios/ --reporter=html

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scenario-test-results
          path: |
            frontend/playwright-report/
            frontend/test-results/scenarios/
          retention-days: 30
```

### Screenshot Gallery Script

**frontend/scripts/generate-screenshot-gallery.ts**:
```typescript
import * as fs from 'fs'
import * as path from 'path'

const SCENARIOS_DIR = 'test-results/scenarios'
const OUTPUT_FILE = 'playwright-report/screenshot-gallery.html'

function generateGallery(): void {
  const categories = fs.readdirSync(SCENARIOS_DIR)

  let html = `
<!DOCTYPE html>
<html>
<head>
  <title>E2E Scenario Screenshot Gallery</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .category { margin-bottom: 40px; }
    .test { margin-bottom: 20px; }
    .screenshots { display: flex; flex-wrap: wrap; gap: 10px; }
    .screenshot { max-width: 300px; }
    .screenshot img { width: 100%; border: 1px solid #ccc; }
    .screenshot-label { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <h1>E2E Scenario Screenshot Gallery</h1>
`

  for (const category of categories) {
    const categoryPath = path.join(SCENARIOS_DIR, category)
    if (!fs.statSync(categoryPath).isDirectory()) continue

    html += `<div class="category"><h2>${category}</h2>`

    const tests = fs.readdirSync(categoryPath)
    for (const test of tests) {
      const testPath = path.join(categoryPath, test)
      if (!fs.statSync(testPath).isDirectory()) continue

      html += `<div class="test"><h3>${test}</h3><div class="screenshots">`

      const screenshots = fs.readdirSync(testPath).filter(f => f.endsWith('.png'))
      for (const screenshot of screenshots.sort()) {
        const relativePath = path.join('..', SCENARIOS_DIR, category, test, screenshot)
        html += `
          <div class="screenshot">
            <img src="${relativePath}" alt="${screenshot}">
            <div class="screenshot-label">${screenshot}</div>
          </div>
        `
      }

      html += `</div></div>`
    }

    html += `</div>`
  }

  html += `</body></html>`

  fs.writeFileSync(OUTPUT_FILE, html)
  console.log(`Generated gallery at ${OUTPUT_FILE}`)
}

generateGallery()
```

### Playwright Config Addition

Add to playwright.config.ts:
```typescript
{
  name: 'scenarios',
  testDir: './tests/e2e/scenarios',
  use: { ...devices['Desktop Chrome'] },
}
```

## Verification

```bash
# Generate coverage report
node frontend/scripts/generate-scenario-coverage.ts

# Run tests and generate gallery
cd frontend
npx playwright test tests/e2e/scenarios/ --reporter=html
npx ts-node scripts/generate-screenshot-gallery.ts

# View gallery
open playwright-report/screenshot-gallery.html
```

## Reference

- [Playwright HTML Reporter](https://playwright.dev/docs/test-reporters#html-reporter)
- [GitHub Actions Artifacts](https://docs.github.com/en/actions/using-workflows/storing-workflow-data-as-artifacts)
