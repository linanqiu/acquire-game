# ST-004: Chain Founding E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: ST-001

## Context

Implement scenarios 3.1-3.10 (Chain Founding) as E2E tests. Chain founding occurs when a tile creates adjacency between two or more tiles, and the player must select which chain to found from available options.

## Requirements

Implement the following scenarios from the test matrix:

| ID | Scenario | Description |
|----|----------|-------------|
| 3.1 | Basic chain creation | Two tiles adjacent → select chain |
| 3.2 | Three-tile founding | Multiple tiles become chain |
| 3.3 | Chain selection from all available | All 7 chains available to choose |
| 3.4 | Chain selection limited | Some chains already on board |
| 3.5 | Founder's bonus | Player receives 1 free stock |
| 3.6 | Founder's bonus stock depleted | No stock available → no bonus |
| 3.7 | Cannot found 8th chain | 7 chains exist, cannot create more |
| 3.8 | Chain colors on board | Verify correct color applied |
| 3.9 | Chain size tracking | Size updates correctly |
| 3.10 | Chain founding cancellation | Player disconnects during selection |

## Acceptance Criteria

- [ ] All 10 chain founding scenarios have passing tests
- [ ] Chain selector modal displays correctly
- [ ] Founder receives free stock (verified in holdings)
- [ ] Board updates with chain color after founding
- [ ] Screenshots capture: pre-founding tiles, chain selector, founded chain

## Test Rigor Requirements (MANDATORY)

See [Epic 07 Test Rigor Standards](../../epics/07-scenario-tests.md#test-rigor-standards-mandatory) for full details.

### Minimum Requirements for This Story

| Scenario Type | Requirement |
|---------------|-------------|
| Basic founding (3.1-3.6) | Loop until chain founding occurs, found at least 2 chains |
| Limited options (3.4, 3.7) | First found enough chains to test constraints, then verify |
| Founder's bonus (3.5-3.6) | Verify stock holdings AFTER founding, not just UI |

### Screenshots Required Per Test

For each founding event:
- `turn-N-before-place` - Board state before tile placement
- `turn-N-tile-selected-{coord}` - Selected tile
- `turn-N-after-place` - Board after placement (adjacent tiles visible)
- `turn-N-chain-selector` - Modal with available chains
- `turn-N-founded-{chain}` - Chain selected and visible on board
- `turn-N-holdings` - Player stock showing founder's bonus
- `final-state` - End of test with all founded chains visible

### Don't Terminate Early

**Loop until founding actually happens.** Do not assume a specific turn will trigger founding. Test should:
1. Play turns until 2+ chains are founded
2. Log every turn showing tile placement and whether it triggered founding
3. Only pass if chain selector appeared AND chain was successfully selected AND board updated

### Example Pattern

```typescript
let chainsFoundedByMe: string[] = []
while (chainsFoundedByMe.length < 2) {
  await waitForMyTurn(page)
  await selectTileFromRack(page)
  await placeTile(page)
  if (await hasChainSelector(page)) {
    const chain = await selectFirstAvailableChain(page)
    chainsFoundedByMe.push(chain)
    await captureStep(page, `founded-${chain}`, ...)
  }
  await endTurn(page)
}
```

## Implementation Notes

### Key Test File

**frontend/tests/e2e/scenarios/chain-founding.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'
import { captureStep, resetStepCounter } from './helpers/screenshot'
import { createGame, startGame } from './helpers/game-setup'
import { assertChainOnBoard } from './helpers/assertions'

const CATEGORY = 'chain-founding'

test.describe('Chain Founding Scenarios (3.x)', () => {
  test.beforeEach(() => {
    resetStepCounter()
  })

  test('3.1: Basic chain creation', async ({ page, request }) => {
    const testName = 'scenario-3.1-basic-founding'

    // Setup game
    const game = await createGame(request, {
      hostName: 'Founder',
      playerNames: ['Player2', 'Player3']
    })
    await startGame(request, game.roomCode, game.hostSessionToken)

    await page.goto(`/play/${game.roomCode}`)
    await captureStep(page, 'initial-state', { category: CATEGORY, testName })

    // Place tile adjacent to existing tile (triggers founding)
    // This requires game state seeding or specific tile placement

    // Chain selector should appear
    const chainSelector = page.locator('[data-testid="chain-selector"]')
    await expect(chainSelector).toBeVisible()
    await captureStep(page, 'chain-selector-visible', { category: CATEGORY, testName })

    // Verify all 7 chains are available (no chains on board yet)
    const chainOptions = page.locator('[data-testid^="chain-option-"]')
    await expect(chainOptions).toHaveCount(7)

    // Select Tower chain
    await page.locator('[data-testid="chain-option-tower"]').click()
    await captureStep(page, 'chain-selected', { category: CATEGORY, testName })

    // Verify chain appears on board
    await assertChainOnBoard(page, 'tower')
    await captureStep(page, 'chain-on-board', { category: CATEGORY, testName })
  })

  test('3.5: Founders bonus', async ({ page, request }) => {
    const testName = 'scenario-3.5-founders-bonus'

    // Setup and found chain
    // ...

    // Verify player received 1 free stock
    const stockHolding = page.locator('[data-testid="stock-holding-tower"]')
    await expect(stockHolding).toContainText('1')
    await captureStep(page, 'founders-bonus-received', { category: CATEGORY, testName })
  })

  test('3.7: Cannot found 8th chain', async ({ page, request }) => {
    const testName = 'scenario-3.7-no-8th-chain'

    // Setup game with all 7 chains already founded
    // (requires test seeding API)

    // Place tile that would create adjacency
    // Verify no chain selector appears
    // Verify tile becomes "dead" or unplayable
    await captureStep(page, 'eighth-chain-prevented', { category: CATEGORY, testName })
  })
})
```

### Screenshot Requirements

1. Adjacent tiles before founding (no chain color)
2. Chain selector modal with available options
3. Selected chain highlighted
4. Board with newly founded chain (correct color)
5. Player holdings showing founder's bonus stock

### Test Data Requirements

Some tests require specific game states:
- Scenario 3.4: Some chains already on board
- Scenario 3.7: All 7 chains on board

This may require a test seeding API endpoint or careful tile placement sequences.

## Verification

```bash
# Run chain founding tests
cd frontend && npx playwright test tests/e2e/scenarios/chain-founding.spec.ts

# View screenshots
ls -la test-results/scenarios/chain-founding/

# View HTML report
npx playwright show-report
```

## Reference

- [Chain Founding Scenarios](../../../tests/scenario-docs.md#3-chain-founding)
- [Chain Selector Component](../../../ui/components.md#chain-selector)
- [Game Rules - Chain Founding](../../../rules/gameplay.md#founding-a-chain)
