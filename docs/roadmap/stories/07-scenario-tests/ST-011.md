# ST-011: Fix Remaining Flaky E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `in_progress`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: ST-002

## Context

After replacing arbitrary `waitForTimeout` calls with condition-based waiting (commit e3d46a2), we fixed 15 of 22 flaky tests. 7 tests still fail and need investigation.

## Previous Work (2026-01-24)

### Root Cause Fixed
Tests used `waitForTimeout(300)` in polling loops, creating race conditions where phase changes could be missed during the arbitrary delay.

### Solution Applied
- Added `waitForPhaseChange()` helper that uses Playwright's condition-based waiting
- Replaced all `waitForTimeout` calls with condition-based alternatives
- Result: 22 failed â†’ 7 failed (fixed 15 tests)

## Remaining Failures

| Test | File:Line | Error | Likely Cause |
|------|-----------|-------|--------------|
| 1.1: Basic complete turns | turn-flow.spec.ts:47 | Timeout at 120s | waitForPhaseChange 5000ms too slow in loop |
| 1.4: Extended gameplay 20 turns | turn-flow.spec.ts:466 | Timeout | Same as above |
| 2.2: Cancel trade offer | trading.spec.ts:140 | Failed to get turn | playUntilMerger issue |
| 2.14: Odd number defunct stock | trading.spec.ts:661 | Failed to get turn | playUntilMerger issue |
| 2.18: Multi-chain merger | trading.spec.ts:848 | Failed to get turn | playUntilMerger issue |
| 3.6: Founder bonus depleted | chain-founding.spec.ts:1150 | Unknown | Stock depletion edge case |
| 3.10: Chain founding disconnect | chain-founding.spec.ts:682 | Unknown | WebSocket reconnection |

## Investigation Plan

### Issue 1: Timeout in Turn Flow Tests (1.1, 1.4)

**Hypothesis**: The 5000ms timeout in `waitForPhaseChange` is too long when waiting for bot turns. In a loop of 10-20 turns, worst case is 10-20 * 5s = 50-100s before timeout.

**Investigation steps**:
1. Add logging to see actual time spent in `waitForPhaseChange`
2. Check if bot turns are completing slowly
3. Try reducing timeout to 2000ms

**Potential fix**:
```typescript
// Current - might be too slow
await waitForPhaseChange(page, info.phase, 5000)

// Try shorter timeout with expectation that phase WILL change
await waitForPhaseChange(page, info.phase, 2000)
```

### Issue 2: "Failed to get turn" in Trading Tests (2.2, 2.14, 2.18)

**Where it fails**: `playUntilMerger` in `helpers/merger.ts:66`:
```typescript
try {
  await waitForMyTurn(page, 60000)
} catch {
  // Check if we're in merger phase
  const phaseText = await page.getByTestId('game-phase').textContent()
  if (phaseText?.includes('MERGER') || phaseText?.includes('DISPOSE')) {
    return turn
  }
  throw new Error(`Failed to get turn at turn ${turn}`)  // <-- HERE
}
```

**Hypothesis**: `waitForMyTurn` expects phase to contain "PLACE" but during merger, phase is different. The catch block should detect merger but may be missing edge cases.

**Investigation steps**:
1. Add logging to see what phase text is when error occurs
2. Check if phase text format changed (e.g., "DISPOSE STOCKS" vs "DISPOSE")
3. May need more robust phase detection

### Issue 3: Chain Founding Edge Cases (3.6, 3.10)

**3.6 - Stock depletion**: Needs a game state where founder bonus stock is depleted. May need specific tile sequence or many turns to deplete stock.

**3.10 - Disconnect during founding**: Tests WebSocket reconnection during chain founding. The `forceCloseWebSocket` helper may not reliably trigger disconnect, or reconnection logic has issues.

## Acceptance Criteria

- [ ] All 7 remaining tests pass consistently
- [ ] Tests run in <3 minutes total
- [ ] No arbitrary timeouts remain in test code

## Files to Modify

| File | Expected Changes |
|------|-----------------|
| `helpers/turn-actions.ts` | Adjust `waitForPhaseChange` timeout or add variants |
| `helpers/merger.ts` | Improve phase detection in `playUntilMerger` |
| `turn-flow.spec.ts` | Adjust timeouts if needed |
| `trading.spec.ts` | May need merger detection fixes |
| `chain-founding.spec.ts` | Disconnect test may need WebSocket fix |

## Verification

```bash
# Run just the failing tests
cd frontend
npx playwright test --project=scenarios --grep "1.1|1.4|2.2|2.14|2.18|3.6|3.10"

# Run all scenario tests
npx playwright test --project=scenarios

# Run 5x to check for flakiness
for i in {1..5}; do npx playwright test --project=scenarios 2>&1 | grep -E "passed|failed"; done
```

## Reference

- Previous fix commit: e3d46a2 (simplify-codebase branch)
- Helpers: `frontend/tests/e2e/scenarios/helpers/`
- Test files: `frontend/tests/e2e/scenarios/`
