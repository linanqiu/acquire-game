# ST-007: Stock Purchase E2E Tests

## Metadata
- **Epic**: Scenario Test Automation
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: ST-001

## Context

Implement scenarios 6.1-6.17 (Stock Purchases) as E2E tests. Stock purchase occurs after tile placement each turn, allowing players to buy up to 3 shares from available chains.

## Requirements

Implement the following scenarios from the test matrix:

### Purchase Limits (6.1-6.6)

| ID | Scenario | Description |
|----|----------|-------------|
| 6.1 | Buy 1 stock | Single share purchase |
| 6.2 | Buy 2 stocks | Two shares (same or different chains) |
| 6.3 | Buy 3 stocks | Maximum per-turn purchase |
| 6.4 | Buy 0 stocks | Skip purchase phase |
| 6.5 | Cannot buy 4+ | UI prevents exceeding limit |
| 6.6 | Mixed chain purchase | Buy from multiple chains |

### Constraints (6.7-6.12)

| ID | Scenario | Description |
|----|----------|-------------|
| 6.7 | Chain not on board | Cannot buy non-existent chain |
| 6.8 | Insufficient funds | Cannot buy what you can't afford |
| 6.9 | Partial insufficient | Can only afford some selections |
| 6.10 | Stock pool exhausted | Chain has no shares left |
| 6.11 | Pool partially exhausted | Chain has fewer shares than requested |
| 6.12 | Price tier display | Show current prices per chain |

### Edge Cases (6.13-6.17)

| ID | Scenario | Description |
|----|----------|-------------|
| 6.13 | Purchase after merger | Buy survivor stock post-merger |
| 6.14 | Purchase after founding | Buy newly founded chain |
| 6.15 | No chains available | No chains on board to buy |
| 6.16 | All pools exhausted | No stock available anywhere |
| 6.17 | Purchase timeout | Auto-skip if no response |

## Acceptance Criteria

- [ ] All 17 stock purchase scenarios have passing tests
- [ ] Stock stepper enforces 0-3 range per chain
- [ ] Total purchase limited to 3 shares per turn
- [ ] Insufficient funds shows error/disables purchase
- [ ] Pool exhaustion reflected in UI
- [ ] Screenshots capture purchase flow

## Implementation Notes

### Key Test File

**frontend/tests/e2e/scenarios/stock-purchases.spec.ts**:
```typescript
import { test, expect } from '@playwright/test'
import { captureStep, resetStepCounter } from './helpers/screenshot'
import { createGame, startGame } from './helpers/game-setup'
import { assertPlayerMoney } from './helpers/assertions'

const CATEGORY = 'stock-purchases'

test.describe('Stock Purchase Scenarios (6.x)', () => {
  test.beforeEach(() => {
    resetStepCounter()
  })

  test.describe('Purchase Limits', () => {
    test('6.1: Buy 1 stock', async ({ page, request }) => {
      const testName = 'scenario-6.1-buy-one'

      const game = await createGame(request, {
        hostName: 'Buyer',
        playerNames: ['Player2', 'Player3']
      })
      await startGame(request, game.roomCode, game.hostSessionToken)

      await page.goto(`/play/${game.roomCode}`)

      // Place tile first (required before stock purchase)
      // ...

      // Get initial cash
      const initialCash = await page.locator('[data-testid="player-money"]').textContent()
      await captureStep(page, 'before-purchase', { category: CATEGORY, testName })

      // Buy 1 Tower stock
      await page.locator('[data-testid="stock-stepper-tower"] [data-testid="increment"]').click()
      await captureStep(page, 'stock-selected', { category: CATEGORY, testName })

      // Confirm purchase
      await page.locator('[data-testid="confirm-purchase"]').click()
      await captureStep(page, 'purchase-confirmed', { category: CATEGORY, testName })

      // Verify cash decreased and holdings increased
      const finalCash = await page.locator('[data-testid="player-money"]').textContent()
      expect(parseInt(finalCash!.replace(/[$,]/g, ''))).toBeLessThan(
        parseInt(initialCash!.replace(/[$,]/g, ''))
      )
    })

    test('6.3: Buy 3 stocks maximum', async ({ page, request }) => {
      const testName = 'scenario-6.3-buy-three'

      // Setup
      // ...

      // Try to add 4th stock - should be prevented
      await page.locator('[data-testid="stock-stepper-tower"] [data-testid="increment"]').click()
      await page.locator('[data-testid="stock-stepper-tower"] [data-testid="increment"]').click()
      await page.locator('[data-testid="stock-stepper-american"] [data-testid="increment"]').click()

      // Fourth increment should be disabled
      const fourthIncrement = page.locator('[data-testid="stock-stepper-festival"] [data-testid="increment"]')
      await expect(fourthIncrement).toBeDisabled()
      await captureStep(page, 'fourth-blocked', { category: CATEGORY, testName })
    })

    test('6.6: Mixed chain purchase', async ({ page, request }) => {
      const testName = 'scenario-6.6-mixed-chains'

      // Buy from Tower, American, and Festival
      await page.locator('[data-testid="stock-stepper-tower"] [data-testid="increment"]').click()
      await page.locator('[data-testid="stock-stepper-american"] [data-testid="increment"]').click()
      await page.locator('[data-testid="stock-stepper-festival"] [data-testid="increment"]').click()
      await captureStep(page, 'mixed-selection', { category: CATEGORY, testName })

      // Verify total cost display
      const totalCost = page.locator('[data-testid="purchase-total"]')
      await expect(totalCost).toBeVisible()
    })
  })

  test.describe('Constraints', () => {
    test('6.8: Insufficient funds', async ({ page, request }) => {
      const testName = 'scenario-6.8-insufficient-funds'

      // Setup player with low cash
      // Attempt to buy expensive stock

      const buyButton = page.locator('[data-testid="confirm-purchase"]')
      await expect(buyButton).toBeDisabled()

      const errorMessage = page.locator('[data-testid="purchase-error"]')
      await expect(errorMessage).toContainText('Insufficient funds')
      await captureStep(page, 'insufficient-funds-error', { category: CATEGORY, testName })
    })

    test('6.10: Stock pool exhausted', async ({ page, request }) => {
      const testName = 'scenario-6.10-pool-exhausted'

      // Setup chain with 0 remaining stock

      // Stepper should show 0 available
      const availableStock = page.locator('[data-testid="stock-available-tower"]')
      await expect(availableStock).toContainText('0')

      // Increment should be disabled
      const incrementButton = page.locator('[data-testid="stock-stepper-tower"] [data-testid="increment"]')
      await expect(incrementButton).toBeDisabled()
      await captureStep(page, 'pool-exhausted', { category: CATEGORY, testName })
    })

    test('6.12: Price tier display', async ({ page, request }) => {
      const testName = 'scenario-6.12-price-display'

      // Verify each active chain shows current price
      const towerPrice = page.locator('[data-testid="stock-price-tower"]')
      await expect(towerPrice).toBeVisible()
      await expect(towerPrice).toContainText('$')
      await captureStep(page, 'prices-displayed', { category: CATEGORY, testName })
    })
  })
})
```

### Screenshot Requirements

1. Stock purchase UI with available chains
2. Stock stepper interactions
3. Total cost calculation
4. Confirmation state
5. Updated holdings after purchase
6. Error states (insufficient funds, pool exhausted)

### Price Verification

Tests should verify prices match chain size:
- Size 2: Base price
- Size 3-4: +$100
- Size 5: +$200
- etc.

## Verification

```bash
# Run stock purchase tests
cd frontend && npx playwright test tests/e2e/scenarios/stock-purchases.spec.ts

# View screenshots
ls -la test-results/scenarios/stock-purchases/

# View HTML report
npx playwright show-report
```

## Reference

- [Stock Purchase Scenarios](../../../tests/scenario-docs.md#6-stock-purchases)
- [Stock Stepper Component](../../../ui/components.md#stock-stepper)
- [Stock Price Chart](../../../rules/stock-prices.md)
