# AI-004: Training Data Generator

## Metadata
- **Epic**: AI Training
- **Status**: `not-started`
- **Priority**: `high`
- **Effort**: `M` (1-2 hours)
- **Dependencies**: AI-001, AI-003

## Context

Generate training data by running games between bots and recording (state, action) pairs. This data will be used for imitation learning.

## Requirements

1. Run games between bots
2. Record state at each decision point
3. Record action taken
4. Save as structured dataset
5. Support multiple bot types as teachers

## Acceptance Criteria

- [ ] Generate games with configurable bots
- [ ] Record (state, action, outcome) tuples
- [ ] Save to HDF5 or numpy format
- [ ] Generate 100k+ games in reasonable time
- [ ] Track game outcomes for win/loss labels
- [ ] Resume capability for long runs
- [ ] Progress logging
- [ ] Unit tests for data format

## Implementation Notes

### File to Create

**backend/training/data_generator.py**:
```python
import numpy as np
import h5py
from pathlib import Path
from typing import List, Tuple, Optional
from tqdm import tqdm

from game.game import Game
from game.bot import Bot
from game.mcts_bot import MCTSBot
from game.action import Action
from game.rules import Rules
from .state_encoder import StateEncoder


class DataGenerator:
    """Generate training data from bot games."""

    def __init__(
        self,
        teacher: str = 'hard',  # 'easy', 'medium', 'hard', 'mcts'
        opponents: List[str] = ['hard', 'hard'],
        encoder: Optional[StateEncoder] = None,
    ):
        self.teacher = self._create_bot(teacher)
        self.opponents = [self._create_bot(o) for o in opponents]
        self.encoder = encoder or StateEncoder()

    def _create_bot(self, bot_type: str):
        if bot_type == 'mcts':
            return MCTSBot(simulations=500)
        return Bot(bot_type)

    def generate(
        self,
        num_games: int,
        output_path: str,
        seed: Optional[int] = None,
    ) -> dict:
        """Generate training data from games."""
        states = []
        actions = []
        outcomes = []

        rng = np.random.RandomState(seed)

        for game_idx in tqdm(range(num_games), desc="Generating games"):
            game_seed = rng.randint(0, 2**31)
            game_data = self._play_game(game_seed)

            states.extend(game_data['states'])
            actions.extend(game_data['actions'])
            outcomes.extend(game_data['outcomes'])

        # Convert to arrays
        states_array = np.array(states, dtype=np.float32)
        actions_array = np.array(actions, dtype=np.int32)
        outcomes_array = np.array(outcomes, dtype=np.float32)

        # Save to HDF5
        self._save_hdf5(output_path, states_array, actions_array, outcomes_array)

        return {
            'num_games': num_games,
            'num_samples': len(states),
            'states_shape': states_array.shape,
            'actions_shape': actions_array.shape,
        }

    def _play_game(self, seed: int) -> dict:
        """Play one game and collect data."""
        game = Game(seed=seed)

        # Add players: teacher + opponents
        game.add_player('teacher', 'Teacher')
        for i, _ in enumerate(self.opponents):
            game.add_player(f'opp{i}', f'Opponent{i}')

        game.start_game()

        states = []
        actions = []

        # Play game
        while not game.is_game_over():
            current_id = game.get_current_player_id()
            legal_actions = Rules.get_all_legal_actions(game, current_id)

            if not legal_actions:
                break

            # Get action from appropriate bot
            if current_id == 'teacher':
                action = self.teacher.choose_action(game, current_id)
                # Record state and action
                state = self.encoder.encode(game, current_id)
                action_idx = self._action_to_index(action, legal_actions)

                states.append(state)
                actions.append(action_idx)
            else:
                opp_idx = int(current_id.replace('opp', ''))
                action = self.opponents[opp_idx].choose_action(game, current_id)

            game.apply_action(action)

        # Get outcome for teacher
        outcome = self._get_outcome(game, 'teacher')
        outcomes = [outcome] * len(states)

        return {
            'states': states,
            'actions': actions,
            'outcomes': outcomes,
        }

    def _action_to_index(self, action: Action, legal_actions: List[Action]) -> int:
        """Convert action to index in legal actions list."""
        for i, legal in enumerate(legal_actions):
            if action == legal:
                return i
        return 0

    def _get_outcome(self, game: Game, player_id: str) -> float:
        """Get outcome (0-1) for player."""
        rankings = game.get_final_rankings()
        for i, r in enumerate(rankings):
            if r['player_id'] == player_id:
                if i == 0:
                    return 1.0
                elif i == 1:
                    return 0.5
                else:
                    return 0.0
        return 0.0

    def _save_hdf5(
        self,
        path: str,
        states: np.ndarray,
        actions: np.ndarray,
        outcomes: np.ndarray,
    ):
        """Save data to HDF5 file."""
        Path(path).parent.mkdir(parents=True, exist_ok=True)

        with h5py.File(path, 'w') as f:
            f.create_dataset('states', data=states, compression='gzip')
            f.create_dataset('actions', data=actions, compression='gzip')
            f.create_dataset('outcomes', data=outcomes, compression='gzip')


# CLI interface
if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument('--games', type=int, default=1000)
    parser.add_argument('--output', type=str, default='data/training.h5')
    parser.add_argument('--teacher', type=str, default='hard')
    args = parser.parse_args()

    generator = DataGenerator(teacher=args.teacher)
    stats = generator.generate(args.games, args.output)
    print(f"Generated {stats['num_samples']} samples from {args.games} games")
```

## Verification

```bash
cd backend
python -m training.data_generator --games 100 --output data/test.h5

# Verify data
python -c "
import h5py
with h5py.File('data/test.h5', 'r') as f:
    print('States shape:', f['states'].shape)
    print('Actions shape:', f['actions'].shape)
"
```

## Reference

- [AI Roadmap - Imitation Learning](../../../ai/ROADMAP.md#21-imitation-learning-clone-the-teacher)
