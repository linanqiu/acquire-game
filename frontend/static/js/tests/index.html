<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acquire Frontend Tests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #ffd700;
        }
        h2 {
            color: #4ecdc4;
            margin-top: 30px;
        }
        .test-pass {
            color: #2ecc71;
        }
        .test-fail {
            color: #e74c3c;
        }
        .test-error {
            background: #2d2d44;
            padding: 10px;
            margin-left: 20px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .summary {
            margin-top: 30px;
            padding: 15px;
            border-radius: 8px;
        }
        .summary.all-pass {
            background: #1e3d2f;
            border: 1px solid #2ecc71;
        }
        .summary.has-fail {
            background: #3d1e1e;
            border: 1px solid #e74c3c;
        }
    </style>
</head>
<body>
    <h1>Acquire Frontend Tests</h1>
    <div id="results"></div>
    <div id="summary"></div>

    <script type="module">
        import {
            formatMoney, capitalize, escapeHtml, parseTile, formatTile, formatOrdinal, pluralize
        } from '../shared/formatters.js';

        import { createStore, createHostState, createPlayerState } from '../shared/state.js';
        import { BOARD, CHAIN_NAMES, CONFIG, CHAIN_COLORS } from '../shared/constants.js';

        // Test framework
        const results = [];
        let currentSuite = '';

        function suite(name) {
            currentSuite = name;
        }

        function test(name, fn) {
            try {
                fn();
                results.push({ suite: currentSuite, name, pass: true });
            } catch (error) {
                results.push({ suite: currentSuite, name, pass: false, error: error.message });
            }
        }

        function assertEqual(actual, expected, message = '') {
            if (actual !== expected) {
                throw new Error(`${message} Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
            }
        }

        function assertDeepEqual(actual, expected, message = '') {
            if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                throw new Error(`${message} Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
            }
        }

        function assertNull(actual, message = '') {
            if (actual !== null) {
                throw new Error(`${message} Expected null, got ${JSON.stringify(actual)}`);
            }
        }

        function assertTrue(actual, message = '') {
            if (!actual) {
                throw new Error(`${message} Expected truthy, got ${actual}`);
            }
        }

        // ============================================================
        // FORMATTER TESTS
        // ============================================================
        suite('formatters.js');

        test('formatMoney formats positive numbers', () => {
            assertEqual(formatMoney(1000), '$1,000');
            assertEqual(formatMoney(6000), '$6,000');
        });

        test('formatMoney handles zero', () => {
            assertEqual(formatMoney(0), '$0');
        });

        test('formatMoney handles null/undefined', () => {
            assertEqual(formatMoney(null), '$0');
            assertEqual(formatMoney(undefined), '$0');
        });

        test('capitalize works', () => {
            assertEqual(capitalize('luxor'), 'Luxor');
            assertEqual(capitalize(''), '');
            assertEqual(capitalize(null), '');
        });

        test('parseTile parses valid tiles', () => {
            assertDeepEqual(parseTile('1A'), { col: 1, row: 'A' });
            assertDeepEqual(parseTile('12I'), { col: 12, row: 'I' });
        });

        test('parseTile returns null for invalid', () => {
            assertNull(parseTile(''));
            assertNull(parseTile('A1'));
            assertNull(parseTile('1J'));
        });

        test('formatTile creates tile strings', () => {
            assertEqual(formatTile(1, 'A'), '1A');
            assertEqual(formatTile(12, 'I'), '12I');
        });

        test('formatOrdinal adds suffixes', () => {
            assertEqual(formatOrdinal(1), '1st');
            assertEqual(formatOrdinal(2), '2nd');
            assertEqual(formatOrdinal(3), '3rd');
            assertEqual(formatOrdinal(11), '11th');
            assertEqual(formatOrdinal(21), '21st');
        });

        test('pluralize works', () => {
            assertEqual(pluralize(1, 'stock'), 'stock');
            assertEqual(pluralize(2, 'stock'), 'stocks');
        });

        test('escapeHtml escapes HTML', () => {
            assertTrue(escapeHtml('<script>').includes('&lt;'));
        });

        // ============================================================
        // STATE TESTS
        // ============================================================
        suite('state.js');

        test('createStore initializes with state', () => {
            const store = createStore({ count: 0 });
            assertEqual(store.get('count'), 0);
        });

        test('createStore.setState updates state', () => {
            const store = createStore({ count: 0 });
            store.setState({ count: 5 });
            assertEqual(store.get('count'), 5);
        });

        test('createStore.setState accepts function', () => {
            const store = createStore({ count: 5 });
            store.setState(s => ({ count: s.count + 1 }));
            assertEqual(store.get('count'), 6);
        });

        test('createStore.subscribe notifies on changes', () => {
            const store = createStore({ count: 0 });
            let called = false;
            store.subscribe(() => { called = true; });
            store.setState({ count: 1 });
            assertTrue(called);
        });

        test('createStore.subscribe returns unsubscribe', () => {
            const store = createStore({ count: 0 });
            let callCount = 0;
            const unsub = store.subscribe(() => { callCount++; });
            store.setState({ count: 1 });
            unsub();
            store.setState({ count: 2 });
            assertEqual(callCount, 1);
        });

        test('createStore.reset returns to initial', () => {
            const store = createStore({ count: 0 });
            store.setState({ count: 100 });
            store.reset();
            assertEqual(store.get('count'), 0);
        });

        test('createHostState has correct defaults', () => {
            const store = createHostState();
            assertEqual(store.get('board'), null);
            assertEqual(store.get('connectionStatus'), 'disconnected');
        });

        test('createPlayerState has correct defaults', () => {
            const store = createPlayerState();
            assertEqual(store.get('money'), 6000);
            assertEqual(store.get('isMyTurn'), false);
        });

        // ============================================================
        // CONSTANTS TESTS
        // ============================================================
        suite('constants.js');

        test('BOARD has correct dimensions', () => {
            assertEqual(BOARD.columns, 12);
            assertEqual(BOARD.rows.length, 9);
        });

        test('CHAIN_NAMES has 7 chains', () => {
            assertEqual(CHAIN_NAMES.length, 7);
        });

        test('CHAIN_COLORS has all chains', () => {
            for (const name of CHAIN_NAMES) {
                assertTrue(CHAIN_COLORS[name], `Missing color for ${name}`);
            }
        });

        test('CONFIG has expected values', () => {
            assertEqual(CONFIG.safeChainSize, 11);
            assertEqual(CONFIG.maxStocksPerTurn, 3);
            assertEqual(CONFIG.startingMoney, 6000);
        });

        // ============================================================
        // RENDER RESULTS
        // ============================================================
        const resultsDiv = document.getElementById('results');
        const summaryDiv = document.getElementById('summary');

        let currentSuiteEl = null;
        let lastSuite = '';

        for (const result of results) {
            if (result.suite !== lastSuite) {
                const h2 = document.createElement('h2');
                h2.textContent = result.suite;
                resultsDiv.appendChild(h2);
                lastSuite = result.suite;
            }

            const p = document.createElement('p');
            p.className = result.pass ? 'test-pass' : 'test-fail';
            p.textContent = `${result.pass ? '✓' : '✗'} ${result.name}`;
            resultsDiv.appendChild(p);

            if (!result.pass) {
                const err = document.createElement('div');
                err.className = 'test-error';
                err.textContent = result.error;
                resultsDiv.appendChild(err);
            }
        }

        const passed = results.filter(r => r.pass).length;
        const failed = results.filter(r => !r.pass).length;

        summaryDiv.className = 'summary ' + (failed === 0 ? 'all-pass' : 'has-fail');
        summaryDiv.innerHTML = `<strong>${passed} passed, ${failed} failed</strong>`;
    </script>
</body>
</html>
